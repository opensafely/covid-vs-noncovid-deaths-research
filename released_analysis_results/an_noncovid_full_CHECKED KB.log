----------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  e:\analyses\covid-vs-noncovid-deaths-research\analysis\output/an_noncovid_full.log
  log type:  text
 opened on:  10 Sep 2020, 01:11:15

. 
.         cap prog drop baselogistic 

.         prog define baselogistic
  1.         syntax , age(string) bp(string) [ethnicity(real 0) if(string)] 
  2. 
.         if `ethnicity'==1 local ethnicity "i.ethnicity"
  3.         else local ethnicity
  4.         
.                 cap logistic _d `age'                   ///
>                         i.male                                                  ///
>                         i.obese4cat                                             ///
>                         i.smoke_nomiss                                  ///
>                         `ethnicity'                                             ///
>                         i.imd                                                   ///
>                         `bp'                                                    ///
>                         i.chronic_respiratory_disease   ///
>                         i.asthmacat                                             ///
>                         i.chronic_cardiac_disease               ///
>                         i.diabcat                                               ///
>                         i.cancer_exhaem_cat                             ///
>                         i.cancer_haem_cat                               ///
>                         i.chronic_liver_disease                 ///
>                         i.stroke_dementia                               ///
>                         i.other_neuro                                   ///
>                         i.reduced_kidney_function_cat   ///
>                         i.organ_transplant                              ///
>                         i.spleen                                                ///
>                         i.ra_sle_psoriasis                      ///
>                         i.other_immunosuppression
  5.                                         
.         end                     

. 
. foreach year of numlist 2019 2020{
  2.         if `year'==2019 use cr_create_analysis_dataset_2019, clear
  3.         else if `year'==2020 use cr_create_analysis_dataset, clear
  4.         
.         stset stime_primarycaredeath, fail(primarycaredeath) id(patient_id) enter(enter_date) origin(enter_date)
  5.         
.         baselogistic, age("age1 age2 age3")  bp("i.htdiag_or_highbp") ethnicity(0)
  6.         if _rc==0{
  7.         estimates
  8.         estimates save ./output/models/an_noncovid_full_`year'_agespline_bmicat_noeth, replace
  9.         }
 10.         else di "WARNING AGE SPLINE MODEL DID NOT FIT (OUTCOME `outcome')"
 11.          
.         *Age group model (not adj ethnicity)
.         baselogistic, age("ib3.agegroup") bp("i.htdiag_or_highbp") ethnicity(0)
 12.         if _rc==0{
 13.         estimates
 14.         estimates save ./output/models/an_noncovid_full_`year'_agegroup_bmicat_noeth, replace
 15.         }
 16.         else di "WARNING GROUP MODEL DID NOT FIT (OUTCOME `outcome')"
 17. 
.         *Complete case ethnicity model
.         baselogistic, age("age1 age2 age3") bp("i.htdiag_or_highbp") ethnicity(1)
 18.         if _rc==0{
 19.         estimates
 20.         estimates save ./output/models/an_noncovid_full_`year'_agespline_bmicat_CCeth, replace
 21.          }
 22.          else di "WARNING CC ETHNICITY MODEL WITH AGESPLINE DID NOT FIT (OUTCOME `outcome')"
 23.          
. 
.          
. }
(covid vs non covid 2019)

                id:  patient_id
     failure event:  primarycaredeath != 0 & primarycaredeath < .
obs. time interval:  (stime_primarycaredeath[_n-1], stime_primarycaredeath]
 enter on or after:  time enter_date
 exit on or before:  failure
    t for analysis:  (time-origin)
            origin:  time enter_date

------------------------------------------------------------------------------
   17357709  total observations
     20,197  observations end on or before enter()
------------------------------------------------------------------------------
   17337512  observations remaining, representing
   17337512  subjects
     68,616  failures in single-failure-per-subject data
 3.0453e+09  total analysis time at risk and under observation
                                                at risk from t =         0
                                     earliest observed entry t =         0
                                          last observed exit t =       176

----------------------------------------------------------------------------------------------------------------------------------
active results
----------------------------------------------------------------------------------------------------------------------------------

Logistic regression                             Number of obs     = 17,337,512
                                                LR chi2(36)       =  247538.41
                                                Prob > chi2       =     0.0000
Log likelihood = -324301.55                     Pseudo R2         =     0.2762

-----------------------------------------------------------------------------------------------
                           _d | Odds Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
------------------------------+----------------------------------------------------------------
                         age1 |    1.09834   .0048203    21.37   0.000     1.088933    1.107828
                         age2 |   .9050929   .0094876    -9.51   0.000     .8866871    .9238806
                         age3 |   1.368105    .033864    12.66   0.000     1.303318    1.436114
                       1.male |   1.104749    .009135    12.05   0.000     1.086989    1.122799
                              |
                    obese4cat |
           Obese I (30-34.9)  |   .7918722   .0097673   -18.92   0.000     .7729582    .8112489
          Obese II (35-39.9)  |   .9291056   .0180393    -3.79   0.000     .8944135    .9651433
             Obese III (40+)  |   1.297271   .0344671     9.80   0.000     1.231445    1.366615
                              |
                 smoke_nomiss |
                      Former  |   1.144911   .0105597    14.67   0.000       1.1244    1.165796
                     Current  |   1.960035   .0266317    49.53   0.000     1.908527    2.012934
                              |
                          imd |
                           2  |   1.100943   .0138929     7.62   0.000     1.074047    1.128512
                           3  |   1.162547   .0146273    11.97   0.000     1.134229    1.191573
                           4  |   1.264474   .0161325    18.39   0.000     1.233247    1.296492
             5 most deprived  |   1.421106   .0184835    27.02   0.000     1.385336    1.457798
                              |
           1.htdiag_or_highbp |   .9250842   .0086582    -8.32   0.000     .9082692    .9422106
1.chronic_respiratory_disease |   1.942356   .0195962    65.81   0.000     1.904326    1.981147
                              |
                    asthmacat |
                 Yes, no OCS  |   .9749663   .0125151    -1.98   0.048     .9507432    .9998066
                Yes with OCS  |   .7498028   .0211191   -10.22   0.000     .7095318    .7923594
                              |
    1.chronic_cardiac_disease |   1.549865   .0138948    48.87   0.000      1.52287    1.577339
                              |
                      diabcat |
         Controlled diabetes  |   .6338687    .008405   -34.38   0.000     .6176075    .6505581
       Uncontrolled diabetes  |   .9321689    .016652    -3.93   0.000     .9000963    .9653843
  Diabetes, no hba1c measure  |   5.401119   .0715276   127.36   0.000     5.262732    5.543146
                              |
            cancer_exhaem_cat |
                   Last year  |   6.466565   .1111604   108.59   0.000     6.252324    6.688147
               2-5 years ago  |   6.007766   .0717687   150.10   0.000     5.868736     6.15009
                    5+ years  |   1.753801   .0210024    46.91   0.000     1.713116    1.795451
                              |
              cancer_haem_cat |
                   Last year  |   3.334629   .1896154    21.18   0.000      2.98295    3.727768
               2-5 years ago  |    3.05879   .1058257    32.32   0.000     2.858252    3.273399
                    5+ years  |   1.846297   .0556899    20.33   0.000      1.74031    1.958738
                              |
      1.chronic_liver_disease |   3.511785   .0846238    52.13   0.000     3.349781    3.681624
            1.stroke_dementia |   1.760122   .0188796    52.71   0.000     1.723505    1.797517
                1.other_neuro |   2.381676   .0443524    46.60   0.000     2.296314    2.470211
                              |
  reduced_kidney_function_cat |
Stage 3a/3b egfr 30-60        |   1.116214   .0108923    11.27   0.000     1.095069    1.137768
           Stage 4/5 egfr<30  |   2.619318   .0420908    59.92   0.000     2.538107    2.703128
                              |
           1.organ_transplant |    1.82316   .1189232     9.21   0.000     1.604359      2.0718
                     1.spleen |   1.508354   .0877286     7.07   0.000     1.345848    1.690483
           1.ra_sle_psoriasis |   1.103447   .0159311     6.82   0.000      1.07266    1.135117
    1.other_immunosuppression |   1.446665    .095767     5.58   0.000     1.270632    1.647086
                        _cons |   7.29e-06   1.11e-06   -77.76   0.000     5.41e-06    9.82e-06
-----------------------------------------------------------------------------------------------
Note: _cons estimates baseline odds.
(note: file ./output/models/an_noncovid_full_2019_agespline_bmicat_noeth.ster not found)
file ./output/models/an_noncovid_full_2019_agespline_bmicat_noeth.ster saved

----------------------------------------------------------------------------------------------------------------------------------
active results
----------------------------------------------------------------------------------------------------------------------------------

Logistic regression                             Number of obs     = 17,337,512
                                                LR chi2(38)       =  234544.20
                                                Prob > chi2       =     0.0000
Log likelihood = -330798.65                     Pseudo R2         =     0.2617

-----------------------------------------------------------------------------------------------
                           _d | Odds Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
------------------------------+----------------------------------------------------------------
                     agegroup |
                      18-<40  |   .1780614    .006145   -50.00   0.000     .1664157    .1905221
                      40-<50  |   .4927353   .0147762   -23.60   0.000      .464609    .5225642
                      60-<70  |   2.012152   .0404728    34.76   0.000     1.934371    2.093062
                      70-<80  |   3.970716   .0749238    73.08   0.000      3.82655    4.120313
                         80+  |   12.95878   .2429891   136.62   0.000     12.49118    13.44389
                              |
                       1.male |   1.024396   .0083755     2.95   0.003     1.008111    1.040944
                              |
                    obese4cat |
           Obese I (30-34.9)  |   .7161073   .0087743   -27.25   0.000     .6991148    .7335129
          Obese II (35-39.9)  |   .8110763   .0156784   -10.83   0.000      .780922     .842395
             Obese III (40+)  |   1.096568   .0290822     3.48   0.001     1.041024    1.155076
                              |
                 smoke_nomiss |
                      Former  |   1.139882   .0104714    14.25   0.000     1.119542    1.160592
                     Current  |   1.763729   .0237157    42.20   0.000     1.717854    1.810829
                              |
                          imd |
                           2  |   1.101973   .0138463     7.73   0.000     1.075166    1.129448
                           3  |   1.165677   .0146048    12.24   0.000     1.137401    1.194656
                           4  |   1.263463   .0160596    18.40   0.000     1.232376    1.295335
             5 most deprived  |   1.406011   .0182344    26.27   0.000     1.370723    1.442208
                              |
           1.htdiag_or_highbp |    .967062   .0090305    -3.59   0.000     .9495235    .9849245
1.chronic_respiratory_disease |   1.909694   .0192395    64.22   0.000     1.872355    1.947778
                              |
                    asthmacat |
                 Yes, no OCS  |    .947819   .0121196    -4.19   0.000     .9243601    .9718732
                Yes with OCS  |   .7223308   .0202899   -11.58   0.000     .6836382    .7632134
                              |
    1.chronic_cardiac_disease |   1.640141   .0147015    55.20   0.000     1.611578     1.66921
                              |
                      diabcat |
         Controlled diabetes  |   .6082947   .0080615   -37.51   0.000      .592698    .6243019
       Uncontrolled diabetes  |    .857051   .0153004    -8.64   0.000     .8275814      .88757
  Diabetes, no hba1c measure  |   5.524747   .0726425   129.99   0.000     5.384189    5.668974
                              |
            cancer_exhaem_cat |
                   Last year  |   6.328425   .1083737   107.74   0.000     6.119542    6.544439
               2-5 years ago  |   5.820048   .0691715   148.20   0.000     5.686042    5.957214
                    5+ years  |   1.791158   .0213816    48.83   0.000     1.749737    1.833559
                              |
              cancer_haem_cat |
                   Last year  |   3.206389   .1816246    20.57   0.000     2.869461     3.58288
               2-5 years ago  |   2.877774   .0994941    30.57   0.000      2.68923    3.079538
                    5+ years  |   1.804834   .0542551    19.64   0.000     1.701568    1.914367
                              |
      1.chronic_liver_disease |   3.274886   .0788421    49.27   0.000     3.123947    3.433117
            1.stroke_dementia |   1.909015   .0203852    60.55   0.000     1.869476     1.94939
                1.other_neuro |   2.292892   .0425469    44.72   0.000        2.211    2.377817
                              |
  reduced_kidney_function_cat |
Stage 3a/3b egfr 30-60        |   1.322026   .0126848    29.10   0.000     1.297397    1.347123
           Stage 4/5 egfr<30  |   3.382048   .0535759    76.92   0.000     3.278655    3.488702
                              |
           1.organ_transplant |   1.496275   .0975578     6.18   0.000     1.316778    1.700239
                     1.spleen |   1.447931   .0839975     6.38   0.000     1.292314    1.622288
           1.ra_sle_psoriasis |   1.071537   .0154234     4.80   0.000      1.04173    1.102197
    1.other_immunosuppression |   1.358853   .0899015     4.63   0.000     1.193596    1.546992
                        _cons |   .0007158   .0000142  -364.82   0.000     .0006885    .0007442
-----------------------------------------------------------------------------------------------
Note: _cons estimates baseline odds.
(note: file ./output/models/an_noncovid_full_2019_agegroup_bmicat_noeth.ster not found)
file ./output/models/an_noncovid_full_2019_agegroup_bmicat_noeth.ster saved

----------------------------------------------------------------------------------------------------------------------------------
active results
----------------------------------------------------------------------------------------------------------------------------------

Logistic regression                             Number of obs     = 12,702,120
                                                LR chi2(40)       =  175931.06
                                                Prob > chi2       =     0.0000
Log likelihood = -228321.82                     Pseudo R2         =     0.2781

-----------------------------------------------------------------------------------------------
                           _d | Odds Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
------------------------------+----------------------------------------------------------------
                         age1 |   1.104603   .0061172    17.96   0.000     1.092678    1.116658
                         age2 |   .8889996   .0115684    -9.04   0.000     .8666126    .9119648
                         age3 |   1.431648   .0437203    11.75   0.000     1.348472    1.519955
                       1.male |   1.122182   .0110843    11.67   0.000     1.100666    1.144119
                              |
                    obese4cat |
           Obese I (30-34.9)  |   .7933033   .0114758   -16.01   0.000     .7711271    .8161173
          Obese II (35-39.9)  |   .9215436   .0209836    -3.59   0.000     .8813206    .9636023
             Obese III (40+)  |   1.305889   .0404362     8.62   0.000     1.228993    1.387597
                              |
                 smoke_nomiss |
                      Former  |   1.140752   .0127834    11.75   0.000      1.11597    1.166084
                     Current  |   1.910354   .0311738    39.67   0.000     1.850222    1.972442
                              |
                    ethnicity |
                       Mixed  |    .779835    .061252    -3.17   0.002     .6685675    .9096204
      Asian or Asian British  |    .758321   .0220367    -9.52   0.000     .7163368    .8027658
                       Black  |    .648099   .0318467    -8.83   0.000     .5885921    .7136221
                       Other  |   .6158623   .0392573    -7.60   0.000     .5435317    .6978183
                              |
                          imd |
                           2  |   1.103709   .0170614     6.38   0.000     1.070771    1.137661
                           3  |   1.177221   .0180848    10.62   0.000     1.142303    1.213205
                           4  |   1.292269   .0199599    16.60   0.000     1.253734    1.331988
             5 most deprived  |   1.468932   .0229052    24.66   0.000     1.424718    1.514519
                              |
           1.htdiag_or_highbp |   .9321545   .0104964    -6.24   0.000     .9118072    .9529559
1.chronic_respiratory_disease |   1.964685   .0232554    57.05   0.000      1.91963    2.010797
                              |
                    asthmacat |
                 Yes, no OCS  |    .980947   .0147479    -1.28   0.201     .9524634    1.010282
                Yes with OCS  |   .7401089   .0242862    -9.17   0.000     .6940071    .7892731
                              |
    1.chronic_cardiac_disease |   1.551897   .0166271    41.02   0.000     1.519648     1.58483
                              |
                      diabcat |
         Controlled diabetes  |   .6445915    .010081   -28.08   0.000     .6251329    .6646559
       Uncontrolled diabetes  |   .9491189   .0199292    -2.49   0.013     .9108512    .9889943
  Diabetes, no hba1c measure  |    5.62472   .0881896   110.16   0.000     5.454501    5.800252
                              |
            cancer_exhaem_cat |
                   Last year  |   6.494049   .1325681    91.65   0.000      6.23935    6.759146
               2-5 years ago  |   6.092255   .0865336   127.22   0.000     5.924991    6.264241
                    5+ years  |   1.758498   .0252255    39.35   0.000     1.709745     1.80864
                              |
              cancer_haem_cat |
                   Last year  |   3.415478    .229488    18.28   0.000     2.994048    3.896227
               2-5 years ago  |   3.210456   .1305294    28.69   0.000     2.964551    3.476759
                    5+ years  |   1.809963   .0656539    16.36   0.000     1.685752    1.943327
                              |
      1.chronic_liver_disease |    3.50802   .0982996    44.79   0.000     3.320551    3.706072
            1.stroke_dementia |   1.774767   .0226301    44.99   0.000     1.730962     1.81968
                1.other_neuro |   2.324879    .051698    37.94   0.000     2.225729    2.428445
                              |
  reduced_kidney_function_cat |
Stage 3a/3b egfr 30-60        |   1.120272   .0131574     9.67   0.000     1.094778    1.146359
           Stage 4/5 egfr<30  |   2.621416   .0505799    49.95   0.000     2.524133     2.72245
                              |
           1.organ_transplant |   1.913096   .1462097     8.49   0.000      1.64696    2.222237
                     1.spleen |   1.493478   .1025149     5.84   0.000     1.305482    1.708546
           1.ra_sle_psoriasis |   1.120184   .0190019     6.69   0.000     1.083553    1.158053
    1.other_immunosuppression |   1.494375   .1143359     5.25   0.000     1.286274    1.736144
                        _cons |   5.99e-06   1.16e-06   -62.16   0.000     4.10e-06    8.75e-06
-----------------------------------------------------------------------------------------------
Note: _cons estimates baseline odds.
(note: file ./output/models/an_noncovid_full_2019_agespline_bmicat_CCeth.ster not found)
file ./output/models/an_noncovid_full_2019_agespline_bmicat_CCeth.ster saved
(covid vs noncovid ()2020))

                id:  patient_id
     failure event:  primarycaredeath != 0 & primarycaredeath < .
obs. time interval:  (stime_primarycaredeath[_n-1], stime_primarycaredeath]
 enter on or after:  time enter_date
 exit on or before:  failure
    t for analysis:  (time-origin)
            origin:  time enter_date

------------------------------------------------------------------------------
   17362187  total observations
     18,708  observations end on or before enter()
------------------------------------------------------------------------------
   17343479  observations remaining, representing
   17343479  subjects
     82,924  failures in single-failure-per-subject data
 3.0447e+09  total analysis time at risk and under observation
                                                at risk from t =         0
                                     earliest observed entry t =         0
                                          last observed exit t =       176

----------------------------------------------------------------------------------------------------------------------------------
active results
----------------------------------------------------------------------------------------------------------------------------------

Logistic regression                             Number of obs     = 17,343,479
                                                LR chi2(36)       =  274879.54
                                                Prob > chi2       =     0.0000
Log likelihood = -388352.53                     Pseudo R2         =     0.2614

-----------------------------------------------------------------------------------------------
                           _d | Odds Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
------------------------------+----------------------------------------------------------------
                         age1 |   1.116823    .004978    24.79   0.000     1.107109    1.126623
                         age2 |   .8798724    .009377   -12.01   0.000     .8616845    .8984442
                         age3 |   1.483873   .0381015    15.37   0.000     1.411044    1.560462
                       1.male |   1.165177   .0087266    20.41   0.000     1.148199    1.182407
                              |
                    obese4cat |
           Obese I (30-34.9)  |   .7780943   .0084966   -22.98   0.000     .7616183    .7949267
          Obese II (35-39.9)  |   .9600962   .0160711    -2.43   0.015     .9291085    .9921174
             Obese III (40+)  |   1.290141   .0300046    10.95   0.000     1.232653     1.35031
                              |
                 smoke_nomiss |
                      Former  |   1.159231   .0095631    17.91   0.000     1.140638    1.178126
                     Current  |   1.806033   .0227998    46.83   0.000     1.761894    1.851277
                              |
                          imd |
                           2  |   1.099738   .0126731     8.25   0.000     1.075178     1.12486
                           3  |   1.190255   .0136223    15.22   0.000     1.163853    1.217256
                           4  |   1.348445    .015553    25.92   0.000     1.318304    1.379276
             5 most deprived  |   1.556483   .0182591    37.71   0.000     1.521104    1.592685
                              |
           1.htdiag_or_highbp |   .9471635   .0081093    -6.34   0.000     .9314021    .9631915
1.chronic_respiratory_disease |   1.776243   .0168506    60.56   0.000     1.743522    1.809579
                              |
                    asthmacat |
                 Yes, no OCS  |    .943707   .0110791    -4.94   0.000     .9222403    .9656733
                Yes with OCS  |   .9262621   .0214478    -3.31   0.001     .8851649    .9692675
                              |
    1.chronic_cardiac_disease |   1.381409   .0113192    39.43   0.000     1.359401    1.403774
                              |
                      diabcat |
         Controlled diabetes  |   1.154215   .0113527    14.58   0.000     1.132178    1.176682
       Uncontrolled diabetes  |   1.584814   .0214532    34.02   0.000     1.543319    1.627424
  Diabetes, no hba1c measure  |   1.890717   .0377106    31.94   0.000     1.818232    1.966093
                              |
            cancer_exhaem_cat |
                   Last year  |   8.387009    .131798   135.33   0.000     8.132627    8.649348
               2-5 years ago  |   2.973434   .0408783    79.26   0.000     2.894383    3.054643
                    5+ years  |    1.45431    .016166    33.69   0.000     1.422968    1.486343
                              |
              cancer_haem_cat |
                   Last year  |   4.414756   .2248686    29.15   0.000     3.995308    4.878241
               2-5 years ago  |   2.595015   .0925246    26.75   0.000     2.419861    2.782846
                    5+ years  |   1.654512   .0488108    17.07   0.000     1.561558       1.753
                              |
      1.chronic_liver_disease |   3.176379   .0742138    49.47   0.000     3.034203    3.325217
            1.stroke_dementia |   1.886933    .018483    64.82   0.000     1.851053    1.923509
                1.other_neuro |   2.689316   .0447997    59.39   0.000     2.602928    2.778571
                              |
  reduced_kidney_function_cat |
Stage 3a/3b egfr 30-60        |   1.179215   .0102881    18.89   0.000     1.159222    1.199552
           Stage 4/5 egfr<30  |   2.567732   .0404936    59.80   0.000     2.489581    2.648338
                              |
           1.organ_transplant |   2.060683   .1226374    12.15   0.000     1.833807    2.315628
                     1.spleen |   1.513633   .0830096     7.56   0.000     1.359376    1.685395
           1.ra_sle_psoriasis |   1.126148   .0146566     9.13   0.000     1.097785    1.155244
    1.other_immunosuppression |   2.269219   .1186571    15.67   0.000     2.048176    2.514118
                        _cons |   4.34e-06   6.74e-07   -79.60   0.000     3.21e-06    5.89e-06
-----------------------------------------------------------------------------------------------
Note: _cons estimates baseline odds.
file ./output/models/an_noncovid_full_2020_agespline_bmicat_noeth.ster saved

----------------------------------------------------------------------------------------------------------------------------------
active results
----------------------------------------------------------------------------------------------------------------------------------

Logistic regression                             Number of obs     = 17,343,479
                                                LR chi2(38)       =  258387.61
                                                Prob > chi2       =     0.0000
Log likelihood =  -396598.5                     Pseudo R2         =     0.2457

-----------------------------------------------------------------------------------------------
                           _d | Odds Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
------------------------------+----------------------------------------------------------------
                     agegroup |
                      18-<40  |   .1526815   .0050643   -56.66   0.000     .1430715    .1629371
                      40-<50  |   .4889284   .0134571   -26.00   0.000     .4632517    .5160284
                      60-<70  |   2.185299   .0401247    42.58   0.000     2.108054    2.265374
                      70-<80  |   4.639435   .0798866    89.12   0.000     4.485473    4.798682
                         80+  |      16.02   .2750764   161.54   0.000     15.48983    16.56831
                              |
                       1.male |   1.080485   .0079976    10.46   0.000     1.064923    1.096274
                              |
                    obese4cat |
           Obese I (30-34.9)  |   .7054685   .0076522   -32.17   0.000     .6906288    .7206271
          Obese II (35-39.9)  |   .8394548   .0139847   -10.50   0.000      .812488    .8673167
             Obese III (40+)  |   1.093488   .0253718     3.85   0.000     1.044874    1.144363
                              |
                 smoke_nomiss |
                      Former  |   1.155773   .0094932    17.63   0.000     1.137316     1.17453
                     Current  |    1.63271   .0204131    39.21   0.000     1.593188    1.673214
                              |
                          imd |
                           2  |   1.100818   .0126299     8.37   0.000      1.07634    1.125853
                           3  |    1.19212   .0135856    15.42   0.000     1.165788    1.219047
                           4  |   1.345487   .0154573    25.83   0.000      1.31553    1.376127
             5 most deprived  |    1.53805   .0179811    36.82   0.000     1.503208    1.573699
                              |
           1.htdiag_or_highbp |   .9951963   .0084975    -0.56   0.573     .9786802    1.011991
1.chronic_respiratory_disease |   1.745108     .01652    58.82   0.000     1.713028    1.777789
                              |
                    asthmacat |
                 Yes, no OCS  |   .9197139   .0107526    -7.16   0.000     .8988788     .941032
                Yes with OCS  |   .8960809   .0206801    -4.75   0.000     .8564517    .9375439
                              |
    1.chronic_cardiac_disease |   1.456424   .0119234    45.93   0.000     1.433241    1.479982
                              |
                      diabcat |
         Controlled diabetes  |    1.11547   .0109543    11.13   0.000     1.094205    1.137148
       Uncontrolled diabetes  |   1.465371   .0197929    28.29   0.000     1.427086    1.504682
  Diabetes, no hba1c measure  |   1.958664   .0387805    33.95   0.000     1.884112    2.036167
                              |
            cancer_exhaem_cat |
                   Last year  |   8.118898   .1268638   134.02   0.000     7.874019    8.371394
               2-5 years ago  |   2.895901   .0396365    77.69   0.000     2.819247    2.974638
                    5+ years  |   1.487482   .0164693    35.86   0.000     1.455551    1.520114
                              |
              cancer_haem_cat |
                   Last year  |   4.218365   .2137648    28.41   0.000     3.819528    4.658849
               2-5 years ago  |   2.455018   .0873811    25.23   0.000     2.289592    2.632397
                    5+ years  |   1.625857   .0477394    16.55   0.000     1.534931    1.722169
                              |
      1.chronic_liver_disease |   2.988154   .0696943    46.93   0.000     2.854631    3.127922
            1.stroke_dementia |   2.034596   .0198281    72.89   0.000     1.996103    2.073832
                1.other_neuro |   2.577971   .0427492    57.11   0.000     2.495531    2.663134
                              |
  reduced_kidney_function_cat |
Stage 3a/3b egfr 30-60        |   1.400685   .0120045    39.32   0.000     1.377353    1.424412
           Stage 4/5 egfr<30  |   3.326773   .0516523    77.42   0.000     3.227061    3.429566
                              |
           1.organ_transplant |   1.704497   .1012646     8.98   0.000     1.517142    1.914989
                     1.spleen |   1.461133   .0797876     6.94   0.000      1.31283    1.626189
           1.ra_sle_psoriasis |   1.095075   .0142025     7.00   0.000     1.067589    1.123268
    1.other_immunosuppression |   2.115827   .1105407    14.34   0.000     1.909895    2.343964
                        _cons |   .0008325   .0000152  -388.91   0.000     .0008033    .0008628
-----------------------------------------------------------------------------------------------
Note: _cons estimates baseline odds.
file ./output/models/an_noncovid_full_2020_agegroup_bmicat_noeth.ster saved

----------------------------------------------------------------------------------------------------------------------------------
active results
----------------------------------------------------------------------------------------------------------------------------------

Logistic regression                             Number of obs     = 12,773,694
                                                LR chi2(40)       =  198370.05
                                                Prob > chi2       =     0.0000
Log likelihood = -279571.87                     Pseudo R2         =     0.2619

-----------------------------------------------------------------------------------------------
                           _d | Odds Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
------------------------------+----------------------------------------------------------------
                         age1 |   1.128588   .0062864    21.72   0.000     1.116334    1.140976
                         age2 |   .8550277   .0111969   -11.96   0.000     .8333614    .8772572
                         age3 |    1.59427   .0499728    14.88   0.000     1.499273    1.695286
                       1.male |   1.184966   .0104831    19.18   0.000     1.164597    1.205692
                              |
                    obese4cat |
           Obese I (30-34.9)  |   .7746698   .0098312   -20.12   0.000     .7556387    .7941802
          Obese II (35-39.9)  |   .9606366   .0185752    -2.08   0.038     .9249111     .997742
             Obese III (40+)  |   1.260909    .034181     8.55   0.000     1.195664    1.329714
                              |
                 smoke_nomiss |
                      Former  |   1.151049   .0113976    14.21   0.000     1.128926    1.173606
                     Current  |   1.781908   .0265949    38.71   0.000     1.730538    1.834803
                              |
                    ethnicity |
                       Mixed  |   .8371303   .0562605    -2.65   0.008     .7338155     .954991
      Asian or Asian British  |   .8524969   .0202259    -6.73   0.000     .8137624    .8930751
                       Black  |   .8493172   .0322262    -4.30   0.000     .7884464    .9148874
                       Other  |   .7111028   .0372923    -6.50   0.000     .6416421    .7880829
                              |
                          imd |
                           2  |   1.124714   .0157237     8.41   0.000     1.094314    1.155958
                           3  |   1.215057   .0168503    14.05   0.000     1.182475    1.248536
                           4  |   1.393949   .0193124    23.97   0.000     1.356607    1.432319
             5 most deprived  |   1.617728   .0225975    34.44   0.000     1.574039     1.66263
                              |
           1.htdiag_or_highbp |   .9592811   .0097772    -4.08   0.000     .9403082    .9786368
1.chronic_respiratory_disease |   1.772414   .0195442    51.90   0.000     1.734519    1.811137
                              |
                    asthmacat |
                 Yes, no OCS  |   .9559733   .0129748    -3.32   0.001     .9308785    .9817447
                Yes with OCS  |   .9359989   .0247598    -2.50   0.012     .8887072    .9858072
                              |
    1.chronic_cardiac_disease |   1.375814   .0133114    32.98   0.000      1.34997    1.402153
                              |
                      diabcat |
         Controlled diabetes  |   1.178913   .0135809    14.29   0.000     1.152593    1.205834
       Uncontrolled diabetes  |   1.612501   .0254449    30.28   0.000     1.563393    1.663151
  Diabetes, no hba1c measure  |   1.959931   .0455094    28.98   0.000     1.872734    2.051189
                              |
            cancer_exhaem_cat |
                   Last year  |   8.423392   .1554335   115.49   0.000     8.124191    8.733612
               2-5 years ago  |   2.978045   .0483059    67.28   0.000     2.884857    3.074244
                    5+ years  |   1.445148   .0190858    27.88   0.000     1.408221    1.483044
                              |
              cancer_haem_cat |
                   Last year  |   4.284426   .2610381    23.88   0.000     3.802168    4.827853
               2-5 years ago  |   2.680459   .1119323    23.61   0.000     2.469813     2.90907
                    5+ years  |   1.617384   .0569324    13.66   0.000     1.509561    1.732909
                              |
      1.chronic_liver_disease |   3.195156   .0856541    43.33   0.000     3.031611    3.367523
            1.stroke_dementia |   1.900108   .0218941    55.71   0.000     1.857677    1.943508
                1.other_neuro |   2.695671   .0525523    50.87   0.000     2.594614    2.800665
                              |
  reduced_kidney_function_cat |
Stage 3a/3b egfr 30-60        |   1.178359    .012246    15.79   0.000       1.1546    1.202607
           Stage 4/5 egfr<30  |   2.590037   .0483338    51.00   0.000     2.497016    2.686523
                              |
           1.organ_transplant |   1.917198    .137879     9.05   0.000     1.665142    2.207409
                     1.spleen |   1.448974   .0940512     5.71   0.000      1.27588     1.64555
           1.ra_sle_psoriasis |   1.112749   .0170102     6.99   0.000     1.079905    1.146593
    1.other_immunosuppression |   2.278902   .1371249    13.69   0.000     2.025385    2.564151
                        _cons |   3.03e-06   5.91e-07   -65.04   0.000     2.06e-06    4.44e-06
-----------------------------------------------------------------------------------------------
Note: _cons estimates baseline odds.
file ./output/models/an_noncovid_full_2020_agespline_bmicat_CCeth.ster saved

. 
end of do-file

. cd
e:\analyses\covid-vs-noncovid-deaths-research\analysis

. doedit

. do "E:\analyses\covid-vs-noncovid-deaths-research\analysis\an_table_covidvsnoncovid_agesex.do"

. 
. 
. *Coding: Krishnan Bhaskaran
. *
. *Date drafted: 10/9/2020
. *************************************************************************
. 
. 
. ***********************************************************************************************************************
. *Generic code to ouput the HRs across outcomes for all levels of a particular variables, in the right shape for table
. cap prog drop outputHRsforvar

. prog define outputHRsforvar
  1. syntax, variable(string) min(real) max(real) 
  2. forvalues i=`min'/`max'{
  3. local endwith "_tab"
  4. 
.         *put the varname and condition to left so that alignment can be checked vs shell
.         file write tablecontents ("`variable'") _tab ("`i'") _tab
  5.         
.         foreach failn of numlist 1 2 {
  6.         
.                 if `failn'==1 local outcome "COV"
  7.                 else if `failn'==2 local outcome "NONCOV"
  8.                 
.                 local noestimatesflag 0 /*reset*/
  9. 
. *CHANGE THE OUTCOME BELOW TO LAST IF BRINGING IN MORE COLS
.                 if `failn'==2 local endwith "_n"
 10. 
.                 ***********************
.                 *1) GET THE RIGHT ESTIMATES INTO MEMORY
. 
.                 
. 
.                 *FOR AGEGROUP - need to use the separate univariate/multivariate model fitted with age group rather than spline
.                 *FOR ETHNICITY - use the separate complete case multivariate model
.                 *FOR REST - use the "main" multivariate model
.                 if "`variable'"=="agegroup" {
 11.                                 cap estimates use ./output/models/an_covidvsnoncovid_agesex_fail`failn'_AGEGROUP
 12.                                 if _rc!=0 local noestimatesflag 1
 13.                                 }       
 14.                 else {
 15.                                 cap estimates use ./output/models/an_covidvsnoncovid_agesex_fail`failn'_`variable'
 16.                                 if _rc!=0 local noestimatesflag 1
 17.                                 }
 18.                 
.                 ***********************
.                 *2) WRITE THE HRs TO THE OUTPUT FILE
.                 
.                 if `noestimatesflag'==0{
 19.                         cap lincom `i'.`variable', eform
 20.                         if _rc==0 file write tablecontents %4.2f (r(estimate)) (" (") %4.2f (r(lb)) ("-") %4.2f (r(ub)) (")") `endwith'
 21.                                 else file write tablecontents %4.2f ("ERR IN MODEL") `endwith'
 22.                         }
 23.                         else file write tablecontents %4.2f ("DID NOT FIT") `endwith' 
 24.                         
.                 *3) Save the estimates for plotting
.                 if `noestimatesflag'==0{
 25.                                 local hr = r(estimate)
 26.                                 local lb = r(lb)
 27.                                 local ub = r(ub)
 28.                                 cap gen `variable'=.
 29.                                 testparm i.`variable'
 30.                                 post HRestimates ("`outcome'") ("`variable'") (`i') (`hr') (`lb') (`ub') (r(p))
 31.                                 drop `variable'
 32.                                 }       
 33.                 } /*failn 1 2 */
 34.                 
. } /*variable levels*/
 35. 
. end

. ***********************************************************************************************************************
. *Generic code to write a full row of "ref category" to the output file
. cap prog drop refline

. prog define refline
  1. file write tablecontents _tab _tab ("1.00 (ref)") _tab ("1.00 (ref)")  _n
  2. *post HRestimates ("`outcome'") ("`variable'") (`refcat') (1) (1) (1) (.)
. end

. ***********************************************************************************************************************
. 
. *MAIN CODE TO PRODUCE TABLE CONTENTS
. 
. cap file close tablecontents

. file open tablecontents using ./output/an_table_covidvsnoncovid_agesex.txt, t w replace 
(note: file ./output/an_table_covidvsnoncovid_agesex.txt not found)

. 
. tempfile HRestimates

. cap postutil clear

. postfile HRestimates str6 outcome str27 variable level hr lci uci pval using `HRestimates'

. 
. *Age group
. outputHRsforvar, variable("agegroup") min(1) max(2) 

 ( 1)  [_d]2.agegroup = 0
 ( 2)  [_d]3.agegroup = 0
 ( 3)  [_d]4.agegroup = 0
 ( 4)  [_d]5.agegroup = 0
 ( 5)  [_d]6.agegroup = 0

           chi2(  5) =24315.89
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.agegroup = 0
 ( 2)  [_d]3.agegroup = 0
 ( 3)  [_d]4.agegroup = 0
 ( 4)  [_d]5.agegroup = 0
 ( 5)  [_d]6.agegroup = 0

           chi2(  5) = 1.3e+05
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.agegroup = 0
 ( 2)  [_d]3.agegroup = 0
 ( 3)  [_d]4.agegroup = 0
 ( 4)  [_d]5.agegroup = 0
 ( 5)  [_d]6.agegroup = 0

           chi2(  5) =24315.89
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.agegroup = 0
 ( 2)  [_d]3.agegroup = 0
 ( 3)  [_d]4.agegroup = 0
 ( 4)  [_d]5.agegroup = 0
 ( 5)  [_d]6.agegroup = 0

           chi2(  5) = 1.3e+05
         Prob > chi2 =    0.0000

. refline

. outputHRsforvar, variable("agegroup") min(4) max(6) 

 ( 1)  [_d]2.agegroup = 0
 ( 2)  [_d]3.agegroup = 0
 ( 3)  [_d]4.agegroup = 0
 ( 4)  [_d]5.agegroup = 0
 ( 5)  [_d]6.agegroup = 0

           chi2(  5) =24315.89
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.agegroup = 0
 ( 2)  [_d]3.agegroup = 0
 ( 3)  [_d]4.agegroup = 0
 ( 4)  [_d]5.agegroup = 0
 ( 5)  [_d]6.agegroup = 0

           chi2(  5) = 1.3e+05
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.agegroup = 0
 ( 2)  [_d]3.agegroup = 0
 ( 3)  [_d]4.agegroup = 0
 ( 4)  [_d]5.agegroup = 0
 ( 5)  [_d]6.agegroup = 0

           chi2(  5) =24315.89
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.agegroup = 0
 ( 2)  [_d]3.agegroup = 0
 ( 3)  [_d]4.agegroup = 0
 ( 4)  [_d]5.agegroup = 0
 ( 5)  [_d]6.agegroup = 0

           chi2(  5) = 1.3e+05
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.agegroup = 0
 ( 2)  [_d]3.agegroup = 0
 ( 3)  [_d]4.agegroup = 0
 ( 4)  [_d]5.agegroup = 0
 ( 5)  [_d]6.agegroup = 0

           chi2(  5) =24315.89
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.agegroup = 0
 ( 2)  [_d]3.agegroup = 0
 ( 3)  [_d]4.agegroup = 0
 ( 4)  [_d]5.agegroup = 0
 ( 5)  [_d]6.agegroup = 0

           chi2(  5) = 1.3e+05
         Prob > chi2 =    0.0000

. file write tablecontents _n 

. 
. *Sex 
. refline

. outputHRsforvar, variable("male") min(1) max(1) 

. file write tablecontents _n

. 
. *BMI
. refline

. outputHRsforvar, variable("obese4cat") min(2) max(4) 

 ( 1)  [_d]2.obese4cat = 0
 ( 2)  [_d]3.obese4cat = 0
 ( 3)  [_d]4.obese4cat = 0

           chi2(  3) =  661.61
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.obese4cat = 0
 ( 2)  [_d]3.obese4cat = 0
 ( 3)  [_d]4.obese4cat = 0

           chi2(  3) =  663.68
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.obese4cat = 0
 ( 2)  [_d]3.obese4cat = 0
 ( 3)  [_d]4.obese4cat = 0

           chi2(  3) =  661.61
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.obese4cat = 0
 ( 2)  [_d]3.obese4cat = 0
 ( 3)  [_d]4.obese4cat = 0

           chi2(  3) =  663.68
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.obese4cat = 0
 ( 2)  [_d]3.obese4cat = 0
 ( 3)  [_d]4.obese4cat = 0

           chi2(  3) =  661.61
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.obese4cat = 0
 ( 2)  [_d]3.obese4cat = 0
 ( 3)  [_d]4.obese4cat = 0

           chi2(  3) =  663.68
         Prob > chi2 =    0.0000

. file write tablecontents _n

. 
. *Smoking
. refline

. outputHRsforvar, variable("smoke_nomiss") min(2) max(3) 

 ( 1)  [_d]2.smoke_nomiss = 0
 ( 2)  [_d]3.smoke_nomiss = 0

           chi2(  2) =  333.21
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.smoke_nomiss = 0
 ( 2)  [_d]3.smoke_nomiss = 0

           chi2(  2) = 6361.00
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.smoke_nomiss = 0
 ( 2)  [_d]3.smoke_nomiss = 0

           chi2(  2) =  333.21
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.smoke_nomiss = 0
 ( 2)  [_d]3.smoke_nomiss = 0

           chi2(  2) = 6361.00
         Prob > chi2 =    0.0000

. file write tablecontents _n

. 
. *Ethnicity
. refline

. outputHRsforvar, variable("ethnicity") min(2) max(5) 

 ( 1)  [_d]2.ethnicity = 0
 ( 2)  [_d]3.ethnicity = 0
 ( 3)  [_d]4.ethnicity = 0
 ( 4)  [_d]5.ethnicity = 0

           chi2(  4) =  558.17
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.ethnicity = 0
 ( 2)  [_d]3.ethnicity = 0
 ( 3)  [_d]4.ethnicity = 0
 ( 4)  [_d]5.ethnicity = 0

           chi2(  4) =  176.55
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.ethnicity = 0
 ( 2)  [_d]3.ethnicity = 0
 ( 3)  [_d]4.ethnicity = 0
 ( 4)  [_d]5.ethnicity = 0

           chi2(  4) =  558.17
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.ethnicity = 0
 ( 2)  [_d]3.ethnicity = 0
 ( 3)  [_d]4.ethnicity = 0
 ( 4)  [_d]5.ethnicity = 0

           chi2(  4) =  176.55
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.ethnicity = 0
 ( 2)  [_d]3.ethnicity = 0
 ( 3)  [_d]4.ethnicity = 0
 ( 4)  [_d]5.ethnicity = 0

           chi2(  4) =  558.17
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.ethnicity = 0
 ( 2)  [_d]3.ethnicity = 0
 ( 3)  [_d]4.ethnicity = 0
 ( 4)  [_d]5.ethnicity = 0

           chi2(  4) =  176.55
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.ethnicity = 0
 ( 2)  [_d]3.ethnicity = 0
 ( 3)  [_d]4.ethnicity = 0
 ( 4)  [_d]5.ethnicity = 0

           chi2(  4) =  558.17
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.ethnicity = 0
 ( 2)  [_d]3.ethnicity = 0
 ( 3)  [_d]4.ethnicity = 0
 ( 4)  [_d]5.ethnicity = 0

           chi2(  4) =  176.55
         Prob > chi2 =    0.0000

. file write tablecontents _n

. 
. *IMD
. refline

. outputHRsforvar, variable("imd") min(2) max(5) 

 ( 1)  [_d]2.imd = 0
 ( 2)  [_d]3.imd = 0
 ( 3)  [_d]4.imd = 0
 ( 4)  [_d]5.imd = 0

           chi2(  4) = 1296.09
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.imd = 0
 ( 2)  [_d]3.imd = 0
 ( 3)  [_d]4.imd = 0
 ( 4)  [_d]5.imd = 0

           chi2(  4) = 2911.68
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.imd = 0
 ( 2)  [_d]3.imd = 0
 ( 3)  [_d]4.imd = 0
 ( 4)  [_d]5.imd = 0

           chi2(  4) = 1296.09
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.imd = 0
 ( 2)  [_d]3.imd = 0
 ( 3)  [_d]4.imd = 0
 ( 4)  [_d]5.imd = 0

           chi2(  4) = 2911.68
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.imd = 0
 ( 2)  [_d]3.imd = 0
 ( 3)  [_d]4.imd = 0
 ( 4)  [_d]5.imd = 0

           chi2(  4) = 1296.09
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.imd = 0
 ( 2)  [_d]3.imd = 0
 ( 3)  [_d]4.imd = 0
 ( 4)  [_d]5.imd = 0

           chi2(  4) = 2911.68
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.imd = 0
 ( 2)  [_d]3.imd = 0
 ( 3)  [_d]4.imd = 0
 ( 4)  [_d]5.imd = 0

           chi2(  4) = 1296.09
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.imd = 0
 ( 2)  [_d]3.imd = 0
 ( 3)  [_d]4.imd = 0
 ( 4)  [_d]5.imd = 0

           chi2(  4) = 2911.68
         Prob > chi2 =    0.0000

. file write tablecontents _n 

. 
. *BP/hypertension
. refline

. outputHRsforvar, variable("htdiag_or_highbp") min(1) max(1) 

 ( 1)  [_d]1.htdiag_or_highbp = 0

           chi2(  1) =   19.82
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.htdiag_or_highbp = 0

           chi2(  1) =   55.39
         Prob > chi2 =    0.0000

. file write tablecontents _n

. outputHRsforvar, variable("chronic_respiratory_disease") min(1) max(1) 

 ( 1)  [_d]1.chronic_respiratory_disease = 0

           chi2(  1) = 1101.69
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.chronic_respiratory_disease = 0

           chi2(  1) = 8717.58
         Prob > chi2 =    0.0000

. file write tablecontents _n                     

. outputHRsforvar, variable("asthmacat") min(2) max(3)                    

 ( 1)  [_d]2.asthmacat = 0
 ( 2)  [_d]3.asthmacat = 0

           chi2(  2) =   99.99
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.asthmacat = 0
 ( 2)  [_d]3.asthmacat = 0

           chi2(  2) =   91.32
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.asthmacat = 0
 ( 2)  [_d]3.asthmacat = 0

           chi2(  2) =   99.99
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.asthmacat = 0
 ( 2)  [_d]3.asthmacat = 0

           chi2(  2) =   91.32
         Prob > chi2 =    0.0000

. outputHRsforvar, variable("chronic_cardiac_disease") min(1) max(1) 

 ( 1)  [_d]1.chronic_cardiac_disease = 0

           chi2(  1) =  692.43
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.chronic_cardiac_disease = 0

           chi2(  1) = 5020.05
         Prob > chi2 =    0.0000

. file write tablecontents _n     

. outputHRsforvar, variable("diabcat") min(2) max(4) 

 ( 1)  [_d]2.diabcat = 0
 ( 2)  [_d]3.diabcat = 0
 ( 3)  [_d]4.diabcat = 0

           chi2(  3) = 1799.52
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.diabcat = 0
 ( 2)  [_d]3.diabcat = 0
 ( 3)  [_d]4.diabcat = 0

           chi2(  3) = 3361.90
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.diabcat = 0
 ( 2)  [_d]3.diabcat = 0
 ( 3)  [_d]4.diabcat = 0

           chi2(  3) = 1799.52
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.diabcat = 0
 ( 2)  [_d]3.diabcat = 0
 ( 3)  [_d]4.diabcat = 0

           chi2(  3) = 3361.90
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.diabcat = 0
 ( 2)  [_d]3.diabcat = 0
 ( 3)  [_d]4.diabcat = 0

           chi2(  3) = 1799.52
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.diabcat = 0
 ( 2)  [_d]3.diabcat = 0
 ( 3)  [_d]4.diabcat = 0

           chi2(  3) = 3361.90
         Prob > chi2 =    0.0000

. file write tablecontents _n             

. outputHRsforvar, variable("cancer_exhaem_cat") min(2) max(4) 

 ( 1)  [_d]2.cancer_exhaem_cat = 0
 ( 2)  [_d]3.cancer_exhaem_cat = 0
 ( 3)  [_d]4.cancer_exhaem_cat = 0

           chi2(  3) =  125.21
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.cancer_exhaem_cat = 0
 ( 2)  [_d]3.cancer_exhaem_cat = 0
 ( 3)  [_d]4.cancer_exhaem_cat = 0

           chi2(  3) =34591.81
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.cancer_exhaem_cat = 0
 ( 2)  [_d]3.cancer_exhaem_cat = 0
 ( 3)  [_d]4.cancer_exhaem_cat = 0

           chi2(  3) =  125.21
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.cancer_exhaem_cat = 0
 ( 2)  [_d]3.cancer_exhaem_cat = 0
 ( 3)  [_d]4.cancer_exhaem_cat = 0

           chi2(  3) =34591.81
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.cancer_exhaem_cat = 0
 ( 2)  [_d]3.cancer_exhaem_cat = 0
 ( 3)  [_d]4.cancer_exhaem_cat = 0

           chi2(  3) =  125.21
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.cancer_exhaem_cat = 0
 ( 2)  [_d]3.cancer_exhaem_cat = 0
 ( 3)  [_d]4.cancer_exhaem_cat = 0

           chi2(  3) =34591.81
         Prob > chi2 =    0.0000

. file write tablecontents _n             

. outputHRsforvar, variable("cancer_haem_cat") min(2) max(4)              

 ( 1)  [_d]2.cancer_haem_cat = 0
 ( 2)  [_d]3.cancer_haem_cat = 0
 ( 3)  [_d]4.cancer_haem_cat = 0

           chi2(  3) =  255.16
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.cancer_haem_cat = 0
 ( 2)  [_d]3.cancer_haem_cat = 0
 ( 3)  [_d]4.cancer_haem_cat = 0

           chi2(  3) = 2839.60
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.cancer_haem_cat = 0
 ( 2)  [_d]3.cancer_haem_cat = 0
 ( 3)  [_d]4.cancer_haem_cat = 0

           chi2(  3) =  255.16
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.cancer_haem_cat = 0
 ( 2)  [_d]3.cancer_haem_cat = 0
 ( 3)  [_d]4.cancer_haem_cat = 0

           chi2(  3) = 2839.60
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.cancer_haem_cat = 0
 ( 2)  [_d]3.cancer_haem_cat = 0
 ( 3)  [_d]4.cancer_haem_cat = 0

           chi2(  3) =  255.16
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.cancer_haem_cat = 0
 ( 2)  [_d]3.cancer_haem_cat = 0
 ( 3)  [_d]4.cancer_haem_cat = 0

           chi2(  3) = 2839.60
         Prob > chi2 =    0.0000

. file write tablecontents _n

. outputHRsforvar, variable("reduced_kidney_function_cat") min(2) max(3)          

 ( 1)  [_d]2.reduced_kidney_function_cat = 0
 ( 2)  [_d]3.reduced_kidney_function_cat = 0

           chi2(  2) = 1349.97
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.reduced_kidney_function_cat = 0
 ( 2)  [_d]3.reduced_kidney_function_cat = 0

           chi2(  2) = 6224.47
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.reduced_kidney_function_cat = 0
 ( 2)  [_d]3.reduced_kidney_function_cat = 0

           chi2(  2) = 1349.97
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.reduced_kidney_function_cat = 0
 ( 2)  [_d]3.reduced_kidney_function_cat = 0

           chi2(  2) = 6224.47
         Prob > chi2 =    0.0000

. outputHRsforvar, variable("chronic_liver_disease") min(1) max(1)                        

 ( 1)  [_d]1.chronic_liver_disease = 0

           chi2(  1) =  237.81
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.chronic_liver_disease = 0

           chi2(  1) = 4530.61
         Prob > chi2 =    0.0000

. outputHRsforvar, variable("stroke_dementia") min(1) max(1)      

 ( 1)  [_d]1.stroke_dementia = 0

           chi2(  1) = 2159.47
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.stroke_dementia = 0

           chi2(  1) = 6277.31
         Prob > chi2 =    0.0000

. outputHRsforvar, variable("other_neuro") min(1) max(1)          

 ( 1)  [_d]1.other_neuro = 0

           chi2(  1) = 1233.56
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.other_neuro = 0

           chi2(  1) = 3795.22
         Prob > chi2 =    0.0000

. outputHRsforvar, variable("organ_transplant") min(1) max(1)                     

 ( 1)  [_d]1.organ_transplant = 0

           chi2(  1) =  238.93
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.organ_transplant = 0

           chi2(  1) =  478.46
         Prob > chi2 =    0.0000

. outputHRsforvar, variable("spleen") min(1) max(1) 

 ( 1)  [_d]1.spleen = 0

           chi2(  1) =    6.27
         Prob > chi2 =    0.0123

 ( 1)  [_d]1.spleen = 0

           chi2(  1) =  214.14
         Prob > chi2 =    0.0000

. outputHRsforvar, variable("ra_sle_psoriasis") min(1) max(1) 

 ( 1)  [_d]1.ra_sle_psoriasis = 0

           chi2(  1) =   88.85
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.ra_sle_psoriasis = 0

           chi2(  1) =  273.14
         Prob > chi2 =    0.0000

. outputHRsforvar, variable("other_immunosuppression") min(1) max(1) 

 ( 1)  [_d]1.other_immunosuppression = 0

           chi2(  1) =   77.48
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.other_immunosuppression = 0

           chi2(  1) =  527.14
         Prob > chi2 =    0.0000

. 
. 
. file close tablecontents

. 
. postclose HRestimates

. 
. use `HRestimates', clear

. 
. gen varorder = 1 

. local i=2

. foreach var of any male obese4cat smoke_nomiss ethnicity imd  diabcat ///
>         cancer_exhaem_cat cancer_haem_cat reduced_kidney_function_cat asthmacat chronic_respiratory_disease ///
>         chronic_cardiac_disease htdiag_or_highbp chronic_liver_disease ///
>         stroke_dementia other_neuro organ_transplant ///
>         spleen ra_sle_psoriasis other_immunosuppression {
  2. replace varorder = `i' if variable=="`var'"
  3. local i=`i'+1
  4. }
(0 real changes made)
(6 real changes made)
(4 real changes made)
(8 real changes made)
(8 real changes made)
(6 real changes made)
(6 real changes made)
(6 real changes made)
(4 real changes made)
(4 real changes made)
(2 real changes made)
(2 real changes made)
(2 real changes made)
(2 real changes made)
(2 real changes made)
(2 real changes made)
(2 real changes made)
(2 real changes made)
(2 real changes made)
(2 real changes made)

. sort varorder outcome level

. drop varorder

. 
. gen obsorder=_n

. expand 2 if variable!=variable[_n-1] | outcome!=outcome[_n-1], gen(expanded)
(40 observations created)

. for var hr lci uci: replace X = 1 if expanded==1

->  replace hr = 1 if expanded==1
(38 real changes made)

->  replace lci = 1 if expanded==1
(40 real changes made)

->  replace uci = 1 if expanded==1
(40 real changes made)

. 
. sort obsorder

. drop obsorder

. replace level = 0 if expanded == 1
(40 real changes made)

. replace level = 1 if expanded == 1 & (variable=="obese4cat"|variable=="smoke_nomiss"|variable=="ethnicity"|variable=="imd"|variable=="asthmacat"|variable=="diabcat"|substr(variable,1,6)=="cancer"|variab
> le=="reduced_kidney_function_cat"|variable=="agegroup")
(20 real changes made)

. replace level = 3 if expanded == 1 & variable=="agegroup"
(2 real changes made)

. 
. gen varorder = 1 if variable!=variable[_n-1]
(102 missing values generated)

. replace varorder = sum(varorder)
(121 real changes made)

. sort varorder outcome level

. 
. 
. drop expanded

. expand 2 if variable!=variable[_n-1] | outcome!=outcome[_n-1], gen(expanded)
(40 observations created)

. replace level = -1 if expanded==1
(40 real changes made)

. drop expanded

. *expand 3 if variable=="htdiag_or_highbp" & level==-1, gen(expanded)
. *replace level = -99 if variable=="htdiag_or_highbp" & expanded==1
. expand 2 if level == -1, gen(expanded)
(40 observations created)

. replace level = -99 if expanded==1
(40 real changes made)

. 
. for var hr lci uci pval : replace X=. if level<0

->  replace hr=. if level<0
(80 real changes made, 80 to missing)

->  replace lci=. if level<0
(76 real changes made, 76 to missing)

->  replace uci=. if level<0
(76 real changes made, 76 to missing)

->  replace pval=. if level<0
(80 real changes made, 80 to missing)

. sort varorder outcome  level

. 
. gen varx = 0.07

. gen levelx = 0.071

. gen lowerlimit = 0.15

. 
. *Names
. gen Name = variable if (level==-1&!(level[_n+1]==0&variable!="male"))|(level==1&level[_n-1]==0&variable!="male")
(162 missing values generated)

. replace Name = subinstr(Name, "_", " ", 10)
(26 real changes made)

. replace Name = upper(substr(Name,1,1)) + substr(Name,2,.)
(40 real changes made)

. replace Name = "Age group" if Name=="Agegroup"
(2 real changes made)

. replace Name = "Sex" if Name=="Male"
(0 real changes made)

. replace Name = "Obesity" if Name=="Obese4cat"
(2 real changes made)

. replace Name = "Smoking status" if Name=="Smoke nomiss"
(2 real changes made)

. replace Name = "Deprivation (IMD) quintile" if Name=="Imd"
(2 real changes made)

. replace Name = "Hypertension/high bp" if Name=="Htdiag or highbp"
(2 real changes made)

. replace Name = "Asthma" if Name=="Asthmacat"
(2 real changes made)

. replace Name = "Diabetes" if Name=="Diabcat"
(2 real changes made)

. replace Name = "Cancer (non-haematological)" if Name=="Cancer exhaem cat"
(2 real changes made)

. replace Name = "Haematological malignancy" if Name=="Cancer haem cat"
(2 real changes made)

. replace Name = "Stroke or dementia" if Name=="Stroke dementia"
(2 real changes made)

. replace Name = "Other neurological" if Name=="Other neuro"
(2 real changes made)

. replace Name = "Rheumatoid arthritis/Lupus/Psoriasis" if Name=="Ra sle psoriasis"
variable Name was str27 now str36
(2 real changes made)

. replace Name = "Reduced kidney function" if Name=="Reduced kidney function cat"
(2 real changes made)

. replace Name = "Asplenia" if Name=="Spleen"
(2 real changes made)

. 
. *Levels
. gen leveldesc = ""
(202 missing values generated)

. replace leveldesc = "18-39" if variable=="agegroup" & level==1
variable leveldesc was str1 now str5
(2 real changes made)

. replace leveldesc = "40-49" if variable=="agegroup" & level==2
(2 real changes made)

. replace leveldesc = "50-59 (ref)" if variable=="agegroup" & level==3
variable leveldesc was str5 now str11
(2 real changes made)

. replace leveldesc = "60-69" if variable=="agegroup" & level==4
(2 real changes made)

. replace leveldesc = "70-79" if variable=="agegroup" & level==5
(2 real changes made)

. replace leveldesc = "80+" if variable=="agegroup" & level==6
(2 real changes made)

. 
. replace leveldesc = "Female (ref)" if variable=="male" & level==0
(0 real changes made)

. replace leveldesc = "Male" if variable=="male" & level==1
(0 real changes made)

. 
. replace leveldesc = "Not obese (ref)" if variable=="obese4cat" & level==1
variable leveldesc was str11 now str15
(2 real changes made)

. replace leveldesc = "Obese class I" if variable=="obese4cat" & level==2
(2 real changes made)

. replace leveldesc = "Obese class II" if variable=="obese4cat" & level==3
(2 real changes made)

. replace leveldesc = "Obese class III" if variable=="obese4cat" & level==4
(2 real changes made)

. 
. replace leveldesc = "Never (ref)" if variable=="smoke_nomiss" & level==1
(2 real changes made)

. replace leveldesc = "Ex-smoker" if variable=="smoke_nomiss" & level==2
(2 real changes made)

. replace leveldesc = "Current" if variable=="smoke_nomiss" & level==3
(2 real changes made)

. 
. replace leveldesc = "White (ref)" if variable=="ethnicity" & level==1
(2 real changes made)

. replace leveldesc = "Mixed" if variable=="ethnicity" & level==2
(2 real changes made)

. replace leveldesc = "Asian/Asian British" if variable=="ethnicity" & level==3
variable leveldesc was str15 now str19
(2 real changes made)

. replace leveldesc = "Black" if variable=="ethnicity" & level==4
(2 real changes made)

. replace leveldesc = "Other" if variable=="ethnicity" & level==5
(2 real changes made)

. 
. replace leveldesc = "1 (least deprived, ref)" if variable=="imd" & level==1
variable leveldesc was str19 now str23
(2 real changes made)

. replace leveldesc = "2" if variable=="imd" & level==2
(2 real changes made)

. replace leveldesc = "3" if variable=="imd" & level==3
(2 real changes made)

. replace leveldesc = "4" if variable=="imd" & level==4
(2 real changes made)

. replace leveldesc = "5 (most deprived)" if variable=="imd" & level==5
(2 real changes made)

. 
. replace leveldesc = "No diabetes (ref)" if variable=="diabcat" & level==1
(2 real changes made)

. replace leveldesc = "Controlled (HbA1c <58mmol/mol)" if variable=="diabcat" & level==2
variable leveldesc was str23 now str30
(2 real changes made)

. replace leveldesc = "Uncontrolled (HbA1c >=58mmol/mol) " if variable=="diabcat" & level==3
variable leveldesc was str30 now str34
(2 real changes made)

. replace leveldesc = "Unknown HbA1c" if variable=="diabcat" & level==4
(2 real changes made)

. 
. replace leveldesc = "No asthma (ref)" if variable=="asthmacat" & level==1
(2 real changes made)

. replace leveldesc = "With no recent OCS use" if variable=="asthmacat" & level==2
(2 real changes made)

. replace leveldesc = "With recent OCS use" if variable=="asthmacat" & level==3
(2 real changes made)

. 
. replace leveldesc = "Never (ref)" if substr(variable,1,6)=="cancer" & level==1
(4 real changes made)

. replace leveldesc = "<1 year ago" if substr(variable,1,6)=="cancer" & level==2
(4 real changes made)

. replace leveldesc = "1-4.9 years ago" if substr(variable,1,6)=="cancer" & level==3
(4 real changes made)

. replace leveldesc = "5+ years ago" if substr(variable,1,6)=="cancer" & level==4
(4 real changes made)

. 
. replace leveldesc = "None (ref)" if variable=="reduced_kidney_function_cat" & level==1
(2 real changes made)

. replace leveldesc = "eGFR 30-60 ml/min/1.73m2" if variable=="reduced_kidney_function_cat" & level==2
(2 real changes made)

. replace leveldesc = "eGFR <30 ml/min/1.73m2" if variable=="reduced_kidney_function_cat" & level==3
(2 real changes made)

. 
. 
. *replace leveldesc = "Absent" if level==0
. *replace leveldesc = "Present" if level==1 & leveldesc==""
. drop if level==0 & variable!="male"
(20 observations deleted)

. 
. 
. gen obsorder=_n

. gsort -obsorder

. gen graphorder = _n

. sort obsorder

. 
. *merge 1:1 variable level using c:\statatemp\tptemp, update replace
. 
. gen displayhrci = "<<< HR = " + string(hr, "%3.2f") + " (" + string(lci, "%3.2f") + "-" + string(uci, "%3.2f") + ")" if lci<0.15
(182 missing values generated)

. 
. scatter graphorder hr if lci>=.15 & outcome=="COV", mcol(red)   msize(small)            ///                                                                             ///
>         || rcap lci uci graphorder if lci>=.15 & outcome=="COV", hor mcol(red)  lcol(red)                       ///
>         || scatter graphorder hr if lci>=.15 & outcome=="NONCOV", mcol(black)   msize(small)            ///                                                                             ///
>         || rcap lci uci graphorder if lci>=.15 & outcome=="NONCOV", hor mcol(black)     lcol(black)                     ///
>         || scatter graphorder lowerlimit, m(i) mlab(displayhrci) mlabcol(black) mlabsize(tiny) ///
>         || scatter graphorder varx if outcome=="COV", m(i) mlab(Name) mlabsize(tiny) mlabcol(black)     ///
>         || scatter graphorder levelx if outcome=="COV", m(i) mlab(leveldesc) mlabsize(tiny) mlabcol(gs8)        ///
>                 xline(1,lp(dash))                                                                                                                       ///
>                 xscale(log) xlab(0.25 0.5 1 2 5 10) xtitle("Odds Ratio & 95% CI") ylab(none) ytitle("")                                         /// 
>                 yscale(r(100)) ysize(12)   legend(order(1 3) label(1 "COVID deaths") label(3 "Non-COVID deaths"))

.                 
. 
. graph export ./output/an_table_covidvsnoncovid_agesex.svg, as(svg) replace
(note: file ./output/an_table_covidvsnoncovid_agesex.svg not found)
(file ./output/an_table_covidvsnoncovid_agesex.svg written in SVG format)

. 
end of do-file

. do "E:\analyses\covid-vs-noncovid-deaths-research\analysis\an_table_covidvsnoncovid_full.do"

. 
. *Coding: Krishnan Bhaskaran
. *
. *Date drafted: 20/9/2020
. *************************************************************************
. 
. 
. ***********************************************************************************************************************
. *Generic code to ouput the HRs across outcomes for all levels of a particular variables, in the right shape for table
. cap prog drop outputHRsforvar

. prog define outputHRsforvar
  1. syntax, variable(string) min(real) max(real) 
  2. forvalues i=`min'/`max'{
  3. local endwith "_tab"
  4. 
.         *put the varname and condition to left so that alignment can be checked vs shell
.         file write tablecontents ("`variable'") _tab ("`i'") _tab
  5.         
.         foreach failn of numlist 1 2 {
  6.         
.                 if `failn'==1 local outcome "COV"
  7.                 else if `failn'==2 local outcome "NONCOV"
  8.                 
.                 local noestimatesflag 0 /*reset*/
  9. 
. *CHANGE THE OUTCOME BELOW TO LAST IF BRINGING IN MORE COLS
.                 if `failn'==2 local endwith "_n"
 10. 
.                 ***********************
.                 *1) GET THE RIGHT ESTIMATES INTO MEMORY
. 
.                 
. 
.                 *FOR AGEGROUP - need to use the separate univariate/multivariate model fitted with age group rather than spline
.                 *FOR ETHNICITY - use the separate complete case multivariate model
.                 *FOR REST - use the "main" multivariate model
.                 if "`variable'"=="agegroup" {
 11.                                 cap estimates use ./output/models/an_covidvsnoncovid_full_fail`failn'_agegroup_bmicat_noeth
 12.                                 if _rc!=0 local noestimatesflag 1
 13.                                 }
 14.                 else if "`variable'"=="ethnicity" {
 15.                                 cap estimates use ./output/models/an_covidvsnoncovid_full_fail`failn'_agespline_bmicat_CCeth  
 16.                                 if _rc!=0 local noestimatesflag 1
 17.                                 }                       
 18.                 else {
 19.                                 cap estimates use ./output/models/an_covidvsnoncovid_full_fail`failn'_agespline_bmicat_noeth
 20.                                 if _rc!=0 local noestimatesflag 1
 21.                                 }
 22.                 
.                 ***********************
.                 *2) WRITE THE HRs TO THE OUTPUT FILE
.                 
.                 if `noestimatesflag'==0{
 23.                         cap lincom `i'.`variable', eform
 24.                         if _rc==0 file write tablecontents %4.2f (r(estimate)) (" (") %4.2f (r(lb)) ("-") %4.2f (r(ub)) (")") `endwith'
 25.                                 else file write tablecontents %4.2f ("ERR IN MODEL") `endwith'
 26.                         }
 27.                         else file write tablecontents %4.2f ("DID NOT FIT") `endwith' 
 28.                         
.                 *3) Save the estimates for plotting
.                 if `noestimatesflag'==0{
 29.                                 local hr = r(estimate)
 30.                                 local lb = r(lb)
 31.                                 local ub = r(ub)
 32.                                 cap gen `variable'=.
 33.                                 testparm i.`variable'
 34.                                 post HRestimates ("`outcome'") ("`variable'") (`i') (`hr') (`lb') (`ub') (r(p))
 35.                                 drop `variable'
 36.                                 }       
 37.                 } /*failn 1 2 */
 38.                 
. } /*variable levels*/
 39. 
. end

. ***********************************************************************************************************************
. *Generic code to write a full row of "ref category" to the output file
. cap prog drop refline

. prog define refline
  1. file write tablecontents _tab _tab ("1.00 (ref)") _tab ("1.00 (ref)")  _n
  2. *post HRestimates ("`outcome'") ("`variable'") (`refcat') (1) (1) (1) (.)
. end

. ***********************************************************************************************************************
. 
. *MAIN CODE TO PRODUCE TABLE CONTENTS
. 
. cap file close tablecontents

. file open tablecontents using ./output/an_table_covidvsnoncovid_full.txt, t w replace 
(note: file ./output/an_table_covidvsnoncovid_full.txt not found)

. 
. tempfile HRestimates

. cap postutil clear

. postfile HRestimates str6 outcome str27 variable level hr lci uci pval using `HRestimates'

. 
. *Age group
. outputHRsforvar, variable("agegroup") min(1) max(2) 

 ( 1)  [_d]1.agegroup = 0
 ( 2)  [_d]2.agegroup = 0
 ( 3)  [_d]4.agegroup = 0
 ( 4)  [_d]5.agegroup = 0
 ( 5)  [_d]6.agegroup = 0

           chi2(  5) =12490.06
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.agegroup = 0
 ( 2)  [_d]2.agegroup = 0
 ( 3)  [_d]4.agegroup = 0
 ( 4)  [_d]5.agegroup = 0
 ( 5)  [_d]6.agegroup = 0

           chi2(  5) =60138.36
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.agegroup = 0
 ( 2)  [_d]2.agegroup = 0
 ( 3)  [_d]4.agegroup = 0
 ( 4)  [_d]5.agegroup = 0
 ( 5)  [_d]6.agegroup = 0

           chi2(  5) =12490.06
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.agegroup = 0
 ( 2)  [_d]2.agegroup = 0
 ( 3)  [_d]4.agegroup = 0
 ( 4)  [_d]5.agegroup = 0
 ( 5)  [_d]6.agegroup = 0

           chi2(  5) =60138.36
         Prob > chi2 =    0.0000

. refline

. outputHRsforvar, variable("agegroup") min(4) max(6) 

 ( 1)  [_d]1.agegroup = 0
 ( 2)  [_d]2.agegroup = 0
 ( 3)  [_d]4.agegroup = 0
 ( 4)  [_d]5.agegroup = 0
 ( 5)  [_d]6.agegroup = 0

           chi2(  5) =12490.06
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.agegroup = 0
 ( 2)  [_d]2.agegroup = 0
 ( 3)  [_d]4.agegroup = 0
 ( 4)  [_d]5.agegroup = 0
 ( 5)  [_d]6.agegroup = 0

           chi2(  5) =60138.36
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.agegroup = 0
 ( 2)  [_d]2.agegroup = 0
 ( 3)  [_d]4.agegroup = 0
 ( 4)  [_d]5.agegroup = 0
 ( 5)  [_d]6.agegroup = 0

           chi2(  5) =12490.06
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.agegroup = 0
 ( 2)  [_d]2.agegroup = 0
 ( 3)  [_d]4.agegroup = 0
 ( 4)  [_d]5.agegroup = 0
 ( 5)  [_d]6.agegroup = 0

           chi2(  5) =60138.36
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.agegroup = 0
 ( 2)  [_d]2.agegroup = 0
 ( 3)  [_d]4.agegroup = 0
 ( 4)  [_d]5.agegroup = 0
 ( 5)  [_d]6.agegroup = 0

           chi2(  5) =12490.06
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.agegroup = 0
 ( 2)  [_d]2.agegroup = 0
 ( 3)  [_d]4.agegroup = 0
 ( 4)  [_d]5.agegroup = 0
 ( 5)  [_d]6.agegroup = 0

           chi2(  5) =60138.36
         Prob > chi2 =    0.0000

. file write tablecontents _n 

. 
. *Sex 
. refline

. outputHRsforvar, variable("male") min(1) max(1) 

 ( 1)  [_d]1.male = 0

           chi2(  1) =  547.40
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.male = 0

           chi2(  1) =   82.61
         Prob > chi2 =    0.0000

. file write tablecontents _n

. 
. *BMI
. refline

. outputHRsforvar, variable("obese4cat") min(2) max(4) 

 ( 1)  [_d]2.obese4cat = 0
 ( 2)  [_d]3.obese4cat = 0
 ( 3)  [_d]4.obese4cat = 0

           chi2(  3) =  234.23
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.obese4cat = 0
 ( 2)  [_d]3.obese4cat = 0
 ( 3)  [_d]4.obese4cat = 0

           chi2(  3) =  845.48
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.obese4cat = 0
 ( 2)  [_d]3.obese4cat = 0
 ( 3)  [_d]4.obese4cat = 0

           chi2(  3) =  234.23
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.obese4cat = 0
 ( 2)  [_d]3.obese4cat = 0
 ( 3)  [_d]4.obese4cat = 0

           chi2(  3) =  845.48
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.obese4cat = 0
 ( 2)  [_d]3.obese4cat = 0
 ( 3)  [_d]4.obese4cat = 0

           chi2(  3) =  234.23
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.obese4cat = 0
 ( 2)  [_d]3.obese4cat = 0
 ( 3)  [_d]4.obese4cat = 0

           chi2(  3) =  845.48
         Prob > chi2 =    0.0000

. file write tablecontents _n

. 
. *Smoking
. refline

. outputHRsforvar, variable("smoke_nomiss") min(2) max(3) 

 ( 1)  [_d]2.smoke_nomiss = 0
 ( 2)  [_d]3.smoke_nomiss = 0

           chi2(  2) =   85.76
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.smoke_nomiss = 0
 ( 2)  [_d]3.smoke_nomiss = 0

           chi2(  2) = 2902.78
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.smoke_nomiss = 0
 ( 2)  [_d]3.smoke_nomiss = 0

           chi2(  2) =   85.76
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.smoke_nomiss = 0
 ( 2)  [_d]3.smoke_nomiss = 0

           chi2(  2) = 2902.78
         Prob > chi2 =    0.0000

. file write tablecontents _n

. 
. *Ethnicity
. refline

. outputHRsforvar, variable("ethnicity") min(2) max(5) 

 ( 1)  [_d]2.ethnicity = 0
 ( 2)  [_d]3.ethnicity = 0
 ( 3)  [_d]4.ethnicity = 0
 ( 4)  [_d]5.ethnicity = 0

           chi2(  4) =  260.57
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.ethnicity = 0
 ( 2)  [_d]3.ethnicity = 0
 ( 3)  [_d]4.ethnicity = 0
 ( 4)  [_d]5.ethnicity = 0

           chi2(  4) =  222.83
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.ethnicity = 0
 ( 2)  [_d]3.ethnicity = 0
 ( 3)  [_d]4.ethnicity = 0
 ( 4)  [_d]5.ethnicity = 0

           chi2(  4) =  260.57
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.ethnicity = 0
 ( 2)  [_d]3.ethnicity = 0
 ( 3)  [_d]4.ethnicity = 0
 ( 4)  [_d]5.ethnicity = 0

           chi2(  4) =  222.83
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.ethnicity = 0
 ( 2)  [_d]3.ethnicity = 0
 ( 3)  [_d]4.ethnicity = 0
 ( 4)  [_d]5.ethnicity = 0

           chi2(  4) =  260.57
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.ethnicity = 0
 ( 2)  [_d]3.ethnicity = 0
 ( 3)  [_d]4.ethnicity = 0
 ( 4)  [_d]5.ethnicity = 0

           chi2(  4) =  222.83
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.ethnicity = 0
 ( 2)  [_d]3.ethnicity = 0
 ( 3)  [_d]4.ethnicity = 0
 ( 4)  [_d]5.ethnicity = 0

           chi2(  4) =  260.57
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.ethnicity = 0
 ( 2)  [_d]3.ethnicity = 0
 ( 3)  [_d]4.ethnicity = 0
 ( 4)  [_d]5.ethnicity = 0

           chi2(  4) =  222.83
         Prob > chi2 =    0.0000

. file write tablecontents _n

. 
. *IMD
. refline

. outputHRsforvar, variable("imd") min(2) max(5) 

 ( 1)  [_d]2.imd = 0
 ( 2)  [_d]3.imd = 0
 ( 3)  [_d]4.imd = 0
 ( 4)  [_d]5.imd = 0

           chi2(  4) =  795.97
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.imd = 0
 ( 2)  [_d]3.imd = 0
 ( 3)  [_d]4.imd = 0
 ( 4)  [_d]5.imd = 0

           chi2(  4) = 1236.24
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.imd = 0
 ( 2)  [_d]3.imd = 0
 ( 3)  [_d]4.imd = 0
 ( 4)  [_d]5.imd = 0

           chi2(  4) =  795.97
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.imd = 0
 ( 2)  [_d]3.imd = 0
 ( 3)  [_d]4.imd = 0
 ( 4)  [_d]5.imd = 0

           chi2(  4) = 1236.24
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.imd = 0
 ( 2)  [_d]3.imd = 0
 ( 3)  [_d]4.imd = 0
 ( 4)  [_d]5.imd = 0

           chi2(  4) =  795.97
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.imd = 0
 ( 2)  [_d]3.imd = 0
 ( 3)  [_d]4.imd = 0
 ( 4)  [_d]5.imd = 0

           chi2(  4) = 1236.24
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.imd = 0
 ( 2)  [_d]3.imd = 0
 ( 3)  [_d]4.imd = 0
 ( 4)  [_d]5.imd = 0

           chi2(  4) =  795.97
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.imd = 0
 ( 2)  [_d]3.imd = 0
 ( 3)  [_d]4.imd = 0
 ( 4)  [_d]5.imd = 0

           chi2(  4) = 1236.24
         Prob > chi2 =    0.0000

. file write tablecontents _n 

. 
. *BP/hypertension
. refline

. outputHRsforvar, variable("htdiag_or_highbp") min(1) max(1) 

 ( 1)  [_d]1.htdiag_or_highbp = 0

           chi2(  1) =   30.35
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.htdiag_or_highbp = 0

           chi2(  1) =   23.13
         Prob > chi2 =    0.0000

. file write tablecontents _n

. outputHRsforvar, variable("chronic_respiratory_disease") min(1) max(1) 

 ( 1)  [_d]1.chronic_respiratory_disease = 0

           chi2(  1) =  510.84
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.chronic_respiratory_disease = 0

           chi2(  1) = 3895.87
         Prob > chi2 =    0.0000

. file write tablecontents _n                     

. outputHRsforvar, variable("asthmacat") min(2) max(3)                    

 ( 1)  [_d]2.asthmacat = 0
 ( 2)  [_d]3.asthmacat = 0

           chi2(  2) =    6.31
         Prob > chi2 =    0.0427

 ( 1)  [_d]2.asthmacat = 0
 ( 2)  [_d]3.asthmacat = 0

           chi2(  2) =   61.33
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.asthmacat = 0
 ( 2)  [_d]3.asthmacat = 0

           chi2(  2) =    6.31
         Prob > chi2 =    0.0427

 ( 1)  [_d]2.asthmacat = 0
 ( 2)  [_d]3.asthmacat = 0

           chi2(  2) =   61.33
         Prob > chi2 =    0.0000

. outputHRsforvar, variable("chronic_cardiac_disease") min(1) max(1) 

 ( 1)  [_d]1.chronic_cardiac_disease = 0

           chi2(  1) =   86.74
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.chronic_cardiac_disease = 0

           chi2(  1) = 1768.76
         Prob > chi2 =    0.0000

. file write tablecontents _n     

. outputHRsforvar, variable("diabcat") min(2) max(4) 

 ( 1)  [_d]2.diabcat = 0
 ( 2)  [_d]3.diabcat = 0
 ( 3)  [_d]4.diabcat = 0

           chi2(  3) =  830.11
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.diabcat = 0
 ( 2)  [_d]3.diabcat = 0
 ( 3)  [_d]4.diabcat = 0

           chi2(  3) = 1512.51
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.diabcat = 0
 ( 2)  [_d]3.diabcat = 0
 ( 3)  [_d]4.diabcat = 0

           chi2(  3) =  830.11
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.diabcat = 0
 ( 2)  [_d]3.diabcat = 0
 ( 3)  [_d]4.diabcat = 0

           chi2(  3) = 1512.51
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.diabcat = 0
 ( 2)  [_d]3.diabcat = 0
 ( 3)  [_d]4.diabcat = 0

           chi2(  3) =  830.11
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.diabcat = 0
 ( 2)  [_d]3.diabcat = 0
 ( 3)  [_d]4.diabcat = 0

           chi2(  3) = 1512.51
         Prob > chi2 =    0.0000

. file write tablecontents _n             

. outputHRsforvar, variable("cancer_exhaem_cat") min(2) max(4) 

 ( 1)  [_d]2.cancer_exhaem_cat = 0
 ( 2)  [_d]3.cancer_exhaem_cat = 0
 ( 3)  [_d]4.cancer_exhaem_cat = 0

           chi2(  3) =   99.93
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.cancer_exhaem_cat = 0
 ( 2)  [_d]3.cancer_exhaem_cat = 0
 ( 3)  [_d]4.cancer_exhaem_cat = 0

           chi2(  3) =32370.68
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.cancer_exhaem_cat = 0
 ( 2)  [_d]3.cancer_exhaem_cat = 0
 ( 3)  [_d]4.cancer_exhaem_cat = 0

           chi2(  3) =   99.93
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.cancer_exhaem_cat = 0
 ( 2)  [_d]3.cancer_exhaem_cat = 0
 ( 3)  [_d]4.cancer_exhaem_cat = 0

           chi2(  3) =32370.68
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.cancer_exhaem_cat = 0
 ( 2)  [_d]3.cancer_exhaem_cat = 0
 ( 3)  [_d]4.cancer_exhaem_cat = 0

           chi2(  3) =   99.93
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.cancer_exhaem_cat = 0
 ( 2)  [_d]3.cancer_exhaem_cat = 0
 ( 3)  [_d]4.cancer_exhaem_cat = 0

           chi2(  3) =32370.68
         Prob > chi2 =    0.0000

. file write tablecontents _n             

. outputHRsforvar, variable("cancer_haem_cat") min(2) max(4)              

 ( 1)  [_d]2.cancer_haem_cat = 0
 ( 2)  [_d]3.cancer_haem_cat = 0
 ( 3)  [_d]4.cancer_haem_cat = 0

           chi2(  3) =  226.69
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.cancer_haem_cat = 0
 ( 2)  [_d]3.cancer_haem_cat = 0
 ( 3)  [_d]4.cancer_haem_cat = 0

           chi2(  3) = 2099.42
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.cancer_haem_cat = 0
 ( 2)  [_d]3.cancer_haem_cat = 0
 ( 3)  [_d]4.cancer_haem_cat = 0

           chi2(  3) =  226.69
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.cancer_haem_cat = 0
 ( 2)  [_d]3.cancer_haem_cat = 0
 ( 3)  [_d]4.cancer_haem_cat = 0

           chi2(  3) = 2099.42
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.cancer_haem_cat = 0
 ( 2)  [_d]3.cancer_haem_cat = 0
 ( 3)  [_d]4.cancer_haem_cat = 0

           chi2(  3) =  226.69
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.cancer_haem_cat = 0
 ( 2)  [_d]3.cancer_haem_cat = 0
 ( 3)  [_d]4.cancer_haem_cat = 0

           chi2(  3) = 2099.42
         Prob > chi2 =    0.0000

. file write tablecontents _n

. outputHRsforvar, variable("reduced_kidney_function_cat") min(2) max(3)          

 ( 1)  [_d]2.reduced_kidney_function_cat = 0
 ( 2)  [_d]3.reduced_kidney_function_cat = 0

           chi2(  2) =  677.12
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.reduced_kidney_function_cat = 0
 ( 2)  [_d]3.reduced_kidney_function_cat = 0

           chi2(  2) = 3802.39
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.reduced_kidney_function_cat = 0
 ( 2)  [_d]3.reduced_kidney_function_cat = 0

           chi2(  2) =  677.12
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.reduced_kidney_function_cat = 0
 ( 2)  [_d]3.reduced_kidney_function_cat = 0

           chi2(  2) = 3802.39
         Prob > chi2 =    0.0000

. outputHRsforvar, variable("chronic_liver_disease") min(1) max(1)                        

 ( 1)  [_d]1.chronic_liver_disease = 0

           chi2(  1) =  104.48
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.chronic_liver_disease = 0

           chi2(  1) = 2728.60
         Prob > chi2 =    0.0000

. outputHRsforvar, variable("stroke_dementia") min(1) max(1)      

 ( 1)  [_d]1.stroke_dementia = 0

           chi2(  1) = 1362.24
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.stroke_dementia = 0

           chi2(  1) = 3672.59
         Prob > chi2 =    0.0000

. outputHRsforvar, variable("other_neuro") min(1) max(1)          

 ( 1)  [_d]1.other_neuro = 0

           chi2(  1) =  877.83
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.other_neuro = 0

           chi2(  1) = 3019.15
         Prob > chi2 =    0.0000

. outputHRsforvar, variable("organ_transplant") min(1) max(1)                     

 ( 1)  [_d]1.organ_transplant = 0

           chi2(  1) =  112.16
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.organ_transplant = 0

           chi2(  1) =   97.03
         Prob > chi2 =    0.0000

. outputHRsforvar, variable("spleen") min(1) max(1) 

 ( 1)  [_d]1.spleen = 0

           chi2(  1) =    1.20
         Prob > chi2 =    0.2737

 ( 1)  [_d]1.spleen = 0

           chi2(  1) =   68.81
         Prob > chi2 =    0.0000

. outputHRsforvar, variable("ra_sle_psoriasis") min(1) max(1) 

 ( 1)  [_d]1.ra_sle_psoriasis = 0

           chi2(  1) =   40.20
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.ra_sle_psoriasis = 0

           chi2(  1) =   62.11
         Prob > chi2 =    0.0000

. outputHRsforvar, variable("other_immunosuppression") min(1) max(1) 

 ( 1)  [_d]1.other_immunosuppression = 0

           chi2(  1) =   46.37
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.other_immunosuppression = 0

           chi2(  1) =  254.73
         Prob > chi2 =    0.0000

. 
. 
. file close tablecontents

. 
. postclose HRestimates

. 
. use `HRestimates', clear

. 
. gen varorder = 1 

. local i=2

. foreach var of any male obese4cat smoke_nomiss ethnicity imd  diabcat ///
>         cancer_exhaem_cat cancer_haem_cat reduced_kidney_function_cat asthmacat chronic_respiratory_disease ///
>         chronic_cardiac_disease htdiag_or_highbp chronic_liver_disease ///
>         stroke_dementia other_neuro organ_transplant ///
>         spleen ra_sle_psoriasis other_immunosuppression {
  2. replace varorder = `i' if variable=="`var'"
  3. local i=`i'+1
  4. }
(2 real changes made)
(6 real changes made)
(4 real changes made)
(8 real changes made)
(8 real changes made)
(6 real changes made)
(6 real changes made)
(6 real changes made)
(4 real changes made)
(4 real changes made)
(2 real changes made)
(2 real changes made)
(2 real changes made)
(2 real changes made)
(2 real changes made)
(2 real changes made)
(2 real changes made)
(2 real changes made)
(2 real changes made)
(2 real changes made)

. sort varorder outcome level

. drop varorder

. 
. gen obsorder=_n

. expand 2 if variable!=variable[_n-1] | outcome!=outcome[_n-1], gen(expanded)
(42 observations created)

. for var hr lci uci: replace X = 1 if expanded==1

->  replace hr = 1 if expanded==1
(42 real changes made)

->  replace lci = 1 if expanded==1
(42 real changes made)

->  replace uci = 1 if expanded==1
(42 real changes made)

. 
. sort obsorder

. drop obsorder

. replace level = 0 if expanded == 1
(42 real changes made)

. replace level = 1 if expanded == 1 & (variable=="obese4cat"|variable=="smoke_nomiss"|variable=="ethnicity"|variable=="imd"|variable=="asthmacat"|variable=="diabcat"|substr(variable,1,6)=="cancer"|variab
> le=="reduced_kidney_function_cat"|variable=="agegroup")
(20 real changes made)

. replace level = 3 if expanded == 1 & variable=="agegroup"
(2 real changes made)

. 
. gen varorder = 1 if variable!=variable[_n-1]
(105 missing values generated)

. replace varorder = sum(varorder)
(125 real changes made)

. sort varorder outcome level

. 
. 
. drop expanded

. expand 2 if variable!=variable[_n-1] | outcome!=outcome[_n-1], gen(expanded)
(42 observations created)

. replace level = -1 if expanded==1
(42 real changes made)

. drop expanded

. *expand 3 if variable=="htdiag_or_highbp" & level==-1, gen(expanded)
. *replace level = -99 if variable=="htdiag_or_highbp" & expanded==1
. expand 2 if level == -1, gen(expanded)
(42 observations created)

. replace level = -99 if expanded==1
(42 real changes made)

. 
. for var hr lci uci pval : replace X=. if level<0

->  replace hr=. if level<0
(84 real changes made, 84 to missing)

->  replace lci=. if level<0
(84 real changes made, 84 to missing)

->  replace uci=. if level<0
(84 real changes made, 84 to missing)

->  replace pval=. if level<0
(84 real changes made, 84 to missing)

. sort varorder outcome  level

. 
. gen varx = 0.07

. gen levelx = 0.071

. gen lowerlimit = 0.15

. 
. *Names
. gen Name = variable if (level==-1&!(level[_n+1]==0&variable!="male"))|(level==1&level[_n-1]==0&variable!="male")
(168 missing values generated)

. replace Name = subinstr(Name, "_", " ", 10)
(26 real changes made)

. replace Name = upper(substr(Name,1,1)) + substr(Name,2,.)
(42 real changes made)

. replace Name = "Age group" if Name=="Agegroup"
(2 real changes made)

. replace Name = "Sex" if Name=="Male"
(2 real changes made)

. replace Name = "Obesity" if Name=="Obese4cat"
(2 real changes made)

. replace Name = "Smoking status" if Name=="Smoke nomiss"
(2 real changes made)

. replace Name = "Deprivation (IMD) quintile" if Name=="Imd"
(2 real changes made)

. replace Name = "Hypertension/high bp" if Name=="Htdiag or highbp"
(2 real changes made)

. replace Name = "Asthma" if Name=="Asthmacat"
(2 real changes made)

. replace Name = "Diabetes" if Name=="Diabcat"
(2 real changes made)

. replace Name = "Cancer (non-haematological)" if Name=="Cancer exhaem cat"
(2 real changes made)

. replace Name = "Haematological malignancy" if Name=="Cancer haem cat"
(2 real changes made)

. replace Name = "Stroke or dementia" if Name=="Stroke dementia"
(2 real changes made)

. replace Name = "Other neurological" if Name=="Other neuro"
(2 real changes made)

. replace Name = "Rheumatoid arthritis/Lupus/Psoriasis" if Name=="Ra sle psoriasis"
variable Name was str27 now str36
(2 real changes made)

. replace Name = "Reduced kidney function" if Name=="Reduced kidney function cat"
(2 real changes made)

. replace Name = "Asplenia" if Name=="Spleen"
(2 real changes made)

. 
. *Levels
. gen leveldesc = ""
(210 missing values generated)

. replace leveldesc = "18-39" if variable=="agegroup" & level==1
variable leveldesc was str1 now str5
(2 real changes made)

. replace leveldesc = "40-49" if variable=="agegroup" & level==2
(2 real changes made)

. replace leveldesc = "50-59 (ref)" if variable=="agegroup" & level==3
variable leveldesc was str5 now str11
(2 real changes made)

. replace leveldesc = "60-69" if variable=="agegroup" & level==4
(2 real changes made)

. replace leveldesc = "70-79" if variable=="agegroup" & level==5
(2 real changes made)

. replace leveldesc = "80+" if variable=="agegroup" & level==6
(2 real changes made)

. 
. replace leveldesc = "Female (ref)" if variable=="male" & level==0
variable leveldesc was str11 now str12
(2 real changes made)

. replace leveldesc = "Male" if variable=="male" & level==1
(2 real changes made)

. 
. replace leveldesc = "Not obese (ref)" if variable=="obese4cat" & level==1
variable leveldesc was str12 now str15
(2 real changes made)

. replace leveldesc = "Obese class I" if variable=="obese4cat" & level==2
(2 real changes made)

. replace leveldesc = "Obese class II" if variable=="obese4cat" & level==3
(2 real changes made)

. replace leveldesc = "Obese class III" if variable=="obese4cat" & level==4
(2 real changes made)

. 
. replace leveldesc = "Never (ref)" if variable=="smoke_nomiss" & level==1
(2 real changes made)

. replace leveldesc = "Ex-smoker" if variable=="smoke_nomiss" & level==2
(2 real changes made)

. replace leveldesc = "Current" if variable=="smoke_nomiss" & level==3
(2 real changes made)

. 
. replace leveldesc = "White (ref)" if variable=="ethnicity" & level==1
(2 real changes made)

. replace leveldesc = "Mixed" if variable=="ethnicity" & level==2
(2 real changes made)

. replace leveldesc = "Asian/Asian British" if variable=="ethnicity" & level==3
variable leveldesc was str15 now str19
(2 real changes made)

. replace leveldesc = "Black" if variable=="ethnicity" & level==4
(2 real changes made)

. replace leveldesc = "Other" if variable=="ethnicity" & level==5
(2 real changes made)

. 
. replace leveldesc = "1 (least deprived, ref)" if variable=="imd" & level==1
variable leveldesc was str19 now str23
(2 real changes made)

. replace leveldesc = "2" if variable=="imd" & level==2
(2 real changes made)

. replace leveldesc = "3" if variable=="imd" & level==3
(2 real changes made)

. replace leveldesc = "4" if variable=="imd" & level==4
(2 real changes made)

. replace leveldesc = "5 (most deprived)" if variable=="imd" & level==5
(2 real changes made)

. 
. replace leveldesc = "No diabetes (ref)" if variable=="diabcat" & level==1
(2 real changes made)

. replace leveldesc = "Controlled (HbA1c <58mmol/mol)" if variable=="diabcat" & level==2
variable leveldesc was str23 now str30
(2 real changes made)

. replace leveldesc = "Uncontrolled (HbA1c >=58mmol/mol) " if variable=="diabcat" & level==3
variable leveldesc was str30 now str34
(2 real changes made)

. replace leveldesc = "Unknown HbA1c" if variable=="diabcat" & level==4
(2 real changes made)

. 
. replace leveldesc = "No asthma (ref)" if variable=="asthmacat" & level==1
(2 real changes made)

. replace leveldesc = "With no recent OCS use" if variable=="asthmacat" & level==2
(2 real changes made)

. replace leveldesc = "With recent OCS use" if variable=="asthmacat" & level==3
(2 real changes made)

. 
. replace leveldesc = "Never (ref)" if substr(variable,1,6)=="cancer" & level==1
(4 real changes made)

. replace leveldesc = "<1 year ago" if substr(variable,1,6)=="cancer" & level==2
(4 real changes made)

. replace leveldesc = "1-4.9 years ago" if substr(variable,1,6)=="cancer" & level==3
(4 real changes made)

. replace leveldesc = "5+ years ago" if substr(variable,1,6)=="cancer" & level==4
(4 real changes made)

. 
. replace leveldesc = "None (ref)" if variable=="reduced_kidney_function_cat" & level==1
(2 real changes made)

. replace leveldesc = "eGFR 30-60 ml/min/1.73m2" if variable=="reduced_kidney_function_cat" & level==2
(2 real changes made)

. replace leveldesc = "eGFR <30 ml/min/1.73m2" if variable=="reduced_kidney_function_cat" & level==3
(2 real changes made)

. 
. 
. *replace leveldesc = "Absent" if level==0
. *replace leveldesc = "Present" if level==1 & leveldesc==""
. drop if level==0 & variable!="male"
(20 observations deleted)

. 
. 
. gen obsorder=_n

. gsort -obsorder

. gen graphorder = _n

. sort obsorder

. 
. *merge 1:1 variable level using c:\statatemp\tptemp, update replace
. 
. gen displayhrci = "<<< HR = " + string(hr, "%3.2f") + " (" + string(lci, "%3.2f") + "-" + string(uci, "%3.2f") + ")" if lci<0.15
(188 missing values generated)

. 
. scatter graphorder hr if lci>=.15 & outcome=="COV", mcol(red)   msize(small)            ///                                                                             ///
>         || rcap lci uci graphorder if lci>=.15 & outcome=="COV", hor mcol(red)  lcol(red)                       ///
>         || scatter graphorder hr if lci>=.15 & outcome=="NONCOV", mcol(black)   msize(small)            ///                                                                             ///
>         || rcap lci uci graphorder if lci>=.15 & outcome=="NONCOV", hor mcol(black)     lcol(black)                     ///
>         || scatter graphorder lowerlimit, m(i) mlab(displayhrci) mlabcol(black) mlabsize(tiny) ///
>         || scatter graphorder varx if outcome=="COV", m(i) mlab(Name) mlabsize(tiny) mlabcol(black)     ///
>         || scatter graphorder levelx if outcome=="COV", m(i) mlab(leveldesc) mlabsize(tiny) mlabcol(gs8)        ///
>                 xline(1,lp(dash))                                                                                                                       ///
>                 xscale(log) xlab(0.25 0.5 1 2 5 10) xtitle("Odds Ratio & 95% CI") ylab(none) ytitle("")                                         /// 
>                 yscale(r(100)) ysize(12)   legend(order(1 3) label(1 "COVID deaths") label(3 "Non-COVID deaths"))

.                 
. 
. graph export ./output/an_table_covidvsnoncovid_full.svg, as(svg) replace
(note: file ./output/an_table_covidvsnoncovid_full.svg not found)
(file ./output/an_table_covidvsnoncovid_full.svg written in SVG format)

. 
end of do-file

. do "E:\analyses\covid-vs-noncovid-deaths-research\analysis\an_table_noncovid20192020_agesex.do"

. 
. *Coding: Krishnan Bhaskaran
. *
. *Date drafted: 20/9/2020
. *************************************************************************
. 
. 
. ***********************************************************************************************************************
. *Generic code to ouput the HRs across outcomes for all levels of a particular variables, in the right shape for table
. cap prog drop outputHRsforvar

. prog define outputHRsforvar
  1. syntax, variable(string) min(real) max(real) 
  2. forvalues i=`min'/`max'{
  3. local endwith "_tab"
  4. 
.         *put the varname and condition to left so that alignment can be checked vs shell
.         file write tablecontents ("`variable'") _tab ("`i'") _tab
  5.         
.         foreach year of numlist 2019 {
  6.         
.                 local noestimatesflag 0 /*reset*/
  7. 
. *CHANGE THE OUTCOME BELOW TO LAST IF BRINGING IN MORE COLS
.                 /*if `year'==2020*/ local endwith "_n"
  8. 
.                 ***********************
.                 *1) GET THE RIGHT ESTIMATES INTO MEMORY
. 
.                 
. 
.                 *FOR AGEGROUP - need to use the separate univariate/multivariate model fitted with age group rather than spline
.                 *FOR ETHNICITY - use the separate complete case multivariate model
.                 *FOR REST - use the "main" multivariate model
.                 if "`variable'"=="agegroup" {
  9.                                 cap estimates use ./output/models/an_noncovid_`year'_agesex_AGEGROUP
 10.                                 if _rc!=0 local noestimatesflag 1
 11.                                 }
 12.                 else {
 13.                                 cap estimates use ./output/models/an_noncovid_`year'_agesex_`variable'
 14.                                 if _rc!=0 local noestimatesflag 1
 15.                                 }
 16.                 
.                 ***********************
.                 *2) WRITE THE HRs TO THE OUTPUT FILE
.                 
.                 if `noestimatesflag'==0{
 17.                         cap lincom `i'.`variable', eform
 18.                         if _rc==0 file write tablecontents %4.2f (r(estimate)) (" (") %4.2f (r(lb)) ("-") %4.2f (r(ub)) (")") `endwith'
 19.                                 else file write tablecontents %4.2f ("ERR IN MODEL") `endwith'
 20.                         }
 21.                         else file write tablecontents %4.2f ("DID NOT FIT") `endwith' 
 22.                         
.                 *3) Save the estimates for plotting
.                 if `noestimatesflag'==0{
 23.                                 local hr = r(estimate)
 24.                                 local lb = r(lb)
 25.                                 local ub = r(ub)
 26.                                 cap gen `variable'=.
 27.                                 testparm i.`variable'
 28.                                 post HRestimates (string(`year')) ("`variable'") (`i') (`hr') (`lb') (`ub') (r(p))
 29.                                 drop `variable'
 30.                                 }       
 31.                 } /*failn 1 2 */
 32.                 
. } /*variable levels*/
 33. 
. end

. ***********************************************************************************************************************
. *Generic code to write a full row of "ref category" to the output file
. cap prog drop refline

. prog define refline
  1. file write tablecontents _tab _tab ("1.00 (ref)") _tab ("1.00 (ref)")  _n
  2. *post HRestimates ("`outcome'") ("`variable'") (`refcat') (1) (1) (1) (.)
. end

. ***********************************************************************************************************************
. 
. *MAIN CODE TO PRODUCE TABLE CONTENTS
. 
. cap file close tablecontents

. file open tablecontents using ./output/an_table_noncovid20192020_agesex.txt, t w replace 
(note: file ./output/an_table_noncovid20192020_agesex.txt not found)

. 
. tempfile HRestimates

. cap postutil clear

. postfile HRestimates str6 year str27 variable level hr lci uci pval using `HRestimates'

. 
. *Age group
. outputHRsforvar, variable("agegroup") min(1) max(2) 

 ( 1)  [_d]2.agegroup = 0
 ( 2)  [_d]3.agegroup = 0
 ( 3)  [_d]4.agegroup = 0
 ( 4)  [_d]5.agegroup = 0
 ( 5)  [_d]6.agegroup = 0

           chi2(  5) = 1.1e+05
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.agegroup = 0
 ( 2)  [_d]3.agegroup = 0
 ( 3)  [_d]4.agegroup = 0
 ( 4)  [_d]5.agegroup = 0
 ( 5)  [_d]6.agegroup = 0

           chi2(  5) = 1.1e+05
         Prob > chi2 =    0.0000

. refline

. outputHRsforvar, variable("agegroup") min(4) max(6) 

 ( 1)  [_d]2.agegroup = 0
 ( 2)  [_d]3.agegroup = 0
 ( 3)  [_d]4.agegroup = 0
 ( 4)  [_d]5.agegroup = 0
 ( 5)  [_d]6.agegroup = 0

           chi2(  5) = 1.1e+05
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.agegroup = 0
 ( 2)  [_d]3.agegroup = 0
 ( 3)  [_d]4.agegroup = 0
 ( 4)  [_d]5.agegroup = 0
 ( 5)  [_d]6.agegroup = 0

           chi2(  5) = 1.1e+05
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.agegroup = 0
 ( 2)  [_d]3.agegroup = 0
 ( 3)  [_d]4.agegroup = 0
 ( 4)  [_d]5.agegroup = 0
 ( 5)  [_d]6.agegroup = 0

           chi2(  5) = 1.1e+05
         Prob > chi2 =    0.0000

. file write tablecontents _n 

. 
. *Sex 
. refline

. outputHRsforvar, variable("male") min(1) max(1) 

. file write tablecontents _n

. 
. *BMI
. refline

. outputHRsforvar, variable("obese4cat") min(2) max(4) 

 ( 1)  [_d]2.obese4cat = 0
 ( 2)  [_d]3.obese4cat = 0
 ( 3)  [_d]4.obese4cat = 0

           chi2(  3) =  503.75
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.obese4cat = 0
 ( 2)  [_d]3.obese4cat = 0
 ( 3)  [_d]4.obese4cat = 0

           chi2(  3) =  503.75
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.obese4cat = 0
 ( 2)  [_d]3.obese4cat = 0
 ( 3)  [_d]4.obese4cat = 0

           chi2(  3) =  503.75
         Prob > chi2 =    0.0000

. file write tablecontents _n

. 
. *Smoking
. refline

. outputHRsforvar, variable("smoke_nomiss") min(2) max(3) 

 ( 1)  [_d]2.smoke_nomiss = 0
 ( 2)  [_d]3.smoke_nomiss = 0

           chi2(  2) = 6036.48
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.smoke_nomiss = 0
 ( 2)  [_d]3.smoke_nomiss = 0

           chi2(  2) = 6036.48
         Prob > chi2 =    0.0000

. file write tablecontents _n

. 
. *Ethnicity
. refline

. outputHRsforvar, variable("ethnicity") min(2) max(5) 

 ( 1)  [_d]2.ethnicity = 0
 ( 2)  [_d]3.ethnicity = 0
 ( 3)  [_d]4.ethnicity = 0
 ( 4)  [_d]5.ethnicity = 0

           chi2(  4) =  220.85
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.ethnicity = 0
 ( 2)  [_d]3.ethnicity = 0
 ( 3)  [_d]4.ethnicity = 0
 ( 4)  [_d]5.ethnicity = 0

           chi2(  4) =  220.85
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.ethnicity = 0
 ( 2)  [_d]3.ethnicity = 0
 ( 3)  [_d]4.ethnicity = 0
 ( 4)  [_d]5.ethnicity = 0

           chi2(  4) =  220.85
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.ethnicity = 0
 ( 2)  [_d]3.ethnicity = 0
 ( 3)  [_d]4.ethnicity = 0
 ( 4)  [_d]5.ethnicity = 0

           chi2(  4) =  220.85
         Prob > chi2 =    0.0000

. file write tablecontents _n

. 
. *IMD
. refline

. outputHRsforvar, variable("imd") min(2) max(5) 

 ( 1)  [_d]2.imd = 0
 ( 2)  [_d]3.imd = 0
 ( 3)  [_d]4.imd = 0
 ( 4)  [_d]5.imd = 0

           chi2(  4) = 2277.08
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.imd = 0
 ( 2)  [_d]3.imd = 0
 ( 3)  [_d]4.imd = 0
 ( 4)  [_d]5.imd = 0

           chi2(  4) = 2277.08
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.imd = 0
 ( 2)  [_d]3.imd = 0
 ( 3)  [_d]4.imd = 0
 ( 4)  [_d]5.imd = 0

           chi2(  4) = 2277.08
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.imd = 0
 ( 2)  [_d]3.imd = 0
 ( 3)  [_d]4.imd = 0
 ( 4)  [_d]5.imd = 0

           chi2(  4) = 2277.08
         Prob > chi2 =    0.0000

. file write tablecontents _n 

. 
. *BP/hypertension
. refline

. outputHRsforvar, variable("htdiag_or_highbp") min(1) max(1) 

 ( 1)  [_d]1.htdiag_or_highbp = 0

           chi2(  1) =    2.33
         Prob > chi2 =    0.1270

. file write tablecontents _n

. outputHRsforvar, variable("chronic_respiratory_disease") min(1) max(1) 

 ( 1)  [_d]1.chronic_respiratory_disease = 0

           chi2(  1) = 9622.29
         Prob > chi2 =    0.0000

. file write tablecontents _n                     

. outputHRsforvar, variable("asthmacat") min(2) max(3)                    

 ( 1)  [_d]2.asthmacat = 0
 ( 2)  [_d]3.asthmacat = 0

           chi2(  2) =   30.36
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.asthmacat = 0
 ( 2)  [_d]3.asthmacat = 0

           chi2(  2) =   30.36
         Prob > chi2 =    0.0000

. outputHRsforvar, variable("chronic_cardiac_disease") min(1) max(1) 

 ( 1)  [_d]1.chronic_cardiac_disease = 0

           chi2(  1) = 5562.85
         Prob > chi2 =    0.0000

. file write tablecontents _n     

. outputHRsforvar, variable("diabcat") min(2) max(4) 

 ( 1)  [_d]2.diabcat = 0
 ( 2)  [_d]3.diabcat = 0
 ( 3)  [_d]4.diabcat = 0

           chi2(  3) =23093.62
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.diabcat = 0
 ( 2)  [_d]3.diabcat = 0
 ( 3)  [_d]4.diabcat = 0

           chi2(  3) =23093.62
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.diabcat = 0
 ( 2)  [_d]3.diabcat = 0
 ( 3)  [_d]4.diabcat = 0

           chi2(  3) =23093.62
         Prob > chi2 =    0.0000

. file write tablecontents _n             

. outputHRsforvar, variable("cancer_exhaem_cat") min(2) max(4) 

 ( 1)  [_d]2.cancer_exhaem_cat = 0
 ( 2)  [_d]3.cancer_exhaem_cat = 0
 ( 3)  [_d]4.cancer_exhaem_cat = 0

           chi2(  3) =33601.09
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.cancer_exhaem_cat = 0
 ( 2)  [_d]3.cancer_exhaem_cat = 0
 ( 3)  [_d]4.cancer_exhaem_cat = 0

           chi2(  3) =33601.09
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.cancer_exhaem_cat = 0
 ( 2)  [_d]3.cancer_exhaem_cat = 0
 ( 3)  [_d]4.cancer_exhaem_cat = 0

           chi2(  3) =33601.09
         Prob > chi2 =    0.0000

. file write tablecontents _n             

. outputHRsforvar, variable("cancer_haem_cat") min(2) max(4)              

 ( 1)  [_d]2.cancer_haem_cat = 0
 ( 2)  [_d]3.cancer_haem_cat = 0
 ( 3)  [_d]4.cancer_haem_cat = 0

           chi2(  3) = 2638.41
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.cancer_haem_cat = 0
 ( 2)  [_d]3.cancer_haem_cat = 0
 ( 3)  [_d]4.cancer_haem_cat = 0

           chi2(  3) = 2638.41
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.cancer_haem_cat = 0
 ( 2)  [_d]3.cancer_haem_cat = 0
 ( 3)  [_d]4.cancer_haem_cat = 0

           chi2(  3) = 2638.41
         Prob > chi2 =    0.0000

. file write tablecontents _n

. outputHRsforvar, variable("reduced_kidney_function_cat") min(2) max(3)          

 ( 1)  [_d]2.reduced_kidney_function_cat = 0
 ( 2)  [_d]3.reduced_kidney_function_cat = 0

           chi2(  2) = 6029.34
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.reduced_kidney_function_cat = 0
 ( 2)  [_d]3.reduced_kidney_function_cat = 0

           chi2(  2) = 6029.34
         Prob > chi2 =    0.0000

. outputHRsforvar, variable("chronic_liver_disease") min(1) max(1)                        

 ( 1)  [_d]1.chronic_liver_disease = 0

           chi2(  1) = 4640.34
         Prob > chi2 =    0.0000

. outputHRsforvar, variable("stroke_dementia") min(1) max(1)      

 ( 1)  [_d]1.stroke_dementia = 0

           chi2(  1) = 5136.00
         Prob > chi2 =    0.0000

. outputHRsforvar, variable("other_neuro") min(1) max(1)          

 ( 1)  [_d]1.other_neuro = 0

           chi2(  1) = 2823.52
         Prob > chi2 =    0.0000

. outputHRsforvar, variable("organ_transplant") min(1) max(1)                     

 ( 1)  [_d]1.organ_transplant = 0

           chi2(  1) =  499.10
         Prob > chi2 =    0.0000

. outputHRsforvar, variable("spleen") min(1) max(1) 

 ( 1)  [_d]1.spleen = 0

           chi2(  1) =  193.66
         Prob > chi2 =    0.0000

. outputHRsforvar, variable("ra_sle_psoriasis") min(1) max(1) 

 ( 1)  [_d]1.ra_sle_psoriasis = 0

           chi2(  1) =  231.03
         Prob > chi2 =    0.0000

. outputHRsforvar, variable("other_immunosuppression") min(1) max(1) 

 ( 1)  [_d]1.other_immunosuppression = 0

           chi2(  1) =  133.80
         Prob > chi2 =    0.0000

. 
. 
. file close tablecontents

. 
. postclose HRestimates

. 
. use `HRestimates', clear

. *replace year ="2019"
. gen varorder = 1 

. local i=2

. foreach var of any male obese4cat smoke_nomiss ethnicity imd  diabcat ///
>         cancer_exhaem_cat cancer_haem_cat reduced_kidney_function_cat asthmacat chronic_respiratory_disease ///
>         chronic_cardiac_disease htdiag_or_highbp chronic_liver_disease ///
>         stroke_dementia other_neuro organ_transplant ///
>         spleen ra_sle_psoriasis other_immunosuppression {
  2. replace varorder = `i' if variable=="`var'"
  3. local i=`i'+1
  4. }
(0 real changes made)
(3 real changes made)
(2 real changes made)
(4 real changes made)
(4 real changes made)
(3 real changes made)
(3 real changes made)
(3 real changes made)
(2 real changes made)
(2 real changes made)
(1 real change made)
(1 real change made)
(1 real change made)
(1 real change made)
(1 real change made)
(1 real change made)
(1 real change made)
(1 real change made)
(1 real change made)
(1 real change made)

. sort varorder year level

. drop varorder

. 
. gen obsorder=_n

. expand 2 if variable!=variable[_n-1] | year!=year[_n-1], gen(expanded)
(20 observations created)

. for var hr lci uci: replace X = 1 if expanded==1

->  replace hr = 1 if expanded==1
(19 real changes made)

->  replace lci = 1 if expanded==1
(20 real changes made)

->  replace uci = 1 if expanded==1
(20 real changes made)

. 
. sort obsorder

. drop obsorder

. replace level = 0 if expanded == 1
(20 real changes made)

. replace level = 1 if expanded == 1 & (variable=="obese4cat"|variable=="smoke_nomiss"|variable=="ethnicity"|variable=="imd"|variable=="asthmacat"|variable=="diabcat"|substr(variable,1,6)=="cancer"|variab
> le=="reduced_kidney_function_cat"|variable=="agegroup")
(10 real changes made)

. replace level = 3 if expanded == 1 & variable=="agegroup"
(1 real change made)

. 
. gen varorder = 1 if variable!=variable[_n-1]
(41 missing values generated)

. replace varorder = sum(varorder)
(60 real changes made)

. sort varorder year level

. 
. 
. drop expanded

. expand 2 if variable!=variable[_n-1] | year!=year[_n-1], gen(expanded)
(20 observations created)

. replace level = -1 if expanded==1
(20 real changes made)

. drop expanded

. *expand 3 if variable=="htdiag_or_highbp" & level==-1, gen(expanded)
. *replace level = -99 if variable=="htdiag_or_highbp" & expanded==1
. expand 2 if level == -1, gen(expanded)
(20 observations created)

. replace level = -99 if expanded==1
(20 real changes made)

. 
. for var hr lci uci pval : replace X=. if level<0

->  replace hr=. if level<0
(40 real changes made, 40 to missing)

->  replace lci=. if level<0
(38 real changes made, 38 to missing)

->  replace uci=. if level<0
(38 real changes made, 38 to missing)

->  replace pval=. if level<0
(40 real changes made, 40 to missing)

. sort varorder year  level

. 
. gen varx = 0.07

. gen levelx = 0.071

. gen lowerlimit = 0.15

. 
. *Names
. gen Name = variable if (level==-1&!(level[_n+1]==0&variable!="male"))|(level==1&level[_n-1]==0&variable!="male")
(81 missing values generated)

. replace Name = subinstr(Name, "_", " ", 10)
(13 real changes made)

. replace Name = upper(substr(Name,1,1)) + substr(Name,2,.)
(20 real changes made)

. replace Name = "Age group" if Name=="Agegroup"
(1 real change made)

. replace Name = "Sex" if Name=="Male"
(0 real changes made)

. replace Name = "Obesity" if Name=="Obese4cat"
(1 real change made)

. replace Name = "Smoking status" if Name=="Smoke nomiss"
(1 real change made)

. replace Name = "Deprivation (IMD) quintile" if Name=="Imd"
(1 real change made)

. replace Name = "Hypertension/high bp" if Name=="Htdiag or highbp"
(1 real change made)

. replace Name = "Asthma" if Name=="Asthmacat"
(1 real change made)

. replace Name = "Diabetes" if Name=="Diabcat"
(1 real change made)

. replace Name = "Cancer (non-haematological)" if Name=="Cancer exhaem cat"
(1 real change made)

. replace Name = "Haematological malignancy" if Name=="Cancer haem cat"
(1 real change made)

. replace Name = "Stroke or dementia" if Name=="Stroke dementia"
(1 real change made)

. replace Name = "Other neurological" if Name=="Other neuro"
(1 real change made)

. replace Name = "Rheumatoid arthritis/Lupus/Psoriasis" if Name=="Ra sle psoriasis"
variable Name was str27 now str36
(1 real change made)

. replace Name = "Reduced kidney function" if Name=="Reduced kidney function cat"
(1 real change made)

. replace Name = "Asplenia" if Name=="Spleen"
(1 real change made)

. 
. *Levels
. gen leveldesc = ""
(101 missing values generated)

. replace leveldesc = "18-39" if variable=="agegroup" & level==1
variable leveldesc was str1 now str5
(1 real change made)

. replace leveldesc = "40-49" if variable=="agegroup" & level==2
(1 real change made)

. replace leveldesc = "50-59 (ref)" if variable=="agegroup" & level==3
variable leveldesc was str5 now str11
(1 real change made)

. replace leveldesc = "60-69" if variable=="agegroup" & level==4
(1 real change made)

. replace leveldesc = "70-79" if variable=="agegroup" & level==5
(1 real change made)

. replace leveldesc = "80+" if variable=="agegroup" & level==6
(1 real change made)

. 
. replace leveldesc = "Female (ref)" if variable=="male" & level==0
(0 real changes made)

. replace leveldesc = "Male" if variable=="male" & level==1
(0 real changes made)

. 
. replace leveldesc = "Not obese (ref)" if variable=="obese4cat" & level==1
variable leveldesc was str11 now str15
(1 real change made)

. replace leveldesc = "Obese class I" if variable=="obese4cat" & level==2
(1 real change made)

. replace leveldesc = "Obese class II" if variable=="obese4cat" & level==3
(1 real change made)

. replace leveldesc = "Obese class III" if variable=="obese4cat" & level==4
(1 real change made)

. 
. replace leveldesc = "Never (ref)" if variable=="smoke_nomiss" & level==1
(1 real change made)

. replace leveldesc = "Ex-smoker" if variable=="smoke_nomiss" & level==2
(1 real change made)

. replace leveldesc = "Current" if variable=="smoke_nomiss" & level==3
(1 real change made)

. 
. replace leveldesc = "White (ref)" if variable=="ethnicity" & level==1
(1 real change made)

. replace leveldesc = "Mixed" if variable=="ethnicity" & level==2
(1 real change made)

. replace leveldesc = "Asian/Asian British" if variable=="ethnicity" & level==3
variable leveldesc was str15 now str19
(1 real change made)

. replace leveldesc = "Black" if variable=="ethnicity" & level==4
(1 real change made)

. replace leveldesc = "Other" if variable=="ethnicity" & level==5
(1 real change made)

. 
. replace leveldesc = "1 (least deprived, ref)" if variable=="imd" & level==1
variable leveldesc was str19 now str23
(1 real change made)

. replace leveldesc = "2" if variable=="imd" & level==2
(1 real change made)

. replace leveldesc = "3" if variable=="imd" & level==3
(1 real change made)

. replace leveldesc = "4" if variable=="imd" & level==4
(1 real change made)

. replace leveldesc = "5 (most deprived)" if variable=="imd" & level==5
(1 real change made)

. 
. replace leveldesc = "No diabetes (ref)" if variable=="diabcat" & level==1
(1 real change made)

. replace leveldesc = "Controlled (HbA1c <58mmol/mol)" if variable=="diabcat" & level==2
variable leveldesc was str23 now str30
(1 real change made)

. replace leveldesc = "Uncontrolled (HbA1c >=58mmol/mol) " if variable=="diabcat" & level==3
variable leveldesc was str30 now str34
(1 real change made)

. replace leveldesc = "Unknown HbA1c" if variable=="diabcat" & level==4
(1 real change made)

. 
. replace leveldesc = "No asthma (ref)" if variable=="asthmacat" & level==1
(1 real change made)

. replace leveldesc = "With no recent OCS use" if variable=="asthmacat" & level==2
(1 real change made)

. replace leveldesc = "With recent OCS use" if variable=="asthmacat" & level==3
(1 real change made)

. 
. replace leveldesc = "Never (ref)" if substr(variable,1,6)=="cancer" & level==1
(2 real changes made)

. replace leveldesc = "<1 year ago" if substr(variable,1,6)=="cancer" & level==2
(2 real changes made)

. replace leveldesc = "1-4.9 years ago" if substr(variable,1,6)=="cancer" & level==3
(2 real changes made)

. replace leveldesc = "5+ years ago" if substr(variable,1,6)=="cancer" & level==4
(2 real changes made)

. 
. replace leveldesc = "None (ref)" if variable=="reduced_kidney_function_cat" & level==1
(1 real change made)

. replace leveldesc = "eGFR 30-60 ml/min/1.73m2" if variable=="reduced_kidney_function_cat" & level==2
(1 real change made)

. replace leveldesc = "eGFR <30 ml/min/1.73m2" if variable=="reduced_kidney_function_cat" & level==3
(1 real change made)

. 
. 
. *replace leveldesc = "Absent" if level==0
. *replace leveldesc = "Present" if level==1 & leveldesc==""
. drop if level==0 & variable!="male"
(10 observations deleted)

. 
. 
. gen obsorder=_n

. gsort -obsorder

. gen graphorder = _n

. sort obsorder

. 
. *merge 1:1 variable level using c:\statatemp\tptemp, update replace
. 
. gen displayhrci = "<<< HR = " + string(hr, "%3.2f") + " (" + string(lci, "%3.2f") + "-" + string(uci, "%3.2f") + ")" if lci<0.15
(91 missing values generated)

. 
. scatter graphorder hr if lci>=.15 & year=="2019", mcol(red)     msize(small)            ///                                                                             ///
>         || rcap lci uci graphorder if lci>=.15 & year=="2019", hor mcol(red)    lcol(red)                       ///
>         || scatter graphorder hr if lci>=.15 & year=="2020", mcol(black)        msize(small)            ///                                                                             ///
>         || rcap lci uci graphorder if lci>=.15 & year=="2020", hor mcol(black)  lcol(black)                     ///
>         || scatter graphorder lowerlimit, m(i) mlab(displayhrci) mlabcol(black) mlabsize(tiny) ///
>         || scatter graphorder varx if year=="2019", m(i) mlab(Name) mlabsize(tiny) mlabcol(black)       ///
>         || scatter graphorder levelx if year=="2019", m(i) mlab(leveldesc) mlabsize(tiny) mlabcol(gs8)  ///
>                 xline(1,lp(dash))                                                                                                                       ///
>                 xscale(log) xlab(0.25 0.5 1 2 5 10) xtitle("Odds Ratio & 95% CI") ylab(none) ytitle("")                                         /// 
>                 yscale(r(100)) ysize(12)   legend(order(1 ) label(1 "Deaths 2019") label(3 "Non-COVID deaths 2020"))

.                 
. 
. graph export ./output/an_table_noncovid20192020_agesex.svg, as(svg) replace
(note: file ./output/an_table_noncovid20192020_agesex.svg not found)
(file ./output/an_table_noncovid20192020_agesex.svg written in SVG format)

. 
end of do-file

. do "E:\analyses\covid-vs-noncovid-deaths-research\analysis\an_table_covidvsnoncovid_agesex.do"

. 
. 
. *Coding: Krishnan Bhaskaran
. *
. *Date drafted: 10/9/2020
. *************************************************************************
. 
. 
. ***********************************************************************************************************************
. *Generic code to ouput the HRs across outcomes for all levels of a particular variables, in the right shape for table
. cap prog drop outputHRsforvar

. prog define outputHRsforvar
  1. syntax, variable(string) min(real) max(real) 
  2. forvalues i=`min'/`max'{
  3. local endwith "_tab"
  4. 
.         *put the varname and condition to left so that alignment can be checked vs shell
.         file write tablecontents ("`variable'") _tab ("`i'") _tab
  5.         
.         foreach failn of numlist 1 2 3 {
  6.         
.                 if `failn'==1 local outcome "COV"
  7.                 else if `failn'==2 local outcome "NONCOV"
  8.                 else if `failn'==3 local outcome "NONCOV_2019"
  9.                 
.                 local noestimatesflag 0 /*reset*/
 10. 
. *CHANGE THE OUTCOME BELOW TO LAST IF BRINGING IN MORE COLS
.                 if `failn'==2 local endwith "_n"
 11. 
.                 ***********************
.                 *1) GET THE RIGHT ESTIMATES INTO MEMORY
. 
.                 
. 
.                 *FOR AGEGROUP - need to use the separate univariate/multivariate model fitted with age group rather than spline
.                 *FOR ETHNICITY - use the separate complete case multivariate model
.                 *FOR REST - use the "main" multivariate model
.                 if `failn'==3{
 12.                                 if "`variable'"=="agegroup" {
 13.                                 cap estimates use ./output/models/an_noncovid_2019_agesex_AGEGROUP
 14.                                 if _rc!=0 local noestimatesflag 1
 15.                                 }
 16.                                 else {
 17.                                 cap estimates use ./output/models/an_noncovid_2019_agesex_`variable'
 18.                                 if _rc!=0 local noestimatesflag 1
 19.                                 }
 20.                 
.                 }
 21.                 else{
 22.                                 if "`variable'"=="agegroup" {
 23.                                 cap estimates use ./output/models/an_covidvsnoncovid_agesex_fail`failn'_AGEGROUP
 24.                                 if _rc!=0 local noestimatesflag 1
 25.                                 }       
 26.                                 else {
 27.                                 cap estimates use ./output/models/an_covidvsnoncovid_agesex_fail`failn'_`variable'
 28.                                 if _rc!=0 local noestimatesflag 1
 29.                                 }
 30.                 }
 31.                 ***********************
.                 *2) WRITE THE HRs TO THE OUTPUT FILE
.                 
.                 if `noestimatesflag'==0{
 32.                         cap lincom `i'.`variable', eform
 33.                         if _rc==0 file write tablecontents %4.2f (r(estimate)) (" (") %4.2f (r(lb)) ("-") %4.2f (r(ub)) (")") `endwith'
 34.                                 else file write tablecontents %4.2f ("ERR IN MODEL") `endwith'
 35.                         }
 36.                         else file write tablecontents %4.2f ("DID NOT FIT") `endwith' 
 37.                         
.                 *3) Save the estimates for plotting
.                 if `noestimatesflag'==0{
 38.                                 local hr = r(estimate)
 39.                                 local lb = r(lb)
 40.                                 local ub = r(ub)
 41.                                 cap gen `variable'=.
 42.                                 testparm i.`variable'
 43.                                 post HRestimates ("`outcome'") ("`variable'") (`i') (`hr') (`lb') (`ub') (r(p))
 44.                                 drop `variable'
 45.                                 }       
 46.                 } /*failn 1 2 */
 47.                 
. } /*variable levels*/
 48. 
. end

. ***********************************************************************************************************************
. *Generic code to write a full row of "ref category" to the output file
. cap prog drop refline

. prog define refline
  1. file write tablecontents _tab _tab ("1.00 (ref)") _tab ("1.00 (ref)")  _n
  2. *post HRestimates ("`outcome'") ("`variable'") (`refcat') (1) (1) (1) (.)
. end

. ***********************************************************************************************************************
. 
. *MAIN CODE TO PRODUCE TABLE CONTENTS
. 
. cap file close tablecontents

. file open tablecontents using ./output/an_table_covidvsnoncovid_agesex.txt, t w replace 

. 
. tempfile HRestimates

. cap postutil clear

. postfile HRestimates str11 outcome str27 variable level hr lci uci pval using `HRestimates'

. 
. *Age group
. outputHRsforvar, variable("agegroup") min(1) max(2) 

 ( 1)  [_d]2.agegroup = 0
 ( 2)  [_d]3.agegroup = 0
 ( 3)  [_d]4.agegroup = 0
 ( 4)  [_d]5.agegroup = 0
 ( 5)  [_d]6.agegroup = 0

           chi2(  5) =24315.89
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.agegroup = 0
 ( 2)  [_d]3.agegroup = 0
 ( 3)  [_d]4.agegroup = 0
 ( 4)  [_d]5.agegroup = 0
 ( 5)  [_d]6.agegroup = 0

           chi2(  5) = 1.3e+05
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.agegroup = 0
 ( 2)  [_d]3.agegroup = 0
 ( 3)  [_d]4.agegroup = 0
 ( 4)  [_d]5.agegroup = 0
 ( 5)  [_d]6.agegroup = 0

           chi2(  5) = 1.1e+05
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.agegroup = 0
 ( 2)  [_d]3.agegroup = 0
 ( 3)  [_d]4.agegroup = 0
 ( 4)  [_d]5.agegroup = 0
 ( 5)  [_d]6.agegroup = 0

           chi2(  5) =24315.89
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.agegroup = 0
 ( 2)  [_d]3.agegroup = 0
 ( 3)  [_d]4.agegroup = 0
 ( 4)  [_d]5.agegroup = 0
 ( 5)  [_d]6.agegroup = 0

           chi2(  5) = 1.3e+05
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.agegroup = 0
 ( 2)  [_d]3.agegroup = 0
 ( 3)  [_d]4.agegroup = 0
 ( 4)  [_d]5.agegroup = 0
 ( 5)  [_d]6.agegroup = 0

           chi2(  5) = 1.1e+05
         Prob > chi2 =    0.0000

. refline

. outputHRsforvar, variable("agegroup") min(4) max(6) 

 ( 1)  [_d]2.agegroup = 0
 ( 2)  [_d]3.agegroup = 0
 ( 3)  [_d]4.agegroup = 0
 ( 4)  [_d]5.agegroup = 0
 ( 5)  [_d]6.agegroup = 0

           chi2(  5) =24315.89
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.agegroup = 0
 ( 2)  [_d]3.agegroup = 0
 ( 3)  [_d]4.agegroup = 0
 ( 4)  [_d]5.agegroup = 0
 ( 5)  [_d]6.agegroup = 0

           chi2(  5) = 1.3e+05
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.agegroup = 0
 ( 2)  [_d]3.agegroup = 0
 ( 3)  [_d]4.agegroup = 0
 ( 4)  [_d]5.agegroup = 0
 ( 5)  [_d]6.agegroup = 0

           chi2(  5) = 1.1e+05
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.agegroup = 0
 ( 2)  [_d]3.agegroup = 0
 ( 3)  [_d]4.agegroup = 0
 ( 4)  [_d]5.agegroup = 0
 ( 5)  [_d]6.agegroup = 0

           chi2(  5) =24315.89
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.agegroup = 0
 ( 2)  [_d]3.agegroup = 0
 ( 3)  [_d]4.agegroup = 0
 ( 4)  [_d]5.agegroup = 0
 ( 5)  [_d]6.agegroup = 0

           chi2(  5) = 1.3e+05
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.agegroup = 0
 ( 2)  [_d]3.agegroup = 0
 ( 3)  [_d]4.agegroup = 0
 ( 4)  [_d]5.agegroup = 0
 ( 5)  [_d]6.agegroup = 0

           chi2(  5) = 1.1e+05
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.agegroup = 0
 ( 2)  [_d]3.agegroup = 0
 ( 3)  [_d]4.agegroup = 0
 ( 4)  [_d]5.agegroup = 0
 ( 5)  [_d]6.agegroup = 0

           chi2(  5) =24315.89
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.agegroup = 0
 ( 2)  [_d]3.agegroup = 0
 ( 3)  [_d]4.agegroup = 0
 ( 4)  [_d]5.agegroup = 0
 ( 5)  [_d]6.agegroup = 0

           chi2(  5) = 1.3e+05
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.agegroup = 0
 ( 2)  [_d]3.agegroup = 0
 ( 3)  [_d]4.agegroup = 0
 ( 4)  [_d]5.agegroup = 0
 ( 5)  [_d]6.agegroup = 0

           chi2(  5) = 1.1e+05
         Prob > chi2 =    0.0000

. file write tablecontents _n 

. 
. *Sex 
. refline

. outputHRsforvar, variable("male") min(1) max(1) 

. file write tablecontents _n

. 
. *BMI
. refline

. outputHRsforvar, variable("obese4cat") min(2) max(4) 

 ( 1)  [_d]2.obese4cat = 0
 ( 2)  [_d]3.obese4cat = 0
 ( 3)  [_d]4.obese4cat = 0

           chi2(  3) =  661.61
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.obese4cat = 0
 ( 2)  [_d]3.obese4cat = 0
 ( 3)  [_d]4.obese4cat = 0

           chi2(  3) =  663.68
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.obese4cat = 0
 ( 2)  [_d]3.obese4cat = 0
 ( 3)  [_d]4.obese4cat = 0

           chi2(  3) =  503.75
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.obese4cat = 0
 ( 2)  [_d]3.obese4cat = 0
 ( 3)  [_d]4.obese4cat = 0

           chi2(  3) =  661.61
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.obese4cat = 0
 ( 2)  [_d]3.obese4cat = 0
 ( 3)  [_d]4.obese4cat = 0

           chi2(  3) =  663.68
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.obese4cat = 0
 ( 2)  [_d]3.obese4cat = 0
 ( 3)  [_d]4.obese4cat = 0

           chi2(  3) =  503.75
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.obese4cat = 0
 ( 2)  [_d]3.obese4cat = 0
 ( 3)  [_d]4.obese4cat = 0

           chi2(  3) =  661.61
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.obese4cat = 0
 ( 2)  [_d]3.obese4cat = 0
 ( 3)  [_d]4.obese4cat = 0

           chi2(  3) =  663.68
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.obese4cat = 0
 ( 2)  [_d]3.obese4cat = 0
 ( 3)  [_d]4.obese4cat = 0

           chi2(  3) =  503.75
         Prob > chi2 =    0.0000

. file write tablecontents _n

. 
. *Smoking
. refline

. outputHRsforvar, variable("smoke_nomiss") min(2) max(3) 

 ( 1)  [_d]2.smoke_nomiss = 0
 ( 2)  [_d]3.smoke_nomiss = 0

           chi2(  2) =  333.21
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.smoke_nomiss = 0
 ( 2)  [_d]3.smoke_nomiss = 0

           chi2(  2) = 6361.00
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.smoke_nomiss = 0
 ( 2)  [_d]3.smoke_nomiss = 0

           chi2(  2) = 6036.48
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.smoke_nomiss = 0
 ( 2)  [_d]3.smoke_nomiss = 0

           chi2(  2) =  333.21
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.smoke_nomiss = 0
 ( 2)  [_d]3.smoke_nomiss = 0

           chi2(  2) = 6361.00
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.smoke_nomiss = 0
 ( 2)  [_d]3.smoke_nomiss = 0

           chi2(  2) = 6036.48
         Prob > chi2 =    0.0000

. file write tablecontents _n

. 
. *Ethnicity
. refline

. outputHRsforvar, variable("ethnicity") min(2) max(5) 

 ( 1)  [_d]2.ethnicity = 0
 ( 2)  [_d]3.ethnicity = 0
 ( 3)  [_d]4.ethnicity = 0
 ( 4)  [_d]5.ethnicity = 0

           chi2(  4) =  558.17
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.ethnicity = 0
 ( 2)  [_d]3.ethnicity = 0
 ( 3)  [_d]4.ethnicity = 0
 ( 4)  [_d]5.ethnicity = 0

           chi2(  4) =  176.55
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.ethnicity = 0
 ( 2)  [_d]3.ethnicity = 0
 ( 3)  [_d]4.ethnicity = 0
 ( 4)  [_d]5.ethnicity = 0

           chi2(  4) =  220.85
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.ethnicity = 0
 ( 2)  [_d]3.ethnicity = 0
 ( 3)  [_d]4.ethnicity = 0
 ( 4)  [_d]5.ethnicity = 0

           chi2(  4) =  558.17
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.ethnicity = 0
 ( 2)  [_d]3.ethnicity = 0
 ( 3)  [_d]4.ethnicity = 0
 ( 4)  [_d]5.ethnicity = 0

           chi2(  4) =  176.55
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.ethnicity = 0
 ( 2)  [_d]3.ethnicity = 0
 ( 3)  [_d]4.ethnicity = 0
 ( 4)  [_d]5.ethnicity = 0

           chi2(  4) =  220.85
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.ethnicity = 0
 ( 2)  [_d]3.ethnicity = 0
 ( 3)  [_d]4.ethnicity = 0
 ( 4)  [_d]5.ethnicity = 0

           chi2(  4) =  558.17
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.ethnicity = 0
 ( 2)  [_d]3.ethnicity = 0
 ( 3)  [_d]4.ethnicity = 0
 ( 4)  [_d]5.ethnicity = 0

           chi2(  4) =  176.55
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.ethnicity = 0
 ( 2)  [_d]3.ethnicity = 0
 ( 3)  [_d]4.ethnicity = 0
 ( 4)  [_d]5.ethnicity = 0

           chi2(  4) =  220.85
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.ethnicity = 0
 ( 2)  [_d]3.ethnicity = 0
 ( 3)  [_d]4.ethnicity = 0
 ( 4)  [_d]5.ethnicity = 0

           chi2(  4) =  558.17
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.ethnicity = 0
 ( 2)  [_d]3.ethnicity = 0
 ( 3)  [_d]4.ethnicity = 0
 ( 4)  [_d]5.ethnicity = 0

           chi2(  4) =  176.55
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.ethnicity = 0
 ( 2)  [_d]3.ethnicity = 0
 ( 3)  [_d]4.ethnicity = 0
 ( 4)  [_d]5.ethnicity = 0

           chi2(  4) =  220.85
         Prob > chi2 =    0.0000

. file write tablecontents _n

. 
. *IMD
. refline

. outputHRsforvar, variable("imd") min(2) max(5) 

 ( 1)  [_d]2.imd = 0
 ( 2)  [_d]3.imd = 0
 ( 3)  [_d]4.imd = 0
 ( 4)  [_d]5.imd = 0

           chi2(  4) = 1296.09
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.imd = 0
 ( 2)  [_d]3.imd = 0
 ( 3)  [_d]4.imd = 0
 ( 4)  [_d]5.imd = 0

           chi2(  4) = 2911.68
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.imd = 0
 ( 2)  [_d]3.imd = 0
 ( 3)  [_d]4.imd = 0
 ( 4)  [_d]5.imd = 0

           chi2(  4) = 2277.08
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.imd = 0
 ( 2)  [_d]3.imd = 0
 ( 3)  [_d]4.imd = 0
 ( 4)  [_d]5.imd = 0

           chi2(  4) = 1296.09
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.imd = 0
 ( 2)  [_d]3.imd = 0
 ( 3)  [_d]4.imd = 0
 ( 4)  [_d]5.imd = 0

           chi2(  4) = 2911.68
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.imd = 0
 ( 2)  [_d]3.imd = 0
 ( 3)  [_d]4.imd = 0
 ( 4)  [_d]5.imd = 0

           chi2(  4) = 2277.08
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.imd = 0
 ( 2)  [_d]3.imd = 0
 ( 3)  [_d]4.imd = 0
 ( 4)  [_d]5.imd = 0

           chi2(  4) = 1296.09
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.imd = 0
 ( 2)  [_d]3.imd = 0
 ( 3)  [_d]4.imd = 0
 ( 4)  [_d]5.imd = 0

           chi2(  4) = 2911.68
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.imd = 0
 ( 2)  [_d]3.imd = 0
 ( 3)  [_d]4.imd = 0
 ( 4)  [_d]5.imd = 0

           chi2(  4) = 2277.08
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.imd = 0
 ( 2)  [_d]3.imd = 0
 ( 3)  [_d]4.imd = 0
 ( 4)  [_d]5.imd = 0

           chi2(  4) = 1296.09
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.imd = 0
 ( 2)  [_d]3.imd = 0
 ( 3)  [_d]4.imd = 0
 ( 4)  [_d]5.imd = 0

           chi2(  4) = 2911.68
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.imd = 0
 ( 2)  [_d]3.imd = 0
 ( 3)  [_d]4.imd = 0
 ( 4)  [_d]5.imd = 0

           chi2(  4) = 2277.08
         Prob > chi2 =    0.0000

. file write tablecontents _n 

. 
. *BP/hypertension
. refline

. outputHRsforvar, variable("htdiag_or_highbp") min(1) max(1) 

 ( 1)  [_d]1.htdiag_or_highbp = 0

           chi2(  1) =   19.82
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.htdiag_or_highbp = 0

           chi2(  1) =   55.39
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.htdiag_or_highbp = 0

           chi2(  1) =    2.33
         Prob > chi2 =    0.1270

. file write tablecontents _n

. outputHRsforvar, variable("chronic_respiratory_disease") min(1) max(1) 

 ( 1)  [_d]1.chronic_respiratory_disease = 0

           chi2(  1) = 1101.69
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.chronic_respiratory_disease = 0

           chi2(  1) = 8717.58
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.chronic_respiratory_disease = 0

           chi2(  1) = 9622.29
         Prob > chi2 =    0.0000

. file write tablecontents _n                     

. outputHRsforvar, variable("asthmacat") min(2) max(3)                    

 ( 1)  [_d]2.asthmacat = 0
 ( 2)  [_d]3.asthmacat = 0

           chi2(  2) =   99.99
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.asthmacat = 0
 ( 2)  [_d]3.asthmacat = 0

           chi2(  2) =   91.32
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.asthmacat = 0
 ( 2)  [_d]3.asthmacat = 0

           chi2(  2) =   30.36
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.asthmacat = 0
 ( 2)  [_d]3.asthmacat = 0

           chi2(  2) =   99.99
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.asthmacat = 0
 ( 2)  [_d]3.asthmacat = 0

           chi2(  2) =   91.32
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.asthmacat = 0
 ( 2)  [_d]3.asthmacat = 0

           chi2(  2) =   30.36
         Prob > chi2 =    0.0000

. outputHRsforvar, variable("chronic_cardiac_disease") min(1) max(1) 

 ( 1)  [_d]1.chronic_cardiac_disease = 0

           chi2(  1) =  692.43
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.chronic_cardiac_disease = 0

           chi2(  1) = 5020.05
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.chronic_cardiac_disease = 0

           chi2(  1) = 5562.85
         Prob > chi2 =    0.0000

. file write tablecontents _n     

. outputHRsforvar, variable("diabcat") min(2) max(4) 

 ( 1)  [_d]2.diabcat = 0
 ( 2)  [_d]3.diabcat = 0
 ( 3)  [_d]4.diabcat = 0

           chi2(  3) = 1799.52
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.diabcat = 0
 ( 2)  [_d]3.diabcat = 0
 ( 3)  [_d]4.diabcat = 0

           chi2(  3) = 3361.90
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.diabcat = 0
 ( 2)  [_d]3.diabcat = 0
 ( 3)  [_d]4.diabcat = 0

           chi2(  3) =23093.62
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.diabcat = 0
 ( 2)  [_d]3.diabcat = 0
 ( 3)  [_d]4.diabcat = 0

           chi2(  3) = 1799.52
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.diabcat = 0
 ( 2)  [_d]3.diabcat = 0
 ( 3)  [_d]4.diabcat = 0

           chi2(  3) = 3361.90
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.diabcat = 0
 ( 2)  [_d]3.diabcat = 0
 ( 3)  [_d]4.diabcat = 0

           chi2(  3) =23093.62
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.diabcat = 0
 ( 2)  [_d]3.diabcat = 0
 ( 3)  [_d]4.diabcat = 0

           chi2(  3) = 1799.52
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.diabcat = 0
 ( 2)  [_d]3.diabcat = 0
 ( 3)  [_d]4.diabcat = 0

           chi2(  3) = 3361.90
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.diabcat = 0
 ( 2)  [_d]3.diabcat = 0
 ( 3)  [_d]4.diabcat = 0

           chi2(  3) =23093.62
         Prob > chi2 =    0.0000

. file write tablecontents _n             

. outputHRsforvar, variable("cancer_exhaem_cat") min(2) max(4) 

 ( 1)  [_d]2.cancer_exhaem_cat = 0
 ( 2)  [_d]3.cancer_exhaem_cat = 0
 ( 3)  [_d]4.cancer_exhaem_cat = 0

           chi2(  3) =  125.21
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.cancer_exhaem_cat = 0
 ( 2)  [_d]3.cancer_exhaem_cat = 0
 ( 3)  [_d]4.cancer_exhaem_cat = 0

           chi2(  3) =34591.81
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.cancer_exhaem_cat = 0
 ( 2)  [_d]3.cancer_exhaem_cat = 0
 ( 3)  [_d]4.cancer_exhaem_cat = 0

           chi2(  3) =33601.09
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.cancer_exhaem_cat = 0
 ( 2)  [_d]3.cancer_exhaem_cat = 0
 ( 3)  [_d]4.cancer_exhaem_cat = 0

           chi2(  3) =  125.21
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.cancer_exhaem_cat = 0
 ( 2)  [_d]3.cancer_exhaem_cat = 0
 ( 3)  [_d]4.cancer_exhaem_cat = 0

           chi2(  3) =34591.81
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.cancer_exhaem_cat = 0
 ( 2)  [_d]3.cancer_exhaem_cat = 0
 ( 3)  [_d]4.cancer_exhaem_cat = 0

           chi2(  3) =33601.09
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.cancer_exhaem_cat = 0
 ( 2)  [_d]3.cancer_exhaem_cat = 0
 ( 3)  [_d]4.cancer_exhaem_cat = 0

           chi2(  3) =  125.21
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.cancer_exhaem_cat = 0
 ( 2)  [_d]3.cancer_exhaem_cat = 0
 ( 3)  [_d]4.cancer_exhaem_cat = 0

           chi2(  3) =34591.81
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.cancer_exhaem_cat = 0
 ( 2)  [_d]3.cancer_exhaem_cat = 0
 ( 3)  [_d]4.cancer_exhaem_cat = 0

           chi2(  3) =33601.09
         Prob > chi2 =    0.0000

. file write tablecontents _n             

. outputHRsforvar, variable("cancer_haem_cat") min(2) max(4)              

 ( 1)  [_d]2.cancer_haem_cat = 0
 ( 2)  [_d]3.cancer_haem_cat = 0
 ( 3)  [_d]4.cancer_haem_cat = 0

           chi2(  3) =  255.16
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.cancer_haem_cat = 0
 ( 2)  [_d]3.cancer_haem_cat = 0
 ( 3)  [_d]4.cancer_haem_cat = 0

           chi2(  3) = 2839.60
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.cancer_haem_cat = 0
 ( 2)  [_d]3.cancer_haem_cat = 0
 ( 3)  [_d]4.cancer_haem_cat = 0

           chi2(  3) = 2638.41
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.cancer_haem_cat = 0
 ( 2)  [_d]3.cancer_haem_cat = 0
 ( 3)  [_d]4.cancer_haem_cat = 0

           chi2(  3) =  255.16
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.cancer_haem_cat = 0
 ( 2)  [_d]3.cancer_haem_cat = 0
 ( 3)  [_d]4.cancer_haem_cat = 0

           chi2(  3) = 2839.60
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.cancer_haem_cat = 0
 ( 2)  [_d]3.cancer_haem_cat = 0
 ( 3)  [_d]4.cancer_haem_cat = 0

           chi2(  3) = 2638.41
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.cancer_haem_cat = 0
 ( 2)  [_d]3.cancer_haem_cat = 0
 ( 3)  [_d]4.cancer_haem_cat = 0

           chi2(  3) =  255.16
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.cancer_haem_cat = 0
 ( 2)  [_d]3.cancer_haem_cat = 0
 ( 3)  [_d]4.cancer_haem_cat = 0

           chi2(  3) = 2839.60
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.cancer_haem_cat = 0
 ( 2)  [_d]3.cancer_haem_cat = 0
 ( 3)  [_d]4.cancer_haem_cat = 0

           chi2(  3) = 2638.41
         Prob > chi2 =    0.0000

. file write tablecontents _n

. outputHRsforvar, variable("reduced_kidney_function_cat") min(2) max(3)          

 ( 1)  [_d]2.reduced_kidney_function_cat = 0
 ( 2)  [_d]3.reduced_kidney_function_cat = 0

           chi2(  2) = 1349.97
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.reduced_kidney_function_cat = 0
 ( 2)  [_d]3.reduced_kidney_function_cat = 0

           chi2(  2) = 6224.47
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.reduced_kidney_function_cat = 0
 ( 2)  [_d]3.reduced_kidney_function_cat = 0

           chi2(  2) = 6029.34
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.reduced_kidney_function_cat = 0
 ( 2)  [_d]3.reduced_kidney_function_cat = 0

           chi2(  2) = 1349.97
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.reduced_kidney_function_cat = 0
 ( 2)  [_d]3.reduced_kidney_function_cat = 0

           chi2(  2) = 6224.47
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.reduced_kidney_function_cat = 0
 ( 2)  [_d]3.reduced_kidney_function_cat = 0

           chi2(  2) = 6029.34
         Prob > chi2 =    0.0000

. outputHRsforvar, variable("chronic_liver_disease") min(1) max(1)                        

 ( 1)  [_d]1.chronic_liver_disease = 0

           chi2(  1) =  237.81
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.chronic_liver_disease = 0

           chi2(  1) = 4530.61
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.chronic_liver_disease = 0

           chi2(  1) = 4640.34
         Prob > chi2 =    0.0000

. outputHRsforvar, variable("stroke_dementia") min(1) max(1)      

 ( 1)  [_d]1.stroke_dementia = 0

           chi2(  1) = 2159.47
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.stroke_dementia = 0

           chi2(  1) = 6277.31
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.stroke_dementia = 0

           chi2(  1) = 5136.00
         Prob > chi2 =    0.0000

. outputHRsforvar, variable("other_neuro") min(1) max(1)          

 ( 1)  [_d]1.other_neuro = 0

           chi2(  1) = 1233.56
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.other_neuro = 0

           chi2(  1) = 3795.22
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.other_neuro = 0

           chi2(  1) = 2823.52
         Prob > chi2 =    0.0000

. outputHRsforvar, variable("organ_transplant") min(1) max(1)                     

 ( 1)  [_d]1.organ_transplant = 0

           chi2(  1) =  238.93
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.organ_transplant = 0

           chi2(  1) =  478.46
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.organ_transplant = 0

           chi2(  1) =  499.10
         Prob > chi2 =    0.0000

. outputHRsforvar, variable("spleen") min(1) max(1) 

 ( 1)  [_d]1.spleen = 0

           chi2(  1) =    6.27
         Prob > chi2 =    0.0123

 ( 1)  [_d]1.spleen = 0

           chi2(  1) =  214.14
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.spleen = 0

           chi2(  1) =  193.66
         Prob > chi2 =    0.0000

. outputHRsforvar, variable("ra_sle_psoriasis") min(1) max(1) 

 ( 1)  [_d]1.ra_sle_psoriasis = 0

           chi2(  1) =   88.85
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.ra_sle_psoriasis = 0

           chi2(  1) =  273.14
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.ra_sle_psoriasis = 0

           chi2(  1) =  231.03
         Prob > chi2 =    0.0000

. outputHRsforvar, variable("other_immunosuppression") min(1) max(1) 

 ( 1)  [_d]1.other_immunosuppression = 0

           chi2(  1) =   77.48
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.other_immunosuppression = 0

           chi2(  1) =  527.14
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.other_immunosuppression = 0

           chi2(  1) =  133.80
         Prob > chi2 =    0.0000

. 
. 
. file close tablecontents

. 
. postclose HRestimates

. 
. use `HRestimates', clear

. 
. gen varorder = 1 

. local i=2

. foreach var of any male obese4cat smoke_nomiss ethnicity imd  diabcat ///
>         cancer_exhaem_cat cancer_haem_cat reduced_kidney_function_cat asthmacat chronic_respiratory_disease ///
>         chronic_cardiac_disease htdiag_or_highbp chronic_liver_disease ///
>         stroke_dementia other_neuro organ_transplant ///
>         spleen ra_sle_psoriasis other_immunosuppression {
  2. replace varorder = `i' if variable=="`var'"
  3. local i=`i'+1
  4. }
(0 real changes made)
(9 real changes made)
(6 real changes made)
(12 real changes made)
(12 real changes made)
(9 real changes made)
(9 real changes made)
(9 real changes made)
(6 real changes made)
(6 real changes made)
(3 real changes made)
(3 real changes made)
(3 real changes made)
(3 real changes made)
(3 real changes made)
(3 real changes made)
(3 real changes made)
(3 real changes made)
(3 real changes made)
(3 real changes made)

. sort varorder outcome level

. drop varorder

. 
. gen obsorder=_n

. expand 2 if variable!=variable[_n-1] | outcome!=outcome[_n-1], gen(expanded)
(60 observations created)

. for var hr lci uci: replace X = 1 if expanded==1

->  replace hr = 1 if expanded==1
(57 real changes made)

->  replace lci = 1 if expanded==1
(60 real changes made)

->  replace uci = 1 if expanded==1
(60 real changes made)

. 
. sort obsorder

. drop obsorder

. replace level = 0 if expanded == 1
(60 real changes made)

. replace level = 1 if expanded == 1 & (variable=="obese4cat"|variable=="smoke_nomiss"|variable=="ethnicity"|variable=="imd"|variable=="asthmacat"|variable=="diabcat"|substr(variable,1,6)=="cancer"|variab
> le=="reduced_kidney_function_cat"|variable=="agegroup")
(30 real changes made)

. replace level = 3 if expanded == 1 & variable=="agegroup"
(3 real changes made)

. 
. gen varorder = 1 if variable!=variable[_n-1]
(163 missing values generated)

. replace varorder = sum(varorder)
(182 real changes made)

. sort varorder outcome level

. 
. 
. drop expanded

. expand 2 if variable!=variable[_n-1] | outcome!=outcome[_n-1], gen(expanded)
(60 observations created)

. replace level = -1 if expanded==1
(60 real changes made)

. drop expanded

. *expand 3 if variable=="htdiag_or_highbp" & level==-1, gen(expanded)
. *replace level = -99 if variable=="htdiag_or_highbp" & expanded==1
. expand 2 if level == -1, gen(expanded)
(60 observations created)

. replace level = -99 if expanded==1
(60 real changes made)

. 
. for var hr lci uci pval : replace X=. if level<0

->  replace hr=. if level<0
(120 real changes made, 120 to missing)

->  replace lci=. if level<0
(114 real changes made, 114 to missing)

->  replace uci=. if level<0
(114 real changes made, 114 to missing)

->  replace pval=. if level<0
(120 real changes made, 120 to missing)

. sort varorder outcome  level

. 
. gen varx = 0.07

. gen levelx = 0.071

. gen lowerlimit = 0.15

. 
. *Names
. gen Name = variable if (level==-1&!(level[_n+1]==0&variable!="male"))|(level==1&level[_n-1]==0&variable!="male")
(243 missing values generated)

. replace Name = subinstr(Name, "_", " ", 10)
(39 real changes made)

. replace Name = upper(substr(Name,1,1)) + substr(Name,2,.)
(60 real changes made)

. replace Name = "Age group" if Name=="Agegroup"
(3 real changes made)

. replace Name = "Sex" if Name=="Male"
(0 real changes made)

. replace Name = "Obesity" if Name=="Obese4cat"
(3 real changes made)

. replace Name = "Smoking status" if Name=="Smoke nomiss"
(3 real changes made)

. replace Name = "Deprivation (IMD) quintile" if Name=="Imd"
(3 real changes made)

. replace Name = "Hypertension/high bp" if Name=="Htdiag or highbp"
(3 real changes made)

. replace Name = "Asthma" if Name=="Asthmacat"
(3 real changes made)

. replace Name = "Diabetes" if Name=="Diabcat"
(3 real changes made)

. replace Name = "Cancer (non-haematological)" if Name=="Cancer exhaem cat"
(3 real changes made)

. replace Name = "Haematological malignancy" if Name=="Cancer haem cat"
(3 real changes made)

. replace Name = "Stroke or dementia" if Name=="Stroke dementia"
(3 real changes made)

. replace Name = "Other neurological" if Name=="Other neuro"
(3 real changes made)

. replace Name = "Rheumatoid arthritis/Lupus/Psoriasis" if Name=="Ra sle psoriasis"
variable Name was str27 now str36
(3 real changes made)

. replace Name = "Reduced kidney function" if Name=="Reduced kidney function cat"
(3 real changes made)

. replace Name = "Asplenia" if Name=="Spleen"
(3 real changes made)

. 
. *Levels
. gen leveldesc = ""
(303 missing values generated)

. replace leveldesc = "18-39" if variable=="agegroup" & level==1
variable leveldesc was str1 now str5
(3 real changes made)

. replace leveldesc = "40-49" if variable=="agegroup" & level==2
(3 real changes made)

. replace leveldesc = "50-59 (ref)" if variable=="agegroup" & level==3
variable leveldesc was str5 now str11
(3 real changes made)

. replace leveldesc = "60-69" if variable=="agegroup" & level==4
(3 real changes made)

. replace leveldesc = "70-79" if variable=="agegroup" & level==5
(3 real changes made)

. replace leveldesc = "80+" if variable=="agegroup" & level==6
(3 real changes made)

. 
. replace leveldesc = "Female (ref)" if variable=="male" & level==0
(0 real changes made)

. replace leveldesc = "Male" if variable=="male" & level==1
(0 real changes made)

. 
. replace leveldesc = "Not obese (ref)" if variable=="obese4cat" & level==1
variable leveldesc was str11 now str15
(3 real changes made)

. replace leveldesc = "Obese class I" if variable=="obese4cat" & level==2
(3 real changes made)

. replace leveldesc = "Obese class II" if variable=="obese4cat" & level==3
(3 real changes made)

. replace leveldesc = "Obese class III" if variable=="obese4cat" & level==4
(3 real changes made)

. 
. replace leveldesc = "Never (ref)" if variable=="smoke_nomiss" & level==1
(3 real changes made)

. replace leveldesc = "Ex-smoker" if variable=="smoke_nomiss" & level==2
(3 real changes made)

. replace leveldesc = "Current" if variable=="smoke_nomiss" & level==3
(3 real changes made)

. 
. replace leveldesc = "White (ref)" if variable=="ethnicity" & level==1
(3 real changes made)

. replace leveldesc = "Mixed" if variable=="ethnicity" & level==2
(3 real changes made)

. replace leveldesc = "Asian/Asian British" if variable=="ethnicity" & level==3
variable leveldesc was str15 now str19
(3 real changes made)

. replace leveldesc = "Black" if variable=="ethnicity" & level==4
(3 real changes made)

. replace leveldesc = "Other" if variable=="ethnicity" & level==5
(3 real changes made)

. 
. replace leveldesc = "1 (least deprived, ref)" if variable=="imd" & level==1
variable leveldesc was str19 now str23
(3 real changes made)

. replace leveldesc = "2" if variable=="imd" & level==2
(3 real changes made)

. replace leveldesc = "3" if variable=="imd" & level==3
(3 real changes made)

. replace leveldesc = "4" if variable=="imd" & level==4
(3 real changes made)

. replace leveldesc = "5 (most deprived)" if variable=="imd" & level==5
(3 real changes made)

. 
. replace leveldesc = "No diabetes (ref)" if variable=="diabcat" & level==1
(3 real changes made)

. replace leveldesc = "Controlled (HbA1c <58mmol/mol)" if variable=="diabcat" & level==2
variable leveldesc was str23 now str30
(3 real changes made)

. replace leveldesc = "Uncontrolled (HbA1c >=58mmol/mol) " if variable=="diabcat" & level==3
variable leveldesc was str30 now str34
(3 real changes made)

. replace leveldesc = "Unknown HbA1c" if variable=="diabcat" & level==4
(3 real changes made)

. 
. replace leveldesc = "No asthma (ref)" if variable=="asthmacat" & level==1
(3 real changes made)

. replace leveldesc = "With no recent OCS use" if variable=="asthmacat" & level==2
(3 real changes made)

. replace leveldesc = "With recent OCS use" if variable=="asthmacat" & level==3
(3 real changes made)

. 
. replace leveldesc = "Never (ref)" if substr(variable,1,6)=="cancer" & level==1
(6 real changes made)

. replace leveldesc = "<1 year ago" if substr(variable,1,6)=="cancer" & level==2
(6 real changes made)

. replace leveldesc = "1-4.9 years ago" if substr(variable,1,6)=="cancer" & level==3
(6 real changes made)

. replace leveldesc = "5+ years ago" if substr(variable,1,6)=="cancer" & level==4
(6 real changes made)

. 
. replace leveldesc = "None (ref)" if variable=="reduced_kidney_function_cat" & level==1
(3 real changes made)

. replace leveldesc = "eGFR 30-60 ml/min/1.73m2" if variable=="reduced_kidney_function_cat" & level==2
(3 real changes made)

. replace leveldesc = "eGFR <30 ml/min/1.73m2" if variable=="reduced_kidney_function_cat" & level==3
(3 real changes made)

. 
. 
. *replace leveldesc = "Absent" if level==0
. *replace leveldesc = "Present" if level==1 & leveldesc==""
. drop if level==0 & variable!="male"
(30 observations deleted)

. 
. 
. gen obsorder=_n

. gsort -obsorder

. gen graphorder = _n

. sort obsorder

. 
. *merge 1:1 variable level using c:\statatemp\tptemp, update replace
. 
. gen displayhrci = "<<< HR = " + string(hr, "%3.2f") + " (" + string(lci, "%3.2f") + "-" + string(uci, "%3.2f") + ")" if lci<0.15
(273 missing values generated)

. 
. qui summ obsorder if outcome=="NONCOV_2019" & variable=="imd" & level ==5

. local endofdemog = r(mean)

. foreach graphtype of any demogs comorbs{
  2. if "`graphtype'"=="demogs" local if "if _n<=`endofdemog'"
  3. if "`graphtype'"=="comorbs" local if "if _n>`endofdemog'"
  4. scatter graphorder hr if lci>=.15 & outcome=="COV", mcol(red)   msize(small)            ///                                                                             ///
>         || rcap lci uci graphorder if lci>=.15 & outcome=="COV", hor mcol(red)  lcol(red)                       ///
>         || scatter graphorder hr if lci>=.15 & outcome=="NONCOV", mcol(black)   msize(small)            ///                                                                             ///
>         || rcap lci uci graphorder if lci>=.15 & outcome=="NONCOV", hor mcol(black)     lcol(black)                     ///
>         || scatter graphorder hr if lci>=.15 & outcome=="NONCOV_2019", mcol(blue)       msize(small)            ///                                                                             ///
>         || rcap lci uci graphorder if lci>=.15 & outcome=="NONCOV_2019", hor mcol(blue) lcol(black)                     ///
>         || scatter graphorder lowerlimit, m(i) mlab(displayhrci) mlabcol(black) mlabsize(tiny) ///
>         || scatter graphorder varx if outcome=="COV", m(i) mlab(Name) mlabsize(tiny) mlabcol(black)     ///
>         || scatter graphorder levelx if outcome=="COV", m(i) mlab(leveldesc) mlabsize(tiny) mlabcol(gs8)        ///
>                 xline(1,lp(dash))                                                                                                                       ///
>                 xscale(log) xlab(0.25 0.5 1 2 5 10 20) xtitle("Odds Ratio & 95% CI") ylab(none) ytitle("")                                              /// 
>                  ysize(12)   legend(order(1 3 5) label(1 "COVID deaths") label(3 "Non-COVID deaths")  label(5 "Deaths 2019")) ///
>                 || `if' , name(`graphtype', replace)
  5. }

. graph combine demogs comorbs, rows(1) ysize(6) iscale(*.7)

. graph export ./output/an_table_covidvsnoncovid_agesex.svg, as(svg) replace
(file ./output/an_table_covidvsnoncovid_agesex.svg written in SVG format)

. 
end of do-file

. do "E:\analyses\covid-vs-noncovid-deaths-research\analysis\an_table_covidvsnoncovid_full.do"

. 
. *Coding: Krishnan Bhaskaran
. *
. *Date drafted: 20/9/2020
. *************************************************************************
. 
. 
. ***********************************************************************************************************************
. *Generic code to ouput the HRs across outcomes for all levels of a particular variables, in the right shape for table
. cap prog drop outputHRsforvar

. prog define outputHRsforvar
  1. syntax, variable(string) min(real) max(real) 
  2. forvalues i=`min'/`max'{
  3. local endwith "_tab"
  4. 
.         *put the varname and condition to left so that alignment can be checked vs shell
.         file write tablecontents ("`variable'") _tab ("`i'") _tab
  5.         
.         foreach failn of numlist 1 2 3 {
  6.         
.                 if `failn'==1 local outcome "COV"
  7.                 else if `failn'==2 local outcome "NONCOV"
  8.                                 else if `failn'==3 local outcome "NONCOV_2019"
  9. 
.                 local noestimatesflag 0 /*reset*/
 10. 
. *CHANGE THE OUTCOME BELOW TO LAST IF BRINGING IN MORE COLS
.                 if `failn'==2 local endwith "_n"
 11. 
.                 ***********************
.                 *1) GET THE RIGHT ESTIMATES INTO MEMORY
. 
.                 
. 
.                 *FOR AGEGROUP - need to use the separate univariate/multivariate model fitted with age group rather than spline
.                 *FOR ETHNICITY - use the separate complete case multivariate model
.                 *FOR REST - use the "main" multivariate model
.                 if `failn'==3{
 12.                                 if "`variable'"=="agegroup" {
 13.                                 cap estimates use ./output/models/an_noncovid_full_2019_agegroup_bmicat_noeth
 14.                                 if _rc!=0 local noestimatesflag 1
 15.                                 }
 16.                 else if "`variable'"=="ethnicity" {
 17.                                 cap estimates use ./output/models/an_noncovid_full_2019_agespline_bmicat_CCeth  
 18.                                 if _rc!=0 local noestimatesflag 1
 19.                                 }                       
 20. 
.                 else {
 21.                                 cap estimates use ./output/models/an_noncovid_full_2019_agespline_bmicat_noeth
 22.                                 if _rc!=0 local noestimatesflag 1
 23.                                 }
 24.                 }
 25.                 
.                 else {
 26.                                 if "`variable'"=="agegroup" {
 27.                                 cap estimates use ./output/models/an_covidvsnoncovid_full_fail`failn'_agegroup_bmicat_noeth
 28.                                 if _rc!=0 local noestimatesflag 1
 29.                                 }
 30.                                 else if "`variable'"=="ethnicity" {
 31.                                 cap estimates use ./output/models/an_covidvsnoncovid_full_fail`failn'_agespline_bmicat_CCeth  
 32.                                 if _rc!=0 local noestimatesflag 1
 33.                                 }                       
 34.                                 else {
 35.                                 cap estimates use ./output/models/an_covidvsnoncovid_full_fail`failn'_agespline_bmicat_noeth
 36.                                 if _rc!=0 local noestimatesflag 1
 37.                                 }
 38.                 }
 39.                 
.                 ***********************
.                 *2) WRITE THE HRs TO THE OUTPUT FILE
.                 
.                 if `noestimatesflag'==0{
 40.                         cap lincom `i'.`variable', eform
 41.                         if _rc==0 file write tablecontents %4.2f (r(estimate)) (" (") %4.2f (r(lb)) ("-") %4.2f (r(ub)) (")") `endwith'
 42.                                 else file write tablecontents %4.2f ("ERR IN MODEL") `endwith'
 43.                         }
 44.                         else file write tablecontents %4.2f ("DID NOT FIT") `endwith' 
 45.                         
.                 *3) Save the estimates for plotting
.                 if `noestimatesflag'==0{
 46.                                 local hr = r(estimate)
 47.                                 local lb = r(lb)
 48.                                 local ub = r(ub)
 49.                                 cap gen `variable'=.
 50.                                 testparm i.`variable'
 51.                                 post HRestimates ("`outcome'") ("`variable'") (`i') (`hr') (`lb') (`ub') (r(p))
 52.                                 drop `variable'
 53.                                 }       
 54.                 } /*failn 1 2 */
 55.                 
. } /*variable levels*/
 56. 
. end

. ***********************************************************************************************************************
. *Generic code to write a full row of "ref category" to the output file
. cap prog drop refline

. prog define refline
  1. file write tablecontents _tab _tab ("1.00 (ref)") _tab ("1.00 (ref)")  _n
  2. *post HRestimates ("`outcome'") ("`variable'") (`refcat') (1) (1) (1) (.)
. end

. ***********************************************************************************************************************
. 
. *MAIN CODE TO PRODUCE TABLE CONTENTS
. 
. cap file close tablecontents

. file open tablecontents using ./output/an_table_covidvsnoncovid_full.txt, t w replace 

. 
. tempfile HRestimates

. cap postutil clear

. postfile HRestimates str11 outcome str27 variable level hr lci uci pval using `HRestimates'

. 
. *Age group
. outputHRsforvar, variable("agegroup") min(1) max(2) 

 ( 1)  [_d]1.agegroup = 0
 ( 2)  [_d]2.agegroup = 0
 ( 3)  [_d]4.agegroup = 0
 ( 4)  [_d]5.agegroup = 0
 ( 5)  [_d]6.agegroup = 0

           chi2(  5) =12490.06
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.agegroup = 0
 ( 2)  [_d]2.agegroup = 0
 ( 3)  [_d]4.agegroup = 0
 ( 4)  [_d]5.agegroup = 0
 ( 5)  [_d]6.agegroup = 0

           chi2(  5) =60138.36
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.agegroup = 0
 ( 2)  [_d]2.agegroup = 0
 ( 3)  [_d]4.agegroup = 0
 ( 4)  [_d]5.agegroup = 0
 ( 5)  [_d]6.agegroup = 0

           chi2(  5) =44612.08
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.agegroup = 0
 ( 2)  [_d]2.agegroup = 0
 ( 3)  [_d]4.agegroup = 0
 ( 4)  [_d]5.agegroup = 0
 ( 5)  [_d]6.agegroup = 0

           chi2(  5) =12490.06
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.agegroup = 0
 ( 2)  [_d]2.agegroup = 0
 ( 3)  [_d]4.agegroup = 0
 ( 4)  [_d]5.agegroup = 0
 ( 5)  [_d]6.agegroup = 0

           chi2(  5) =60138.36
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.agegroup = 0
 ( 2)  [_d]2.agegroup = 0
 ( 3)  [_d]4.agegroup = 0
 ( 4)  [_d]5.agegroup = 0
 ( 5)  [_d]6.agegroup = 0

           chi2(  5) =44612.08
         Prob > chi2 =    0.0000

. refline

. outputHRsforvar, variable("agegroup") min(4) max(6) 

 ( 1)  [_d]1.agegroup = 0
 ( 2)  [_d]2.agegroup = 0
 ( 3)  [_d]4.agegroup = 0
 ( 4)  [_d]5.agegroup = 0
 ( 5)  [_d]6.agegroup = 0

           chi2(  5) =12490.06
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.agegroup = 0
 ( 2)  [_d]2.agegroup = 0
 ( 3)  [_d]4.agegroup = 0
 ( 4)  [_d]5.agegroup = 0
 ( 5)  [_d]6.agegroup = 0

           chi2(  5) =60138.36
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.agegroup = 0
 ( 2)  [_d]2.agegroup = 0
 ( 3)  [_d]4.agegroup = 0
 ( 4)  [_d]5.agegroup = 0
 ( 5)  [_d]6.agegroup = 0

           chi2(  5) =44612.08
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.agegroup = 0
 ( 2)  [_d]2.agegroup = 0
 ( 3)  [_d]4.agegroup = 0
 ( 4)  [_d]5.agegroup = 0
 ( 5)  [_d]6.agegroup = 0

           chi2(  5) =12490.06
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.agegroup = 0
 ( 2)  [_d]2.agegroup = 0
 ( 3)  [_d]4.agegroup = 0
 ( 4)  [_d]5.agegroup = 0
 ( 5)  [_d]6.agegroup = 0

           chi2(  5) =60138.36
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.agegroup = 0
 ( 2)  [_d]2.agegroup = 0
 ( 3)  [_d]4.agegroup = 0
 ( 4)  [_d]5.agegroup = 0
 ( 5)  [_d]6.agegroup = 0

           chi2(  5) =44612.08
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.agegroup = 0
 ( 2)  [_d]2.agegroup = 0
 ( 3)  [_d]4.agegroup = 0
 ( 4)  [_d]5.agegroup = 0
 ( 5)  [_d]6.agegroup = 0

           chi2(  5) =12490.06
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.agegroup = 0
 ( 2)  [_d]2.agegroup = 0
 ( 3)  [_d]4.agegroup = 0
 ( 4)  [_d]5.agegroup = 0
 ( 5)  [_d]6.agegroup = 0

           chi2(  5) =60138.36
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.agegroup = 0
 ( 2)  [_d]2.agegroup = 0
 ( 3)  [_d]4.agegroup = 0
 ( 4)  [_d]5.agegroup = 0
 ( 5)  [_d]6.agegroup = 0

           chi2(  5) =44612.08
         Prob > chi2 =    0.0000

. file write tablecontents _n 

. 
. *Sex 
. refline

. outputHRsforvar, variable("male") min(1) max(1) 

 ( 1)  [_d]1.male = 0

           chi2(  1) =  547.40
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.male = 0

           chi2(  1) =   82.61
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.male = 0

           chi2(  1) =  145.14
         Prob > chi2 =    0.0000

. file write tablecontents _n

. 
. *BMI
. refline

. outputHRsforvar, variable("obese4cat") min(2) max(4) 

 ( 1)  [_d]2.obese4cat = 0
 ( 2)  [_d]3.obese4cat = 0
 ( 3)  [_d]4.obese4cat = 0

           chi2(  3) =  234.23
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.obese4cat = 0
 ( 2)  [_d]3.obese4cat = 0
 ( 3)  [_d]4.obese4cat = 0

           chi2(  3) =  845.48
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.obese4cat = 0
 ( 2)  [_d]3.obese4cat = 0
 ( 3)  [_d]4.obese4cat = 0

           chi2(  3) =  498.51
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.obese4cat = 0
 ( 2)  [_d]3.obese4cat = 0
 ( 3)  [_d]4.obese4cat = 0

           chi2(  3) =  234.23
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.obese4cat = 0
 ( 2)  [_d]3.obese4cat = 0
 ( 3)  [_d]4.obese4cat = 0

           chi2(  3) =  845.48
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.obese4cat = 0
 ( 2)  [_d]3.obese4cat = 0
 ( 3)  [_d]4.obese4cat = 0

           chi2(  3) =  498.51
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.obese4cat = 0
 ( 2)  [_d]3.obese4cat = 0
 ( 3)  [_d]4.obese4cat = 0

           chi2(  3) =  234.23
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.obese4cat = 0
 ( 2)  [_d]3.obese4cat = 0
 ( 3)  [_d]4.obese4cat = 0

           chi2(  3) =  845.48
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.obese4cat = 0
 ( 2)  [_d]3.obese4cat = 0
 ( 3)  [_d]4.obese4cat = 0

           chi2(  3) =  498.51
         Prob > chi2 =    0.0000

. file write tablecontents _n

. 
. *Smoking
. refline

. outputHRsforvar, variable("smoke_nomiss") min(2) max(3) 

 ( 1)  [_d]2.smoke_nomiss = 0
 ( 2)  [_d]3.smoke_nomiss = 0

           chi2(  2) =   85.76
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.smoke_nomiss = 0
 ( 2)  [_d]3.smoke_nomiss = 0

           chi2(  2) = 2902.78
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.smoke_nomiss = 0
 ( 2)  [_d]3.smoke_nomiss = 0

           chi2(  2) = 2514.93
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.smoke_nomiss = 0
 ( 2)  [_d]3.smoke_nomiss = 0

           chi2(  2) =   85.76
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.smoke_nomiss = 0
 ( 2)  [_d]3.smoke_nomiss = 0

           chi2(  2) = 2902.78
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.smoke_nomiss = 0
 ( 2)  [_d]3.smoke_nomiss = 0

           chi2(  2) = 2514.93
         Prob > chi2 =    0.0000

. file write tablecontents _n

. 
. *Ethnicity
. refline

. outputHRsforvar, variable("ethnicity") min(2) max(5) 

 ( 1)  [_d]2.ethnicity = 0
 ( 2)  [_d]3.ethnicity = 0
 ( 3)  [_d]4.ethnicity = 0
 ( 4)  [_d]5.ethnicity = 0

           chi2(  4) =  260.57
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.ethnicity = 0
 ( 2)  [_d]3.ethnicity = 0
 ( 3)  [_d]4.ethnicity = 0
 ( 4)  [_d]5.ethnicity = 0

           chi2(  4) =  222.83
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.ethnicity = 0
 ( 2)  [_d]3.ethnicity = 0
 ( 3)  [_d]4.ethnicity = 0
 ( 4)  [_d]5.ethnicity = 0

           chi2(  4) =  222.26
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.ethnicity = 0
 ( 2)  [_d]3.ethnicity = 0
 ( 3)  [_d]4.ethnicity = 0
 ( 4)  [_d]5.ethnicity = 0

           chi2(  4) =  260.57
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.ethnicity = 0
 ( 2)  [_d]3.ethnicity = 0
 ( 3)  [_d]4.ethnicity = 0
 ( 4)  [_d]5.ethnicity = 0

           chi2(  4) =  222.83
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.ethnicity = 0
 ( 2)  [_d]3.ethnicity = 0
 ( 3)  [_d]4.ethnicity = 0
 ( 4)  [_d]5.ethnicity = 0

           chi2(  4) =  222.26
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.ethnicity = 0
 ( 2)  [_d]3.ethnicity = 0
 ( 3)  [_d]4.ethnicity = 0
 ( 4)  [_d]5.ethnicity = 0

           chi2(  4) =  260.57
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.ethnicity = 0
 ( 2)  [_d]3.ethnicity = 0
 ( 3)  [_d]4.ethnicity = 0
 ( 4)  [_d]5.ethnicity = 0

           chi2(  4) =  222.83
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.ethnicity = 0
 ( 2)  [_d]3.ethnicity = 0
 ( 3)  [_d]4.ethnicity = 0
 ( 4)  [_d]5.ethnicity = 0

           chi2(  4) =  222.26
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.ethnicity = 0
 ( 2)  [_d]3.ethnicity = 0
 ( 3)  [_d]4.ethnicity = 0
 ( 4)  [_d]5.ethnicity = 0

           chi2(  4) =  260.57
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.ethnicity = 0
 ( 2)  [_d]3.ethnicity = 0
 ( 3)  [_d]4.ethnicity = 0
 ( 4)  [_d]5.ethnicity = 0

           chi2(  4) =  222.83
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.ethnicity = 0
 ( 2)  [_d]3.ethnicity = 0
 ( 3)  [_d]4.ethnicity = 0
 ( 4)  [_d]5.ethnicity = 0

           chi2(  4) =  222.26
         Prob > chi2 =    0.0000

. file write tablecontents _n

. 
. *IMD
. refline

. outputHRsforvar, variable("imd") min(2) max(5) 

 ( 1)  [_d]2.imd = 0
 ( 2)  [_d]3.imd = 0
 ( 3)  [_d]4.imd = 0
 ( 4)  [_d]5.imd = 0

           chi2(  4) =  795.97
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.imd = 0
 ( 2)  [_d]3.imd = 0
 ( 3)  [_d]4.imd = 0
 ( 4)  [_d]5.imd = 0

           chi2(  4) = 1236.24
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.imd = 0
 ( 2)  [_d]3.imd = 0
 ( 3)  [_d]4.imd = 0
 ( 4)  [_d]5.imd = 0

           chi2(  4) =  847.25
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.imd = 0
 ( 2)  [_d]3.imd = 0
 ( 3)  [_d]4.imd = 0
 ( 4)  [_d]5.imd = 0

           chi2(  4) =  795.97
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.imd = 0
 ( 2)  [_d]3.imd = 0
 ( 3)  [_d]4.imd = 0
 ( 4)  [_d]5.imd = 0

           chi2(  4) = 1236.24
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.imd = 0
 ( 2)  [_d]3.imd = 0
 ( 3)  [_d]4.imd = 0
 ( 4)  [_d]5.imd = 0

           chi2(  4) =  847.25
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.imd = 0
 ( 2)  [_d]3.imd = 0
 ( 3)  [_d]4.imd = 0
 ( 4)  [_d]5.imd = 0

           chi2(  4) =  795.97
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.imd = 0
 ( 2)  [_d]3.imd = 0
 ( 3)  [_d]4.imd = 0
 ( 4)  [_d]5.imd = 0

           chi2(  4) = 1236.24
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.imd = 0
 ( 2)  [_d]3.imd = 0
 ( 3)  [_d]4.imd = 0
 ( 4)  [_d]5.imd = 0

           chi2(  4) =  847.25
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.imd = 0
 ( 2)  [_d]3.imd = 0
 ( 3)  [_d]4.imd = 0
 ( 4)  [_d]5.imd = 0

           chi2(  4) =  795.97
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.imd = 0
 ( 2)  [_d]3.imd = 0
 ( 3)  [_d]4.imd = 0
 ( 4)  [_d]5.imd = 0

           chi2(  4) = 1236.24
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.imd = 0
 ( 2)  [_d]3.imd = 0
 ( 3)  [_d]4.imd = 0
 ( 4)  [_d]5.imd = 0

           chi2(  4) =  847.25
         Prob > chi2 =    0.0000

. file write tablecontents _n 

. 
. *BP/hypertension
. refline

. outputHRsforvar, variable("htdiag_or_highbp") min(1) max(1) 

 ( 1)  [_d]1.htdiag_or_highbp = 0

           chi2(  1) =   30.35
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.htdiag_or_highbp = 0

           chi2(  1) =   23.13
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.htdiag_or_highbp = 0

           chi2(  1) =   69.22
         Prob > chi2 =    0.0000

. file write tablecontents _n

. outputHRsforvar, variable("chronic_respiratory_disease") min(1) max(1) 

 ( 1)  [_d]1.chronic_respiratory_disease = 0

           chi2(  1) =  510.84
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.chronic_respiratory_disease = 0

           chi2(  1) = 3895.87
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.chronic_respiratory_disease = 0

           chi2(  1) = 4330.34
         Prob > chi2 =    0.0000

. file write tablecontents _n                     

. outputHRsforvar, variable("asthmacat") min(2) max(3)                    

 ( 1)  [_d]2.asthmacat = 0
 ( 2)  [_d]3.asthmacat = 0

           chi2(  2) =    6.31
         Prob > chi2 =    0.0427

 ( 1)  [_d]2.asthmacat = 0
 ( 2)  [_d]3.asthmacat = 0

           chi2(  2) =   61.33
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.asthmacat = 0
 ( 2)  [_d]3.asthmacat = 0

           chi2(  2) =  106.18
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.asthmacat = 0
 ( 2)  [_d]3.asthmacat = 0

           chi2(  2) =    6.31
         Prob > chi2 =    0.0427

 ( 1)  [_d]2.asthmacat = 0
 ( 2)  [_d]3.asthmacat = 0

           chi2(  2) =   61.33
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.asthmacat = 0
 ( 2)  [_d]3.asthmacat = 0

           chi2(  2) =  106.18
         Prob > chi2 =    0.0000

. outputHRsforvar, variable("chronic_cardiac_disease") min(1) max(1) 

 ( 1)  [_d]1.chronic_cardiac_disease = 0

           chi2(  1) =   86.74
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.chronic_cardiac_disease = 0

           chi2(  1) = 1768.76
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.chronic_cardiac_disease = 0

           chi2(  1) = 2388.73
         Prob > chi2 =    0.0000

. file write tablecontents _n     

. outputHRsforvar, variable("diabcat") min(2) max(4) 

 ( 1)  [_d]2.diabcat = 0
 ( 2)  [_d]3.diabcat = 0
 ( 3)  [_d]4.diabcat = 0

           chi2(  3) =  830.11
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.diabcat = 0
 ( 2)  [_d]3.diabcat = 0
 ( 3)  [_d]4.diabcat = 0

           chi2(  3) = 1512.51
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.diabcat = 0
 ( 2)  [_d]3.diabcat = 0
 ( 3)  [_d]4.diabcat = 0

           chi2(  3) =19327.18
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.diabcat = 0
 ( 2)  [_d]3.diabcat = 0
 ( 3)  [_d]4.diabcat = 0

           chi2(  3) =  830.11
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.diabcat = 0
 ( 2)  [_d]3.diabcat = 0
 ( 3)  [_d]4.diabcat = 0

           chi2(  3) = 1512.51
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.diabcat = 0
 ( 2)  [_d]3.diabcat = 0
 ( 3)  [_d]4.diabcat = 0

           chi2(  3) =19327.18
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.diabcat = 0
 ( 2)  [_d]3.diabcat = 0
 ( 3)  [_d]4.diabcat = 0

           chi2(  3) =  830.11
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.diabcat = 0
 ( 2)  [_d]3.diabcat = 0
 ( 3)  [_d]4.diabcat = 0

           chi2(  3) = 1512.51
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.diabcat = 0
 ( 2)  [_d]3.diabcat = 0
 ( 3)  [_d]4.diabcat = 0

           chi2(  3) =19327.18
         Prob > chi2 =    0.0000

. file write tablecontents _n             

. outputHRsforvar, variable("cancer_exhaem_cat") min(2) max(4) 

 ( 1)  [_d]2.cancer_exhaem_cat = 0
 ( 2)  [_d]3.cancer_exhaem_cat = 0
 ( 3)  [_d]4.cancer_exhaem_cat = 0

           chi2(  3) =   99.93
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.cancer_exhaem_cat = 0
 ( 2)  [_d]3.cancer_exhaem_cat = 0
 ( 3)  [_d]4.cancer_exhaem_cat = 0

           chi2(  3) =32370.68
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.cancer_exhaem_cat = 0
 ( 2)  [_d]3.cancer_exhaem_cat = 0
 ( 3)  [_d]4.cancer_exhaem_cat = 0

           chi2(  3) =30646.06
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.cancer_exhaem_cat = 0
 ( 2)  [_d]3.cancer_exhaem_cat = 0
 ( 3)  [_d]4.cancer_exhaem_cat = 0

           chi2(  3) =   99.93
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.cancer_exhaem_cat = 0
 ( 2)  [_d]3.cancer_exhaem_cat = 0
 ( 3)  [_d]4.cancer_exhaem_cat = 0

           chi2(  3) =32370.68
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.cancer_exhaem_cat = 0
 ( 2)  [_d]3.cancer_exhaem_cat = 0
 ( 3)  [_d]4.cancer_exhaem_cat = 0

           chi2(  3) =30646.06
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.cancer_exhaem_cat = 0
 ( 2)  [_d]3.cancer_exhaem_cat = 0
 ( 3)  [_d]4.cancer_exhaem_cat = 0

           chi2(  3) =   99.93
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.cancer_exhaem_cat = 0
 ( 2)  [_d]3.cancer_exhaem_cat = 0
 ( 3)  [_d]4.cancer_exhaem_cat = 0

           chi2(  3) =32370.68
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.cancer_exhaem_cat = 0
 ( 2)  [_d]3.cancer_exhaem_cat = 0
 ( 3)  [_d]4.cancer_exhaem_cat = 0

           chi2(  3) =30646.06
         Prob > chi2 =    0.0000

. file write tablecontents _n             

. outputHRsforvar, variable("cancer_haem_cat") min(2) max(4)              

 ( 1)  [_d]2.cancer_haem_cat = 0
 ( 2)  [_d]3.cancer_haem_cat = 0
 ( 3)  [_d]4.cancer_haem_cat = 0

           chi2(  3) =  226.69
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.cancer_haem_cat = 0
 ( 2)  [_d]3.cancer_haem_cat = 0
 ( 3)  [_d]4.cancer_haem_cat = 0

           chi2(  3) = 2099.42
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.cancer_haem_cat = 0
 ( 2)  [_d]3.cancer_haem_cat = 0
 ( 3)  [_d]4.cancer_haem_cat = 0

           chi2(  3) = 1858.71
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.cancer_haem_cat = 0
 ( 2)  [_d]3.cancer_haem_cat = 0
 ( 3)  [_d]4.cancer_haem_cat = 0

           chi2(  3) =  226.69
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.cancer_haem_cat = 0
 ( 2)  [_d]3.cancer_haem_cat = 0
 ( 3)  [_d]4.cancer_haem_cat = 0

           chi2(  3) = 2099.42
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.cancer_haem_cat = 0
 ( 2)  [_d]3.cancer_haem_cat = 0
 ( 3)  [_d]4.cancer_haem_cat = 0

           chi2(  3) = 1858.71
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.cancer_haem_cat = 0
 ( 2)  [_d]3.cancer_haem_cat = 0
 ( 3)  [_d]4.cancer_haem_cat = 0

           chi2(  3) =  226.69
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.cancer_haem_cat = 0
 ( 2)  [_d]3.cancer_haem_cat = 0
 ( 3)  [_d]4.cancer_haem_cat = 0

           chi2(  3) = 2099.42
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.cancer_haem_cat = 0
 ( 2)  [_d]3.cancer_haem_cat = 0
 ( 3)  [_d]4.cancer_haem_cat = 0

           chi2(  3) = 1858.71
         Prob > chi2 =    0.0000

. file write tablecontents _n

. outputHRsforvar, variable("reduced_kidney_function_cat") min(2) max(3)          

 ( 1)  [_d]2.reduced_kidney_function_cat = 0
 ( 2)  [_d]3.reduced_kidney_function_cat = 0

           chi2(  2) =  677.12
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.reduced_kidney_function_cat = 0
 ( 2)  [_d]3.reduced_kidney_function_cat = 0

           chi2(  2) = 3802.39
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.reduced_kidney_function_cat = 0
 ( 2)  [_d]3.reduced_kidney_function_cat = 0

           chi2(  2) = 3653.93
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.reduced_kidney_function_cat = 0
 ( 2)  [_d]3.reduced_kidney_function_cat = 0

           chi2(  2) =  677.12
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.reduced_kidney_function_cat = 0
 ( 2)  [_d]3.reduced_kidney_function_cat = 0

           chi2(  2) = 3802.39
         Prob > chi2 =    0.0000

 ( 1)  [_d]2.reduced_kidney_function_cat = 0
 ( 2)  [_d]3.reduced_kidney_function_cat = 0

           chi2(  2) = 3653.93
         Prob > chi2 =    0.0000

. outputHRsforvar, variable("chronic_liver_disease") min(1) max(1)                        

 ( 1)  [_d]1.chronic_liver_disease = 0

           chi2(  1) =  104.48
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.chronic_liver_disease = 0

           chi2(  1) = 2728.60
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.chronic_liver_disease = 0

           chi2(  1) = 2717.29
         Prob > chi2 =    0.0000

. outputHRsforvar, variable("stroke_dementia") min(1) max(1)      

 ( 1)  [_d]1.stroke_dementia = 0

           chi2(  1) = 1362.24
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.stroke_dementia = 0

           chi2(  1) = 3672.59
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.stroke_dementia = 0

           chi2(  1) = 2778.35
         Prob > chi2 =    0.0000

. outputHRsforvar, variable("other_neuro") min(1) max(1)          

 ( 1)  [_d]1.other_neuro = 0

           chi2(  1) =  877.83
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.other_neuro = 0

           chi2(  1) = 3019.15
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.other_neuro = 0

           chi2(  1) = 2171.57
         Prob > chi2 =    0.0000

. outputHRsforvar, variable("organ_transplant") min(1) max(1)                     

 ( 1)  [_d]1.organ_transplant = 0

           chi2(  1) =  112.16
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.organ_transplant = 0

           chi2(  1) =   97.03
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.organ_transplant = 0

           chi2(  1) =   84.77
         Prob > chi2 =    0.0000

. outputHRsforvar, variable("spleen") min(1) max(1) 

 ( 1)  [_d]1.spleen = 0

           chi2(  1) =    1.20
         Prob > chi2 =    0.2737

 ( 1)  [_d]1.spleen = 0

           chi2(  1) =   68.81
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.spleen = 0

           chi2(  1) =   49.94
         Prob > chi2 =    0.0000

. outputHRsforvar, variable("ra_sle_psoriasis") min(1) max(1) 

 ( 1)  [_d]1.ra_sle_psoriasis = 0

           chi2(  1) =   40.20
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.ra_sle_psoriasis = 0

           chi2(  1) =   62.11
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.ra_sle_psoriasis = 0

           chi2(  1) =   46.49
         Prob > chi2 =    0.0000

. outputHRsforvar, variable("other_immunosuppression") min(1) max(1) 

 ( 1)  [_d]1.other_immunosuppression = 0

           chi2(  1) =   46.37
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.other_immunosuppression = 0

           chi2(  1) =  254.73
         Prob > chi2 =    0.0000

 ( 1)  [_d]1.other_immunosuppression = 0

           chi2(  1) =   31.12
         Prob > chi2 =    0.0000

. 
. 
. file close tablecontents

. 
. postclose HRestimates

. 
. use `HRestimates', clear

. 
. gen varorder = 1 

. local i=2

. foreach var of any male obese4cat smoke_nomiss ethnicity imd  diabcat ///
>         cancer_exhaem_cat cancer_haem_cat reduced_kidney_function_cat asthmacat chronic_respiratory_disease ///
>         chronic_cardiac_disease htdiag_or_highbp chronic_liver_disease ///
>         stroke_dementia other_neuro organ_transplant ///
>         spleen ra_sle_psoriasis other_immunosuppression {
  2. replace varorder = `i' if variable=="`var'"
  3. local i=`i'+1
  4. }
(3 real changes made)
(9 real changes made)
(6 real changes made)
(12 real changes made)
(12 real changes made)
(9 real changes made)
(9 real changes made)
(9 real changes made)
(6 real changes made)
(6 real changes made)
(3 real changes made)
(3 real changes made)
(3 real changes made)
(3 real changes made)
(3 real changes made)
(3 real changes made)
(3 real changes made)
(3 real changes made)
(3 real changes made)
(3 real changes made)

. sort varorder outcome level

. drop varorder

. 
. gen obsorder=_n

. expand 2 if variable!=variable[_n-1] | outcome!=outcome[_n-1], gen(expanded)
(63 observations created)

. for var hr lci uci: replace X = 1 if expanded==1

->  replace hr = 1 if expanded==1
(63 real changes made)

->  replace lci = 1 if expanded==1
(63 real changes made)

->  replace uci = 1 if expanded==1
(63 real changes made)

. 
. sort obsorder

. drop obsorder

. replace level = 0 if expanded == 1
(63 real changes made)

. replace level = 1 if expanded == 1 & (variable=="obese4cat"|variable=="smoke_nomiss"|variable=="ethnicity"|variable=="imd"|variable=="asthmacat"|variable=="diabcat"|substr(variable,1,6)=="cancer"|variab
> le=="reduced_kidney_function_cat"|variable=="agegroup")
(30 real changes made)

. replace level = 3 if expanded == 1 & variable=="agegroup"
(3 real changes made)

. 
. gen varorder = 1 if variable!=variable[_n-1]
(168 missing values generated)

. replace varorder = sum(varorder)
(188 real changes made)

. sort varorder outcome level

. 
. 
. drop expanded

. expand 2 if variable!=variable[_n-1] | outcome!=outcome[_n-1], gen(expanded)
(63 observations created)

. replace level = -1 if expanded==1
(63 real changes made)

. drop expanded

. *expand 3 if variable=="htdiag_or_highbp" & level==-1, gen(expanded)
. *replace level = -99 if variable=="htdiag_or_highbp" & expanded==1
. expand 2 if level == -1, gen(expanded)
(63 observations created)

. replace level = -99 if expanded==1
(63 real changes made)

. 
. for var hr lci uci pval : replace X=. if level<0

->  replace hr=. if level<0
(126 real changes made, 126 to missing)

->  replace lci=. if level<0
(126 real changes made, 126 to missing)

->  replace uci=. if level<0
(126 real changes made, 126 to missing)

->  replace pval=. if level<0
(126 real changes made, 126 to missing)

. sort varorder outcome  level

. 
. gen varx = 0.07

. gen levelx = 0.071

. gen lowerlimit = 0.15

. 
. *Names
. gen Name = variable if (level==-1&!(level[_n+1]==0&variable!="male"))|(level==1&level[_n-1]==0&variable!="male")
(252 missing values generated)

. replace Name = subinstr(Name, "_", " ", 10)
(39 real changes made)

. replace Name = upper(substr(Name,1,1)) + substr(Name,2,.)
(63 real changes made)

. replace Name = "Age group" if Name=="Agegroup"
(3 real changes made)

. replace Name = "Sex" if Name=="Male"
(3 real changes made)

. replace Name = "Obesity" if Name=="Obese4cat"
(3 real changes made)

. replace Name = "Smoking status" if Name=="Smoke nomiss"
(3 real changes made)

. replace Name = "Deprivation (IMD) quintile" if Name=="Imd"
(3 real changes made)

. replace Name = "Hypertension/high bp" if Name=="Htdiag or highbp"
(3 real changes made)

. replace Name = "Asthma" if Name=="Asthmacat"
(3 real changes made)

. replace Name = "Diabetes" if Name=="Diabcat"
(3 real changes made)

. replace Name = "Cancer (non-haematological)" if Name=="Cancer exhaem cat"
(3 real changes made)

. replace Name = "Haematological malignancy" if Name=="Cancer haem cat"
(3 real changes made)

. replace Name = "Stroke or dementia" if Name=="Stroke dementia"
(3 real changes made)

. replace Name = "Other neurological" if Name=="Other neuro"
(3 real changes made)

. replace Name = "Rheumatoid arthritis/Lupus/Psoriasis" if Name=="Ra sle psoriasis"
variable Name was str27 now str36
(3 real changes made)

. replace Name = "Reduced kidney function" if Name=="Reduced kidney function cat"
(3 real changes made)

. replace Name = "Asplenia" if Name=="Spleen"
(3 real changes made)

. 
. *Levels
. gen leveldesc = ""
(315 missing values generated)

. replace leveldesc = "18-39" if variable=="agegroup" & level==1
variable leveldesc was str1 now str5
(3 real changes made)

. replace leveldesc = "40-49" if variable=="agegroup" & level==2
(3 real changes made)

. replace leveldesc = "50-59 (ref)" if variable=="agegroup" & level==3
variable leveldesc was str5 now str11
(3 real changes made)

. replace leveldesc = "60-69" if variable=="agegroup" & level==4
(3 real changes made)

. replace leveldesc = "70-79" if variable=="agegroup" & level==5
(3 real changes made)

. replace leveldesc = "80+" if variable=="agegroup" & level==6
(3 real changes made)

. 
. replace leveldesc = "Female (ref)" if variable=="male" & level==0
variable leveldesc was str11 now str12
(3 real changes made)

. replace leveldesc = "Male" if variable=="male" & level==1
(3 real changes made)

. 
. replace leveldesc = "Not obese (ref)" if variable=="obese4cat" & level==1
variable leveldesc was str12 now str15
(3 real changes made)

. replace leveldesc = "Obese class I" if variable=="obese4cat" & level==2
(3 real changes made)

. replace leveldesc = "Obese class II" if variable=="obese4cat" & level==3
(3 real changes made)

. replace leveldesc = "Obese class III" if variable=="obese4cat" & level==4
(3 real changes made)

. 
. replace leveldesc = "Never (ref)" if variable=="smoke_nomiss" & level==1
(3 real changes made)

. replace leveldesc = "Ex-smoker" if variable=="smoke_nomiss" & level==2
(3 real changes made)

. replace leveldesc = "Current" if variable=="smoke_nomiss" & level==3
(3 real changes made)

. 
. replace leveldesc = "White (ref)" if variable=="ethnicity" & level==1
(3 real changes made)

. replace leveldesc = "Mixed" if variable=="ethnicity" & level==2
(3 real changes made)

. replace leveldesc = "Asian/Asian British" if variable=="ethnicity" & level==3
variable leveldesc was str15 now str19
(3 real changes made)

. replace leveldesc = "Black" if variable=="ethnicity" & level==4
(3 real changes made)

. replace leveldesc = "Other" if variable=="ethnicity" & level==5
(3 real changes made)

. 
. replace leveldesc = "1 (least deprived, ref)" if variable=="imd" & level==1
variable leveldesc was str19 now str23
(3 real changes made)

. replace leveldesc = "2" if variable=="imd" & level==2
(3 real changes made)

. replace leveldesc = "3" if variable=="imd" & level==3
(3 real changes made)

. replace leveldesc = "4" if variable=="imd" & level==4
(3 real changes made)

. replace leveldesc = "5 (most deprived)" if variable=="imd" & level==5
(3 real changes made)

. 
. replace leveldesc = "No diabetes (ref)" if variable=="diabcat" & level==1
(3 real changes made)

. replace leveldesc = "Controlled (HbA1c <58mmol/mol)" if variable=="diabcat" & level==2
variable leveldesc was str23 now str30
(3 real changes made)

. replace leveldesc = "Uncontrolled (HbA1c >=58mmol/mol) " if variable=="diabcat" & level==3
variable leveldesc was str30 now str34
(3 real changes made)

. replace leveldesc = "Unknown HbA1c" if variable=="diabcat" & level==4
(3 real changes made)

. 
. replace leveldesc = "No asthma (ref)" if variable=="asthmacat" & level==1
(3 real changes made)

. replace leveldesc = "With no recent OCS use" if variable=="asthmacat" & level==2
(3 real changes made)

. replace leveldesc = "With recent OCS use" if variable=="asthmacat" & level==3
(3 real changes made)

. 
. replace leveldesc = "Never (ref)" if substr(variable,1,6)=="cancer" & level==1
(6 real changes made)

. replace leveldesc = "<1 year ago" if substr(variable,1,6)=="cancer" & level==2
(6 real changes made)

. replace leveldesc = "1-4.9 years ago" if substr(variable,1,6)=="cancer" & level==3
(6 real changes made)

. replace leveldesc = "5+ years ago" if substr(variable,1,6)=="cancer" & level==4
(6 real changes made)

. 
. replace leveldesc = "None (ref)" if variable=="reduced_kidney_function_cat" & level==1
(3 real changes made)

. replace leveldesc = "eGFR 30-60 ml/min/1.73m2" if variable=="reduced_kidney_function_cat" & level==2
(3 real changes made)

. replace leveldesc = "eGFR <30 ml/min/1.73m2" if variable=="reduced_kidney_function_cat" & level==3
(3 real changes made)

. 
. 
. *replace leveldesc = "Absent" if level==0
. *replace leveldesc = "Present" if level==1 & leveldesc==""
. drop if level==0 & variable!="male"
(30 observations deleted)

. 
. 
. gen obsorder=_n

. gsort -obsorder

. gen graphorder = _n

. sort obsorder

. 
. *merge 1:1 variable level using c:\statatemp\tptemp, update replace
. 
. gen displayhrci = "<<< HR = " + string(hr, "%3.2f") + " (" + string(lci, "%3.2f") + "-" + string(uci, "%3.2f") + ")" if lci<0.15
(283 missing values generated)

. 
. qui summ obsorder if outcome=="NONCOV_2019" & variable=="imd" & level ==5

. local endofdemog = r(mean)

. foreach graphtype of any demogs comorbs{
  2. if "`graphtype'"=="demogs" local if "if _n<=`endofdemog'"
  3. if "`graphtype'"=="comorbs" local if "if _n>`endofdemog'"
  4. scatter graphorder hr if lci>=.15 & outcome=="COV", mcol(red)   msize(small)            ///                                                                             ///
>         || rcap lci uci graphorder if lci>=.15 & outcome=="COV", hor mcol(red)  lcol(red)                       ///
>         || scatter graphorder hr if lci>=.15 & outcome=="NONCOV", mcol(black)   msize(small)            ///                                                                             ///
>         || rcap lci uci graphorder if lci>=.15 & outcome=="NONCOV", hor mcol(black)     lcol(black)                     ///
>                 || scatter graphorder hr if lci>=.15 & outcome=="NONCOV_2019", mcol(blue)       msize(small)            ///                                                                             //
> /
>         || rcap lci uci graphorder if lci>=.15 & outcome=="NONCOV_2019", hor mcol(blue) lcol(black)                     ///
>         || scatter graphorder lowerlimit, m(i) mlab(displayhrci) mlabcol(black) mlabsize(tiny) ///
>         || scatter graphorder varx if outcome=="COV", m(i) mlab(Name) mlabsize(tiny) mlabcol(black)     ///
>         || scatter graphorder levelx if outcome=="COV", m(i) mlab(leveldesc) mlabsize(tiny) mlabcol(gs8)        ///
>                 xline(1,lp(dash))                                                                                                                       ///
>                 xscale(log) xlab(0.25 0.5 1 2 5 10 20) xtitle("Odds Ratio & 95% CI") ylab(none) ytitle("")                                              /// 
>                  ysize(12)   legend(order(1 3 5) label(1 "COVID deaths") label(3 "Non-COVID deaths") label(5 "Deaths 2019"))    ///
>         || `if' , name(`graphtype', replace)
  5. }

. graph combine demogs comorbs, rows(1) ysize(6) iscale(*.7)

. 
. graph export ./output/an_table_covidvsnoncovid_full.svg, as(svg) replace
(file ./output/an_table_covidvsnoncovid_full.svg written in SVG format)

. 
end of do-file

. do "E:\STATATMP\STD8e50_000000.tmp"

. cap log close
