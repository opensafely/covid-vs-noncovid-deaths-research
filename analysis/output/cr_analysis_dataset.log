-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  C:\Github\covid-vs-noncovid-deaths-research\analysis\output/cr_analysis_dataset.log
  log type:  text
 opened on:   4 Sep 2020, 12:38:32

. 
. clear

. import delimited ../output/input.csv
(51 vars, 10,000 obs)

. 
. di "STARTING COUNT FROM IMPORT:"
STARTING COUNT FROM IMPORT:

. cou
  10,000

. 
. rename hiv hiv_code

. 
. ****************************
. *  Create required cohort  *
. ****************************
. 
. * Age: Exclude children
. noi di "DROPPING AGE<18:" 
DROPPING AGE<18:

. drop if age<18
(2,103 observations deleted)

. 
. 
. * Age: Exclude those with implausible ages
. assert age<.

. noi di "DROPPING AGE<105:" 
DROPPING AGE<105:

. drop if age>105
(2 observations deleted)

. 
. * Sex: Exclude categories other than M and F
. assert inlist(sex, "M", "F", "I", "U")

. noi di "DROPPING GENDER NOT M/F:" 
DROPPING GENDER NOT M/F:

. drop if inlist(sex, "I", "U")
(0 observations deleted)

. 
. 
. ******************************
. *  Convert strings to dates  *
. ******************************
. 
. * Covariates
. foreach var of varlist  bp_sys_date                                     ///
>                                                 bp_dias_date                                    ///
>                                                 hba1c_percentage_date                   ///
>                                                 hba1c_mmol_per_mol_date                 ///
>                                                 hypertension                                    ///
>                                                 bmi_date_measured                               ///
>                                                 chronic_respiratory_disease     ///
>                                                 chronic_cardiac_disease                 ///
>                                                 diabetes                                                ///
>                                                 lung_cancer                                     ///
>                                                 haem_cancer                                             ///
>                                                 other_cancer                                    ///
>                                                 chronic_liver_disease                   ///
>                                                 stroke                                                  ///
>                                                 dementia                                                ///
>                                                 other_neuro                                     ///
>                                                 organ_transplant                                ///     
>                                                 dysplenia                                               ///
>                                                 sickle_cell                                     ///
>                                                 aplastic_anaemia                                ///
>                                                 hiv_date                                                ///
>                                                 permanent_immunodeficiency              ///
>                                                 temporary_immunodeficiency              ///
>                                                 ra_sle_psoriasis  dialysis      {
  2.         confirm string variable `var'
  3.         replace `var' = `var' + "-15"
  4.         rename `var' `var'_dstr
  5.         replace `var'_dstr = " " if `var'_dstr == "-15"
  6.         gen `var'_date = date(`var'_dstr, "YMD") 
  7.         order `var'_date, after(`var'_dstr)
  8.         drop `var'_dstr
  9.         format `var'_date %td
 10. }
variable bp_sys_date_measured was str7 now str10
(7,895 real changes made)
(394 real changes made)
(394 missing values generated)
variable bp_dias_date_measured was str7 now str10
(7,895 real changes made)
(399 real changes made)
(399 missing values generated)
variable hba1c_percentage_date was str7 now str10
(7,895 real changes made)
(391 real changes made)
(391 missing values generated)
variable hba1c_mmol_per_mol_date was str7 now str10
(7,895 real changes made)
(396 real changes made)
(396 missing values generated)
variable hypertension was str7 now str10
(7,895 real changes made)
(6,315 real changes made)
(6,315 missing values generated)
variable bmi_date_measured was str7 now str10
(7,895 real changes made)
(399 real changes made)
(399 missing values generated)
variable chronic_respiratory_disease was str7 now str10
(7,895 real changes made)
(6,315 real changes made)
(6,315 missing values generated)
variable chronic_cardiac_disease was str7 now str10
(7,895 real changes made)
(6,283 real changes made)
(6,283 missing values generated)
variable diabetes was str7 now str10
(7,895 real changes made)
(6,312 real changes made)
(6,312 missing values generated)
variable lung_cancer was str7 now str10
(7,895 real changes made)
(6,336 real changes made)
(6,336 missing values generated)
variable haem_cancer was str7 now str10
(7,895 real changes made)
(6,307 real changes made)
(6,307 missing values generated)
variable other_cancer was str7 now str10
(7,895 real changes made)
(6,308 real changes made)
(6,308 missing values generated)
variable chronic_liver_disease was str7 now str10
(7,895 real changes made)
(6,314 real changes made)
(6,314 missing values generated)
variable stroke was str7 now str10
(7,895 real changes made)
(6,287 real changes made)
(6,287 missing values generated)
variable dementia was str7 now str10
(7,895 real changes made)
(6,324 real changes made)
(6,324 missing values generated)
variable other_neuro was str7 now str10
(7,895 real changes made)
(6,301 real changes made)
(6,301 missing values generated)
variable organ_transplant was str7 now str10
(7,895 real changes made)
(6,323 real changes made)
(6,323 missing values generated)
variable dysplenia was str7 now str10
(7,895 real changes made)
(6,293 real changes made)
(6,293 missing values generated)
variable sickle_cell was str7 now str10
(7,895 real changes made)
(6,302 real changes made)
(6,302 missing values generated)
variable aplastic_anaemia was str7 now str10
(7,895 real changes made)
(6,330 real changes made)
(6,330 missing values generated)
variable hiv_date was str7 now str10
(7,895 real changes made)
(6,317 real changes made)
(6,317 missing values generated)
variable permanent_immunodeficiency was str7 now str10
(7,895 real changes made)
(6,340 real changes made)
(6,340 missing values generated)
variable temporary_immunodeficiency was str7 now str10
(7,895 real changes made)
(6,320 real changes made)
(6,320 missing values generated)
variable ra_sle_psoriasis was str7 now str10
(7,895 real changes made)
(6,297 real changes made)
(6,297 missing values generated)
variable dialysis was str7 now str10
(7,895 real changes made)
(6,301 real changes made)
(6,301 missing values generated)

. 
. rename bmi_date_measured_date      bmi_date_measured

. rename bp_dias_date_measured_date  bp_dias_date

. rename bp_sys_date_measured_date   bp_sys_date

. rename hba1c_percentage_date_date  hba1c_percentage_date

. rename hba1c_mmol_per_mol_date_date  hba1c_mmol_per_mol_date

. rename hiv_date_date hiv_date

. 
. * Dates of: CPNS death, ONS-covid death
. foreach var of varlist  died_date_ons died_date_cpns died_date_1ocare {
  2.                 confirm string variable `var'
  3.                 rename `var' _tmp
  4.                 gen `var' = date(_tmp, "YMD")
  5.                 drop _tmp
  6.                 format %d `var'
  7. }
(6,331 missing values generated)
(6,283 missing values generated)
(6,288 missing values generated)

.  
. ********* DEFAULT CENSORING IS MAX OUTCOME DATE MINUS 7 **********
. foreach var of varlist  died_date_ons died_date_cpns {
  2.                 *Set default censoring date as max observed minus 7 days
.                 local globstem = substr("`var'",11,.)
  3.                 summ `var'
  4.                 global `globstem'deathcensor = r(max)-7
  5. }

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
died_dat~ons |      1,564    22062.76    51.54554      21976      22148

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
died_dat~pns |      1,612    12927.73     5472.47       3673      22135

. global onsdeathcensor = $onsdeathcensor-365

. global primarycaredeathcensor = $onsdeathcensor

. 
. ******************INPUT HERE TO OVERRIDE******************
. *Set censoring dates manually here if needed
. *global cpnsdeathcensor                 = d("25/04/2020")
. *global onscoviddeathcensor     = d("06/05/2020")
. *******************************************************************************
. 
. 
. *******************************
. *  Recode implausible values  *
. *******************************
. 
. 
. * BMI 
. 
. * Only keep if within certain time period? using bmi_date_measured ?
. * NB: Some BMI dates in future or after cohort entry
. 
. * Set implausible BMIs to missing:
. replace bmi = . if !inrange(bmi, 15, 50)
(674 real changes made, 674 to missing)

. 
. 
. 
. 
. **********************
. *  Recode variables  *
. **********************
. 
. * Sex
. assert inlist(sex, "M", "F")

. gen male = (sex=="M")

. drop sex

. 
. 
. * Smoking
. label define smoke 1 "Never" 2 "Former" 3 "Current" 

. 
. gen     smoke = 1  if smoking_status=="N"
(7,580 missing values generated)

. replace smoke = 2  if smoking_status=="E"
(151 real changes made)

. replace smoke = 3  if smoking_status=="S"
(972 real changes made)

. replace smoke = . if smoking_status=="M"
(0 real changes made)

. label values smoke smoke

. drop smoking_status

. 
. 
. * Ethnicity (5 category)
. replace ethnicity = . if ethnicity==.
(0 real changes made)

. label define ethnicity  1 "White"                                       ///
>                                                 2 "Mixed"                                       ///
>                                                 3 "Asian or Asian British"      ///
>                                                 4 "Black"                                       ///
>                                                 5 "Other"                                       

.                                                 
. label values ethnicity ethnicity

. 
. 
. * Ethnicity (16 category)
. replace ethnicity_16 = . if ethnicity==.
(1,465 real changes made, 1,465 to missing)

. label define ethnicity_16                                                                       ///
>                                                 1 "British or Mixed British"            ///
>                                                 2 "Irish"                                                       ///
>                                                 3 "Other White"                                         ///
>                                                 4 "White + Black Caribbean"             ///
>                                                 5 "White + Black African"                       ///
>                                                 6 "White + Asian"                                       ///
>                                                 7 "Other mixed"                                         ///
>                                                 8 "Indian or British Indian"            ///
>                                                 9 "Pakistani or British Pakistani"      ///
>                                                 10 "Bangladeshi or British Bangladeshi" ///
>                                                 11 "Other Asian"                                        ///
>                                                 12 "Caribbean"                                          ///
>                                                 13 "African"                                            ///
>                                                 14 "Other Black"                                        ///
>                                                 15 "Chinese"                                            ///
>                                                 16 "Other"                                                      

.                                                 
. label values ethnicity_16 ethnicity_16

. 
. 
. * Ethnicity (16 category grouped further)
. * Generate a version of the full breakdown with mixed in one group
. gen ethnicity_16_combinemixed = ethnicity_16
(3,438 missing values generated)

. recode ethnicity_16_combinemixed 4/7 = 4
(ethnicity_16_combinemixed: 435 changes made)

. label define ethnicity_16_combinemixed  ///
>                                                 1 "British or Mixed British" ///
>                                                 2 "Irish" ///
>                                                 3 "Other White" ///
>                                                 4 "All mixed" ///
>                                                 8 "Indian or British Indian" ///
>                                                 9 "Pakistani or British Pakistani" ///
>                                                 10 "Bangladeshi or British Bangladeshi" ///
>                                                 11 "Other Asian" ///
>                                                 12 "Caribbean" ///
>                                                 13 "African" ///
>                                                 14 "Other Black" ///
>                                                 15 "Chinese" ///
>                                                 16 "Other" 

.                                                 
. label values ethnicity_16_combinemixed ethnicity_16_combinemixed

.                                                 
. 
. * STP 
. rename stp stp_old

. bysort stp_old: gen stp = 1 if _n==1
(7,885 missing values generated)

. replace stp = sum(stp)
(7,894 real changes made)

. drop stp_old

. 
. 
. 
. 
. **************************
. *  Categorise variables  *
. **************************
. 
. 
. /*  Age variables  */ 
. 
. * Create categorised age
. recode age 18/39.9999=1 40/49.9999=2 50/59.9999=3 ///
>         60/69.9999=4 70/79.9999=5 80/max=6, gen(agegroup) 
(7895 differences between age and agegroup)

. 
. label define agegroup   1 "18-<40" ///
>                                                 2 "40-<50" ///
>                                                 3 "50-<60" ///
>                                                 4 "60-<70" ///
>                                                 5 "70-<80" ///
>                                                 6 "80+"

. label values agegroup agegroup

. 
. 
. * Create binary age
. recode age min/69.999=0 70/max=1, gen(age70)
(7895 differences between age and age70)

. 
. * Check there are no missing ages
. assert age<.

. assert agegroup<.

. assert age70<.

. 
. * Create restricted cubic splines fir age
. mkspline age = age, cubic nknots(4)

. 
. 
. 
. /*  Body Mass Index  */
. 
. * BMI (NB: watch for missingness)
. gen     bmicat = .
(7,895 missing values generated)

. recode  bmicat . = 1 if bmi<18.5
(bmicat: 206 changes made)

. recode  bmicat . = 2 if bmi<25
(bmicat: 808 changes made)

. recode  bmicat . = 3 if bmi<30
(bmicat: 1116 changes made)

. recode  bmicat . = 4 if bmi<35
(bmicat: 1450 changes made)

. recode  bmicat . = 5 if bmi<40
(bmicat: 1453 changes made)

. recode  bmicat . = 6 if bmi<.
(bmicat: 1789 changes made)

. replace bmicat = . if bmi>=.
(0 real changes made)

. 
. label define bmicat 1 "Underweight (<18.5)"     ///
>                                         2 "Normal (18.5-24.9)"          ///
>                                         3 "Overweight (25-29.9)"        ///
>                                         4 "Obese I (30-34.9)"           ///
>                                         5 "Obese II (35-39.9)"          ///
>                                         6 "Obese III (40+)"                     

.                                         
. label values bmicat bmicat

. 
. * Create more granular categorisation
. recode bmicat 1/3 . = 1 4=2 5=3 6=4, gen(obese4cat)
(7689 differences between bmicat and obese4cat)

. 
. label define obese4cat  1 "No record of obesity"        ///
>                                                 2 "Obese I (30-34.9)"           ///
>                                                 3 "Obese II (35-39.9)"          ///
>                                                 4 "Obese III (40+)"             

. label values obese4cat obese4cat

. order obese4cat, after(bmicat)

. 
. 
. 
. /*  Smoking  */
. 
. 
. * Create non-missing 3-category variable for current smoking
. recode smoke .=1, gen(smoke_nomiss)
(6457 differences between smoke and smoke_nomiss)

. order smoke_nomiss, after(smoke)

. label values smoke_nomiss smoke

. 
. 
. 
. /*  Asthma  */
. 
. 
. * Asthma  (coded: 0 No, 1 Yes no OCS, 2 Yes with OCS)
. rename asthma asthmacat

. recode asthmacat 0=1 1=2 2=3 .=1
(asthmacat: 7895 changes made)

. label define asthmacat 1 "No" 2 "Yes, no OCS" 3 "Yes with OCS"

. label values asthmacat asthmacat

. 
. gen asthma = (asthmacat==2|asthmacat==3)

. 
. 
. 
. 
. 
. /*  Blood pressure   */
. 
. * Categorise
. gen     bpcat = 1 if bp_sys < 120 &  bp_dias < 80
(7,893 missing values generated)

. replace bpcat = 2 if inrange(bp_sys, 120, 130) & bp_dias<80
(0 real changes made)

. replace bpcat = 3 if inrange(bp_sys, 130, 140) | inrange(bp_dias, 80, 90)
(9 real changes made)

. replace bpcat = 4 if (bp_sys>=140 & bp_sys<.) | (bp_dias>=90 & bp_dias<.) 
(7,485 real changes made)

. replace bpcat = . if bp_sys>=. | bp_dias>=. | bp_sys==0 | bp_dias==0
(379 real changes made, 379 to missing)

. 
. label define bpcat 1 "Normal" 2 "Elevated" 3 "High, stage I"    ///
>                                         4 "High, stage II" 

. label values bpcat bpcat

. 
. recode bpcat .=1, gen(bpcat_nomiss)
(778 differences between bpcat and bpcat_nomiss)

. label values bpcat_nomiss bpcat

. 
. * Create non-missing indicator of known high blood pressure
. gen bphigh = (bpcat==4)

. order bpcat bphigh, after(bp_dias_date)

. 
. 
. 
. 
. /*  IMD  */
. 
. * Group into 5 groups
. rename imd imd_o

. egen imd = cut(imd_o), group(5) icodes

. replace imd = imd + 1
(7,895 real changes made)

. replace imd = . if imd_o==-1
(0 real changes made)

. drop imd_o

. 
. * Reverse the order (so high is more deprived)
. recode imd 5=1 4=2 3=3 2=4 1=5 .=.
(imd: 7895 changes made)

. 
. label define imd 1 "1 least deprived" 2 "2" 3 "3" 4 "4" 5 "5 most deprived" 

. label values imd imd 

. 
. noi di "DROPPING IF NO IMD" 
DROPPING IF NO IMD

. drop if imd>=.
(0 observations deleted)

. 
. 
. 
. 
. 
. /*  Centred age, sex, IMD, ethnicity (for adjusted KM plots)  */ 
. 
. * Centre age (linear)
. summ age

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
         age |      7,895    48.63344    18.74181         18        105

. gen c_age = age-r(mean)

. 
. * "Centre" sex to be coded -1 +1 
. recode male 0=-1, gen(c_male)
(3962 differences between male and c_male)

. 
. * "Centre" IMD
. gen c_imd = imd - 3

. 
. * "Centre" ethnicity
. gen c_ethnicity = ethnicity - 3
(1,983 missing values generated)

. 
. 
. 
. 
. **************************************************
. *  Create binary comorbidity indices from dates  *
. **************************************************
. 
. * Comorbidities ever before
. foreach var of varlist  chronic_respiratory_disease_date        ///
>                                                 chronic_cardiac_disease_date            ///
>                                                 diabetes                                                        ///
>                                                 chronic_liver_disease_date                      ///
>                                                 stroke_date                                                     ///
>                                                 dementia_date                                           ///
>                                                 other_neuro_date                                        ///
>                                                 organ_transplant_date                           ///
>                                                 aplastic_anaemia_date                           ///
>                                                 hypertension                                            ///
>                                                 dysplenia_date                                          ///
>                                                 sickle_cell_date                                        ///
>                                                 hiv_date                                                        ///
>                                                 permanent_immunodeficiency_date         ///
>                                                 temporary_immunodeficiency_date         ///
>                                                 ra_sle_psoriasis_date dialysis_date {
  2.         local newvar =  substr("`var'", 1, length("`var'") - 5)
  3.         gen `newvar' = (`var'< d(1/2/2020))
  4.         order `newvar', after(`var')
  5. }

. 
. 
. 
. 
. 
. 
. ***************************
. *  Grouped comorbidities  *
. ***************************
. 
. 
. /*  Neurological  */
. 
. * Stroke and dementia
. egen stroke_dementia = rowmax(stroke dementia)

. order stroke_dementia, after(dementia_date)

. 
. 
. /*  Spleen  */
. 
. * Spleen problems (dysplenia/splenectomy/etc and sickle cell disease)   
. egen spleen = rowmax(dysplenia sickle_cell) 

. order spleen, after(sickle_cell)

. 
. 
. 
. /*  Cancer  */
. 
. label define cancer 1 "Never" 2 "Last year" 3 "2-5 years ago" 4 "5+ years"

. 
. * Haematological malignancies
. gen     cancer_haem_cat = 4 if inrange(haem_cancer_date, d(1/1/1900), d(1/2/2015))
(6,487 missing values generated)

. replace cancer_haem_cat = 3 if inrange(haem_cancer_date, d(1/2/2015), d(1/2/2019))
(131 real changes made)

. replace cancer_haem_cat = 2 if inrange(haem_cancer_date, d(1/2/2019), d(1/2/2020))
(27 real changes made)

. recode  cancer_haem_cat . = 1
(cancer_haem_cat: 6329 changes made)

. label values cancer_haem_cat cancer

. 
. 
. * All other cancers
. gen     cancer_exhaem_cat = 4 if inrange(lung_cancer_date,  d(1/1/1900), d(1/2/2015)) | ///
>                                                                  inrange(other_cancer_date, d(1/1/1900), d(1/2/2015)) 
(5,351 missing values generated)

. replace cancer_exhaem_cat = 3 if inrange(lung_cancer_date,  d(1/2/2015), d(1/2/2019)) | ///
>                                                                  inrange(other_cancer_date, d(1/2/2015), d(1/2/2019)) 
(261 real changes made)

. replace cancer_exhaem_cat = 2 if inrange(lung_cancer_date,  d(1/2/2019), d(1/2/2020)) | ///
>                                                                  inrange(other_cancer_date, d(1/2/2019), d(1/2/2020))
(58 real changes made)

. recode  cancer_exhaem_cat . = 1
(cancer_exhaem_cat: 5081 changes made)

. label values cancer_exhaem_cat cancer

. 
. 
. * Put variables together
. order cancer_exhaem_cat cancer_haem_cat, after(other_cancer_date)

. 
. 
. 
. /*  Immunosuppression  */
. 
. * Immunosuppressed:
. * HIV, permanent immunodeficiency ever, OR 
. * temporary immunodeficiency or aplastic anaemia last year
. gen temp1  = max(hiv, permanent_immunodeficiency)

. gen temp2  = inrange(temporary_immunodeficiency_date, d(1/2/2019), d(1/2/2020))

. gen temp3  = inrange(aplastic_anaemia_date, d(1/2/2019), d(1/2/2020))

. 
. egen other_immunosuppression = rowmax(temp1 temp2 temp3)

. drop temp1 temp2 temp3

. order other_immunosuppression, after(temporary_immunodeficiency)

. 
. 
. 
. 
. /*  Hypertension  */
. 
. gen htdiag_or_highbp = bphigh

. recode htdiag_or_highbp 0 = 1 if hypertension==1 
(htdiag_or_highbp: 179 changes made)

. 
. 
. 
. 
. ************
. *   eGFR   *
. ************
. 
. * Set implausible creatinine values to missing (Note: zero changed to missing)
. replace creatinine = . if !inrange(creatinine, 20, 3000) 
(28 real changes made, 28 to missing)

.         
. * Divide by 88.4 (to convert umol/l to mg/dl)
. gen SCr_adj = creatinine/88.4
(417 missing values generated)

. 
. gen min=.
(7,895 missing values generated)

. replace min = SCr_adj/0.7 if male==0
(3,765 real changes made)

. replace min = SCr_adj/0.9 if male==1
(3,713 real changes made)

. replace min = min^-0.329  if male==0
(3,765 real changes made)

. replace min = min^-0.411  if male==1
(3,713 real changes made)

. replace min = 1 if min<1
(2,041 real changes made)

. 
. gen max=.
(7,895 missing values generated)

. replace max=SCr_adj/0.7 if male==0
(3,765 real changes made)

. replace max=SCr_adj/0.9 if male==1
(3,713 real changes made)

. replace max=max^-1.209
(7,478 real changes made)

. replace max=1 if max>1
(5,854 real changes made)

. 
. gen egfr=min*max*141
(417 missing values generated)

. replace egfr=egfr*(0.993^age)
(7,478 real changes made)

. replace egfr=egfr*1.018 if male==0
(3,765 real changes made)

. label var egfr "egfr calculated using CKD-EPI formula with no eth"

. 
. * Categorise into ckd stages
. egen egfr_cat = cut(egfr), at(0, 15, 30, 45, 60, 5000)
(417 missing values generated)

. recode egfr_cat 0=5 15=4 30=3 45=2 60=0, generate(ckd)
(7478 differences between egfr_cat and ckd)

. * 0 = "No CKD"  2 "stage 3a" 3 "stage 3b" 4 "stage 4" 5 "stage 5"
. label define ckd 0 "No CKD" 1 "CKD"

. label values ckd ckd

. label var ckd "CKD stage calc without eth"

. 
. * Convert into CKD group
. *recode ckd 2/5=1, gen(chronic_kidney_disease)
. *replace chronic_kidney_disease = 0 if creatinine==. 
.         
. recode ckd 0=1 2/3=2 4/5=3, gen(reduced_kidney_function_cat)
(7390 differences between ckd and reduced_kidney_function_cat)

. replace reduced_kidney_function_cat = 1 if creatinine==. 
(417 real changes made)

. label define reduced_kidney_function_catlab ///
>         1 "None" 2 "Stage 3a/3b egfr 30-60      " 3 "Stage 4/5 egfr<30"

. label values reduced_kidney_function_cat reduced_kidney_function_catlab 

.  
.         
. ************
. *   Hba1c  *
. ************
.         
. 
. /*  Diabetes severity  */
. 
. * Set zero or negative to missing
. replace hba1c_percentage   = . if hba1c_percentage<=0
(54 real changes made, 54 to missing)

. replace hba1c_mmol_per_mol = . if hba1c_mmol_per_mol<=0
(152 real changes made, 152 to missing)

. 
. 
. * Only consider measurements in last 15 months
. replace hba1c_percentage   = . if hba1c_percentage_date   < d(1/11/2018)
(7,230 real changes made, 7,230 to missing)

. replace hba1c_mmol_per_mol = . if hba1c_mmol_per_mol_date < d(1/11/2018)
(7,141 real changes made, 7,141 to missing)

. 
. 
. 
. /* Express  HbA1c as percentage  */ 
. 
. * Express all values as perecentage 
. noi summ hba1c_percentage hba1c_mmol_per_mol 

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
hba1c_per~ge |        220     5.00923    2.035608   .2754653    11.2832
hba1c_mmol~l |        206    40.41459    19.30466   .2860002    88.8083

. gen     hba1c_pct = hba1c_percentage 
(7,675 missing values generated)

. replace hba1c_pct = (hba1c_mmol_per_mol/10.929)+2.15 if hba1c_mmol_per_mol<. 
(206 real changes made)

. 
. * Valid % range between 0-20  
. replace hba1c_pct = . if !inrange(hba1c_pct, 0, 20) 
(0 real changes made)

. replace hba1c_pct = round(hba1c_pct, 0.1)
(421 real changes made)

. 
. 
. /* Categorise hba1c and diabetes  */
. 
. * Group hba1c
. gen     hba1ccat = 0 if hba1c_pct <  6.5
(7,606 missing values generated)

. replace hba1ccat = 1 if hba1c_pct >= 6.5  & hba1c_pct < 7.5
(70 real changes made)

. replace hba1ccat = 2 if hba1c_pct >= 7.5  & hba1c_pct < 8
(17 real changes made)

. replace hba1ccat = 3 if hba1c_pct >= 8    & hba1c_pct < 9
(32 real changes made)

. replace hba1ccat = 4 if hba1c_pct >= 9    & hba1c_pct !=.
(13 real changes made)

. label define hba1ccat 0 "<6.5%" 1">=6.5-7.4" 2">=7.5-7.9" 3">=8-8.9" 4">=9"

. label values hba1ccat hba1ccat

. tab hba1ccat

   hba1ccat |      Freq.     Percent        Cum.
------------+-----------------------------------
      <6.5% |        289       68.65       68.65
  >=6.5-7.4 |         70       16.63       85.27
  >=7.5-7.9 |         17        4.04       89.31
    >=8-8.9 |         32        7.60       96.91
        >=9 |         13        3.09      100.00
------------+-----------------------------------
      Total |        421      100.00

. 
. * Create diabetes, split by control/not
. gen     diabcat = 1 if diabetes==0
(1,561 missing values generated)

. replace diabcat = 2 if diabetes==1 & inlist(hba1ccat, 0, 1)
(69 real changes made)

. replace diabcat = 3 if diabetes==1 & inlist(hba1ccat, 2, 3, 4)
(13 real changes made)

. replace diabcat = 4 if diabetes==1 & !inlist(hba1ccat, 0, 1, 2, 3, 4)
(1,479 real changes made)

. 
. label define diabcat    1 "No diabetes"                         ///
>                                                 2 "Controlled diabetes"         ///
>                                                 3 "Uncontrolled diabetes"       ///
>                                                 4 "Diabetes, no hba1c measure"

. label values diabcat diabcat

. 
. * Delete unneeded variables
. drop hba1c_pct hba1c_percentage hba1c_mmol_per_mol

. 
. 
. ********************************
. *  Outcomes and survival time  *
. ********************************
. 
. 
. /*  Cohort entry and censor dates  */
. 
. * Date of cohort entry, 1 Feb 2019
. gen enter_date = date("01/02/2019", "DMY")

. format %d enter_date

. 
. /*   Outcomes   */
. * Date of Covid death in ONS
. gen died_date_onscovid = died_date_ons if died_ons_covid_flag_any==1
(7,592 missing values generated)

. 
. * Binary indicators for outcomes
. gen cpnsdeath           = (died_date_cpns               < .)

. gen onsdeath            = 2*(died_date_ons < .)

. replace onsdeath        = 1 if died_ons_covid_flag_any==1
(1,580 real changes made)

. label define onsdeathlab 1 covid 2 noncovid

. label values onsdeath onsdeathlab 

. 
. gen primarycaredeath = (died_date_1ocare < .)

. 
. /*  Create survival times  */
. * For looping later, name must be stime_binary_outcome_name
. 
. * Survival time = last followup date (first: end study, death, or that outcome)
. gen stime_cpnsdeath     = min($cpnsdeathcensor, died_date_cpns, died_date_ons)

. gen stime_onsdeath              = min($onsdeathcensor, died_date_ons)

. gen stime_primarycaredeath              = min($primarycaredeathcensor, died_date_1ocare)

. 
. * If outcome was after censoring occurred, set to zero
. replace cpnsdeath               = 0 if (died_date_cpns > $cpnsdeathcensor) 
(1 real change made)

. *replace onscoviddeath  = 0 if (died_date_onscovid      > $onsdeathcensor) 
. replace onsdeath                = 0 if (died_date_ons > $onsdeathcensor) 
(2,841 real changes made)

. replace primarycaredeath = 0 if (died_date_1ocare > $primarycaredeathcensor)
(1,607 real changes made)

. 
. * Format date variables
. format stime* %td 

. format  stime*                          ///
>                 died_date_onscovid      ///
>                 died_date_ons           ///
>                 died_date_cpns %td 

. 
. *********************
. *  Label variables  *
. *********************
. 
. * Demographics
. label var patient_id                                    "Patient ID"

. label var age                                                   "Age (years)"

. label var agegroup                                              "Grouped age"

. label var age70                                                 "70 years and older"

. label var male                                                  "Male"

. label var bmi                                                   "Body Mass Index (BMI, kg/m2)"

. label var bmicat                                                "Grouped BMI"

. label var bmi_date                                      "Body Mass Index (BMI, kg/m2), date measured"

. label var obese4cat                                             "Evidence of obesity (4 categories)"

. label var smoke                                                 "Smoking status"

. label var smoke_nomiss                                  "Smoking status (missing set to non)"

. label var imd                                                   "Index of Multiple Deprivation (IMD)"

. label var ethnicity                                             "Ethnicity"

. label var ethnicity_16                                  "Ethnicity in 16 categories"

. label var ethnicity_16_combinemixed             "Ethnicity detailed with mixed groups combined"

. label var stp                                                   "Sustainability and Transformation Partnership"

. label var region                                                "Geographical region"

. 
. label var hba1ccat                                              "Categorised hba1c"

. label var egfr_cat                                              "Calculated eGFR"

.         
. label var bp_sys                                                "Systolic blood pressure"

. label var bp_sys_date                                   "Systolic blood pressure, date"

. label var bp_dias                                               "Diastolic blood pressure"

. label var bp_dias_date                                  "Diastolic blood pressure, date"

. label var bpcat                                                 "Grouped blood pressure"

. label var bphigh                                                "Binary high (stage 1/2) blood pressure"

. label var htdiag_or_highbp                              "Diagnosed hypertension or high blood pressure"

. 
. label var age1                                                  "Age spline 1"

. label var age2                                                  "Age spline 2"

. label var age3                                                  "Age spline 3"

. label var c_age                                                 "Centred age"

. label var c_male                                                "Centred sex (code: -1/+1)"

. label var c_imd                                                 "Centred Index of Multiple Deprivation (values: -2/+2)"

. label var c_ethnicity                                   "Centred ethnicity (values: -2/+2)"

. 
. * Comorbidities
. label var chronic_respiratory_disease   "Respiratory disease (excl. asthma)"

. label var asthmacat                                             "Asthma, grouped by severity (OCS use)"

. label var asthma                                                "Asthma"

. label var chronic_cardiac_disease               "Heart disease"

. label var diabetes                                              "Diabetes"

. label var diabcat                                               "Diabetes, grouped"

. label var cancer_exhaem_cat                             "Cancer (exc. haematological), grouped by time since diagnosis"

. label var cancer_haem_cat                               "Haematological malignancy, grouped by time since diagnosis"

. label var chronic_liver_disease                 "Chronic liver disease"

. label var stroke_dementia                               "Stroke or dementia"

. label var other_neuro                                   "Neuro condition other than stroke/dementia"    

. label var reduced_kidney_function_cat   "Reduced kidney function" 

. label var organ_transplant                              "Organ transplant recipient"

. label var dysplenia                                             "Dysplenia (splenectomy, other, not sickle cell)"

. label var sickle_cell                                   "Sickle cell"

. label var spleen                                                "Spleen problems (dysplenia, sickle cell)"

. label var ra_sle_psoriasis                              "RA, SLE, Psoriasis (autoimmune disease)"

. label var aplastic_anaemia                              "Aplastic anaemia"

. label var hiv                                                   "HIV"

. label var permanent_immunodeficiency    "Permanent immunodeficiency"

. label var temporary_immunodeficiency    "Temporary immunosuppression"

. label var other_immunosuppression               "Immunosuppressed (combination algorithm)"

. label var chronic_respiratory_disease_date      "Respiratory disease (excl. asthma), date"

. label var chronic_cardiac_disease_date  "Heart disease, date"

. label var diabetes_date                                 "Diabetes, date"

. label var lung_cancer_date                              "Lung cancer, date"

. label var haem_cancer_date                              "Haem. cancer, date"

. label var other_cancer_date                             "Any cancer, date"

. label var chronic_liver_disease_date    "Liver, date"

. label var stroke_date                                   "Stroke, date"

. label var dementia_date                                 "Dementia, date"

. label var other_neuro_date                              "Neuro condition other than stroke/dementia, date"      

. label var organ_transplant_date                 "Organ transplant recipient, date"

. label var dysplenia_date                                "Splenectomy etc, date"

. label var sickle_cell_date                              "Sickle cell, date"

. label var ra_sle_psoriasis_date                 "RA, SLE, Psoriasis (autoimmune disease), date"

. label var aplastic_anaemia_date                 "Aplastic anaemia, date"

. label var hiv_date                                              "HIV, date"

. label var permanent_immunodeficiency_date "Permanent immunodeficiency, date"

. label var temporary_immunodeficiency_date "Temporary immunosuppression, date"

. label var dialysis                                              "Dialysis"

.         
. * Outcomes and follow-up
. label var enter_date                                    "Date of study entry"

. 
. label var cpnsdeath                                             "Failure/censoring indicator for outcome: CPNS covid death"

. label var onsdeath                                              "Failure/censoring indicator for outcome: ONS death (1 = covid death 2 = other death)"
note: label truncated to 80 characters

. 
. * Survival times
. label var  stime_cpnsdeath                              "Survival time (date); outcome CPNS covid death"

. label var  stime_onsdeath                               "Survival time (date); outcome ONS covid death"

. 
. 
. 
. 
. ***************
. *  Tidy data  *
. ***************
. 
. * REDUCE DATASET SIZE TO VARIABLES NEEDED
. keep patient_id imd stp region enter_date                                                                       ///
>         cpnsdeath died_date_cpns  stime_cpnsdeath                                                               ///
>         onsdeath died_date_ons died_date_onscovid                                                               ///
>         stime_onsdeath                                                                                                                  ///
>         primarycaredeath died_date_1ocare stime_primarycaredeath                                ///
>         age agegroup age70 age1 age2 age3 male bmi smoke                                                ///
>         smoke smoke_nomiss bmicat bpcat_nomiss obese4cat ethnicity ethnicity_16 ///
>         ethnicity_16_combinemixed bpcat bphigh htdiag_or_highbp hypertension    ///
>         chronic_respiratory_disease asthma asthmacat chronic_cardiac_disease    ///
>         diabetes diabcat hba1ccat cancer_exhaem_cat cancer_haem_cat                     ///
>         chronic_liver_disease organ_transplant spleen ra_sle_psoriasis                  ///
>         reduced_kidney_function_cat stroke dementia stroke_dementia                     ///
>         other_neuro other_immunosuppression  hiv*                                                               ///
>         creatinine egfr egfr_cat ckd dialysis 

. 
. 
. ***************
. *  Save data  *
. ***************
. 
. sort patient_id

. label data "covid vs non covid 2019"

. save "cr_create_analysis_dataset_2019.dta", replace
file cr_create_analysis_dataset_2019.dta saved

. 
. log close
      name:  <unnamed>
       log:  C:\Github\covid-vs-noncovid-deaths-research\analysis\output/cr_analysis_dataset.log
  log type:  text
 closed on:   4 Sep 2020, 12:38:33
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
